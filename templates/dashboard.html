<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Backup Dashboard</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Light Theme */
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --bg-navbar: #212529;
            --text-primary: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
        }

        /* Dark Theme - Premium Blue */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-navbar: #0f172a;
            --text-primary: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body {
            background: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .navbar {
            background: var(--bg-navbar) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .table {
            color: var(--text-primary);
        }

        [data-theme="dark"] .table {
            --bs-table-bg: var(--bg-card);
            --bs-table-striped-bg: #283548;
        }

        [data-theme="dark"] .table-dark {
            --bs-table-bg: #334155;
        }

        [data-theme="dark"] .modal-content {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-check-label {
            background: #334155;
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .log-panel {
            font-family: 'Consolas', monospace;
            font-size: 10px;
            background: #0d1117;
            color: #58a6ff;
            min-height: 60px;
            max-height: 100px;
            overflow-y: auto;
            border-radius: 6px;
        }

        .log-success {
            color: #3fb950;
        }

        .log-error {
            color: #f85149;
        }

        .log-info {
            color: #58a6ff;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.3rem;
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
        }

        .stat-box {
            text-align: center;
            padding: 0.5rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .group-collapse {
            cursor: pointer;
        }

        .device-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .chart-container {
            height: 120px;
            position: relative;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üõ°Ô∏è Backup System</a>
            <ul class="navbar-nav flex-row gap-3">
                <li class="nav-item"><a class="nav-link active" href="/">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/inventory">Inventario</a></li>
                <li class="nav-item"><a class="nav-link" href="/files">Archivos</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/vault">üîê Vault</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/settings">‚öôÔ∏è Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/users">üë• Usuarios</a></li>
                <li class="nav-item"><span class="nav-link theme-toggle" onclick="toggleTheme()"
                        title="Cambiar tema">üåì</span></li>
                {% if session.username %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        üë§ {{ session.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><span class="dropdown-item-text text-muted">Rol: {{ session.role }}</span></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="/logout">üö™ Cerrar Sesi√≥n</a></li>
                    </ul>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Control Panel -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
                <span>üöÄ Control de Backup</span>
                <div>
                    <button class="btn btn-danger btn-sm me-2" id="btn-cancel" onclick="cancelBackup()"
                        style="display:none;">‚èπÔ∏è Cancelar</button>
                    <button class="btn btn-light btn-sm" id="btn-backup" data-bs-toggle="modal"
                        data-bs-target="#backupModal">‚ñ∂Ô∏è Ejecutar Backup</button>
                </div>
            </div>
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <small id="backup-status" class="text-muted">Listo para ejecutar</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar"
                                style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div id="log-panel" class="log-panel p-2" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Panel (Unified: Disco + 24h + Torta) -->
        <div class="card mb-3">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <!-- Disk -->
                    <div class="col-md-3 border-end">
                        <div class="d-flex align-items-center">
                            <span class="me-2" style="font-size: 2rem;">üíæ</span>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Disco</small>
                                    <small class="text-muted">{{ disk.free_gb }} GB libres</small>
                                </div>
                                <div class="progress" style="height: 18px;">
                                    <div class="progress-bar"
                                        style="width: {{ disk.percent }}%; background: linear-gradient(90deg, #198754, {{ '#ffc107' if disk.percent > 60 else '#198754' }}, {{ '#dc3545' if disk.percent > 85 else '#ffc107' if disk.percent > 60 else '#198754' }});">
                                        {{ disk.percent }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 24h Stats -->
                    <div class="col-md-5 border-end">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-number text-success">{{ stats.get('SUCCESS', 0) }}</div>
                                <small class="text-muted">‚úì Exitosos (24h)</small>
                            </div>
                            <div class="col-6">
                                <div class="stat-number text-danger">{{ stats.get('ERROR', 0) }}</div>
                                <small class="text-muted">‚úó Fallidos (24h)</small>
                            </div>
                        </div>
                    </div>
                    <!-- General Pie -->
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div class="chart-container flex-grow-1">
                                <canvas id="chartPie"></canvas>
                            </div>
                            <div class="ms-3">
                                <small class="text-muted d-block">General</small>
                                <small class="text-success">‚óè OK</small><br>
                                <small class="text-danger">‚óè Error</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Per-Group Charts -->
        <div class="card mb-3" id="group-charts-card" style="display: none;">
            <div class="card-header py-2"><small class="text-muted">üìä Estad√≠sticas por Grupo (24h)</small></div>
            <div class="card-body py-2">
                <div class="row" id="group-charts-row"></div>
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span>üìã √öltimas Ejecuciones</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadJobs(1)">üîÑ</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Hora</th>
                            <th>Host</th>
                            <th>Grupo</th>
                            <th>Status</th>
                            <th>Mensaje</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table"></tbody>
                </table>
            </div>
            <div class="card-footer py-1 d-flex justify-content-between">
                <small id="jobs-info" class="text-muted">Cargando...</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h6 class="modal-title">üéØ Seleccionar Equipos</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <input type="text" class="form-control form-control-sm mb-2" id="device-search"
                        placeholder="üîç Buscar..." onkeyup="filterDevices()">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="select-all" onchange="toggleAll(this)">
                        <label class="form-check-label fw-bold" for="select-all">üåê Todos</label>
                    </div>
                    <hr class="my-2">
                    {% for group in inventory.groups %}
                    <div class="mb-2">
                        <div class="d-flex align-items-center group-collapse" data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ loop.index }}">
                            <input class="form-check-input me-2 group-check" type="checkbox"
                                data-group="{{ group.name }}"
                                onclick="event.stopPropagation(); toggleGroup('{{ group.name }}')">
                            <span class="fw-bold">üìÅ {{ group.name }}</span>
                            <span class="badge bg-info ms-2">{{ group.vendor }}</span>
                            <span class="badge bg-secondary ms-1">{{ group.devices|length }}</span>
                            <span class="ms-auto">‚ñº</span>
                        </div>
                        <div class="collapse device-list ms-4" id="collapse-{{ loop.index }}">
                            {% for device in group.devices %}
                            <div class="form-check device-item" data-name="{{ device.hostname|lower }}">
                                <input class="form-check-input device-check" type="checkbox"
                                    data-group="{{ group.name }}" value="{{ device.hostname }}">
                                <label class="form-check-label"><small>{{ device.hostname }} ({{ device.ip
                                        }})</small></label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer py-2">
                    <span class="me-auto text-muted">Seleccionados: <strong id="selected-count">0</strong></span>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success btn-sm" onclick="runSelectedBackup()" id="btn-run"
                        disabled>‚ñ∂Ô∏è Ejecutar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme
        function toggleTheme() {
            var t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }
        (function () { document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); })();

        const backupModal = new bootstrap.Modal(document.getElementById('backupModal'));
        let isBackupRunning = false;

        function toggleAll(cb) { document.querySelectorAll('.device-check, .group-check').forEach(function (el) { el.checked = cb.checked; }); updateCount(); }
        function toggleGroup(name) { var cb = document.querySelector('.group-check[data-group="' + name + '"]'); document.querySelectorAll('.device-check[data-group="' + name + '"]').forEach(function (el) { el.checked = cb.checked; }); updateCount(); }
        function updateCount() { var n = document.querySelectorAll('.device-check:checked').length; document.getElementById('selected-count').textContent = n; document.getElementById('btn-run').disabled = n === 0; }
        function filterDevices() { var q = document.getElementById('device-search').value.toLowerCase(); document.querySelectorAll('.device-item').forEach(function (el) { el.style.display = el.dataset.name.includes(q) ? '' : 'none'; }); }
        document.querySelectorAll('.device-check').forEach(function (el) { el.addEventListener('change', updateCount); });

        function runSelectedBackup() {
            var selected = Array.from(document.querySelectorAll('.device-check:checked')).map(function (el) { return el.value; });
            if (selected.length === 0) return alert('Seleccione equipos');
            if (!confirm('¬øBackup de ' + selected.length + ' equipo(s)?')) return;
            backupModal.hide();
            startBackup(selected);
        }

        function startBackup(devices) {
            isBackupRunning = true;
            lastLogCount = 0;  // Reset log counter
            document.getElementById('btn-backup').disabled = true;
            document.getElementById('btn-cancel').style.display = 'inline-block';
            document.getElementById('log-panel').style.display = 'block';
            document.getElementById('log-panel').innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';

            var url = devices.length === 1 ? '/api/backup/trigger?device=' + encodeURIComponent(devices[0]) : '/api/backup/trigger';
            addLog('info', 'Iniciando ' + devices.length + ' backup(s)...');
            fetch(url).then(function (r) { return r.json(); }).then(function (d) {
                if (d.error) { addLog('error', d.error); finishBackup(); }
                else { pollStatus(); }
            });
        }

        function cancelBackup() {
            if (!confirm('¬øSeguro que desea cancelar el backup en curso?')) return;
            addLog('info', 'Cancelando...');
            fetch('/api/backup/cancel').then(function (r) { return r.json(); }).then(function (d) {
                addLog('info', d.message || 'Cancelado');
            });
        }

        var lastLogCount = 0;

        function pollStatus() {
            if (!isBackupRunning) return;
            fetch('/api/backup/status').then(function (r) { return r.json(); }).then(function (d) {
                document.getElementById('backup-status').textContent = d.message;
                document.getElementById('progress-bar').style.width = d.progress + '%';

                // Display new logs since last poll
                if (d.logs && d.logs.length > lastLogCount) {
                    for (var i = lastLogCount; i < d.logs.length; i++) {
                        var log = d.logs[i];
                        addLog(log.type, log.msg);
                    }
                    lastLogCount = d.logs.length;
                }

                if (d.running && !d.cancelled) {
                    setTimeout(pollStatus, 1000);
                } else {
                    if (d.cancelled) addLog('warning', '‚ö†Ô∏è Backup cancelado');
                    finishBackup();
                }
            }).catch(function () { setTimeout(pollStatus, 3000); });
        }

        function finishBackup() {
            isBackupRunning = false;
            document.getElementById('btn-backup').disabled = false;
            document.getElementById('btn-cancel').style.display = 'none';
            addLog('info', '‚úì Proceso finalizado');
            setTimeout(function () { loadJobs(1); }, 1500);
        }

        function addLog(t, m) { var p = document.getElementById('log-panel'); p.innerHTML += '<div class="log-' + t + '">' + m + '</div>'; p.scrollTop = p.scrollHeight; }

        function loadJobs(page) {
            fetch('/api/jobs?page=' + page + '&per_page=10').then(function (r) { return r.json(); }).then(function (data) {
                var tb = document.getElementById('jobs-table'); tb.innerHTML = '';
                data.jobs.forEach(function (j) {
                    var ts = j.timestamp ? j.timestamp.split('.')[0] : '';
                    var st = j.status === 'SUCCESS' ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-danger">ERR</span>';
                    tb.innerHTML += '<tr><td><small>' + ts + '</small></td><td><strong>' + j.hostname + '</strong></td><td><small>' + (j.group_name || '-') + '</small></td><td>' + st + '</td><td><small class="text-muted">' + (j.message || '').substring(0, 40) + '</small></td><td><a href="/files/' + j.hostname + '" class="btn btn-sm btn-outline-primary py-0">üìÅ</a> <a href="/diff/' + j.vendor + '/' + j.hostname + '" class="btn btn-sm btn-outline-secondary py-0">üìù</a> <button class="btn btn-sm btn-outline-success py-0" onclick="backupSingle(\'' + j.hostname + '\')">üîÑ</button></td></tr>';
                });
                document.getElementById('jobs-info').textContent = 'P√°gina ' + data.page + '/' + data.pages + ' (' + data.total + ' total)';
                var pg = document.getElementById('pagination'); pg.innerHTML = '';
                if (data.page > 1) pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(' + (data.page - 1) + ')">¬´</a></li>';
                for (var i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++) { pg.innerHTML += '<li class="page-item ' + (i === data.page ? 'active' : '') + '"><a class="page-link" href="#" onclick="loadJobs(' + i + ')">' + i + '</a></li>'; }
                if (data.page < data.pages) pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(' + (data.page + 1) + ')">¬ª</a></li>';
            });
        }

        function backupSingle(h) { if (confirm('Backup ' + h + '?')) startBackup([h]); }

        // Charts
        var ok = {{ stats.get('SUCCESS', 0) }}, err = {{ stats.get('ERROR', 0) }};
        if (ok + err > 0) {
            new Chart(document.getElementById('chartPie'), {
                type: 'doughnut',
                data: { labels: ['OK', 'Error'], datasets: [{ data: [ok, err], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '60%' }
            });
        }

        fetch('/api/stats/by_group').then(function (r) { return r.json(); }).then(function (data) {
            var groups = Object.keys(data); if (groups.length === 0) return;
            document.getElementById('group-charts-card').style.display = 'block';
            var row = document.getElementById('group-charts-row');
            groups.forEach(function (g, i) {
                var s = data[g].SUCCESS || 0, e = data[g].ERROR || 0;
                if (s + e === 0) return;
                row.innerHTML += '<div class="col-md-2 col-sm-4 mb-2 text-center"><div class="chart-container"><canvas id="chart-' + i + '"></canvas></div><small class="text-muted">' + g + '</small></div>';
            });
            setTimeout(function () {
                groups.forEach(function (g, i) {
                    var c = document.getElementById('chart-' + i); if (!c) return;
                    new Chart(c, { type: 'doughnut', data: { labels: ['OK', 'Err'], datasets: [{ data: [data[g].SUCCESS || 0, data[g].ERROR || 0], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '50%' } });
                });
            }, 100);
        });

        loadJobs(1);
    </script>
</body>

</html>