{% extends "base.html" %}
{% block title %}Backup Dashboard{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .log-panel {
        font-family: 'Consolas', monospace;
        font-size: 10px;
        background: #0d1117;
        color: #58a6ff;
        min-height: 60px;
        max-height: 100px;
        overflow-y: auto;
        border-radius: 6px;
    }

    .log-success {
        color: #3fb950;
    }

    .log-error {
        color: #f85149;
    }

    .log-info {
        color: #58a6ff;
    }

    .log-warning {
        color: #f0ad4e;
    }

    .stat-box {
        text-align: center;
        padding: 0.5rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }

    .group-collapse {
        cursor: pointer;
    }

    .device-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .chart-container {
        height: 120px;
        position: relative;
    }

    /* Jobs section card - prevent vertical expansion */
    #jobs-section {
        flex-grow: 0 !important;
        flex-shrink: 0 !important;
        height: auto !important;
    }

    /* Enterprise Filter Sidebar Layout */
    .jobs-layout {
        display: flex;
        align-items: flex-start;
        border-top: 1px solid #dee2e6;
    }

    .jobs-sidebar {
        width: 240px;
        min-width: 240px;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        transition: width 0.25s ease, min-width 0.25s ease, opacity 0.25s ease;
        overflow: hidden;
    }

    .jobs-layout.collapsed .jobs-sidebar {
        display: none;
    }

    #jobs-section.sidebar-collapsed #footer-info {
        padding-left: 0 !important;
    }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
    }

    .sidebar-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: #495057;
    }

    .sidebar-toggle {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 2px 8px;
        cursor: pointer;
        font-size: 10px;
    }

    .sidebar-toggle:hover {
        background: #e9ecef;
    }

    .sidebar-body {
        padding: 0.5rem 0.75rem;
        overflow-y: auto;
    }

    .filter-group {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .filter-group:last-of-type {
        border-bottom: none;
    }

    .filter-label {
        display: block;
        font-size: 0.7rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 0.25rem;
    }

    .filter-actions {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #dee2e6;
    }

    .sidebar-expand-btn {
        background: #e9ecef;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 2px 8px;
        cursor: pointer;
        font-size: 10px;
    }

    .sidebar-expand-btn:hover {
        background: #dee2e6;
    }

    .jobs-content {
        flex: 1;
        min-width: 0;
    }

    .content-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    .search-box {
        flex: 1;
        max-width: 350px;
    }

    .toolbar-info {
        text-align: right;
    }

    .table-responsive {
        flex: 1;
        overflow-y: auto;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .jobs-sidebar {
            width: 200px;
            min-width: 200px;
        }
    }

    @media (max-width: 768px) {
        .jobs-layout {
            flex-direction: column;
        }

        .jobs-sidebar {
            width: 100%;
            min-width: 100%;
            max-height: 300px;
        }

        .jobs-layout.collapsed .jobs-sidebar {
            max-height: 0;
        }
    }

    /* Dark Mode Support for Dashboard Sidebar */
    [data-theme="dark"] .sidebar-toggle:hover {
        background: #334155;
    }

    [data-theme="dark"] .filter-group {
        border-bottom-color: #475569;
    }

    [data-theme="dark"] .filter-label {
        color: #9ca3af;
    }

    [data-theme="dark"] .filter-actions {
        border-top-color: #475569;
    }

    [data-theme="dark"] .sidebar-expand-btn {
        background: #334155;
        border-color: #475569;
        color: #e9ecef;
    }

    [data-theme="dark"] .sidebar-expand-btn:hover {
        background: #475569;
    }

    [data-theme="dark"] .content-toolbar {
        background: var(--bg-card, #1e293b);
        border-bottom-color: #475569;
    }

    [data-theme="dark"] .jobs-sidebar {
        background: var(--bg-card, #1e293b);
        border-color: #475569;
    }
</style>
{% endblock %}

{% block content %}
<!-- Control Panel (Legacy - Hidden, replaced by Global Widget) -->
<div class="card mb-3" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <span><i class="bi bi-rocket-takeoff me-2"></i>Control de Backup</span>
        <div>
            <button class="btn btn-danger btn-sm me-2" id="btn-cancel" onclick="cancelBackup()" style="display:none;">‚èπÔ∏è
                Cancelar</button>
            <button class="btn btn-light btn-sm" id="btn-backup" data-bs-toggle="modal" data-bs-target="#backupModal">‚ñ∂Ô∏è
                Ejecutar Backup</button>
        </div>
    </div>
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-md-7">
                <small id="backup-status" class="text-muted">Listo para ejecutar</small>
                <div class="progress mt-1" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar"
                        style="width: 0%"></div>
                </div>
            </div>
            <div class="col-md-5">
                <div id="log-panel" class="log-panel p-2" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- New Action Button Card -->
<div class="card mb-3">
    <div class="card-header py-2">
        <span><i class="bi bi-rocket-takeoff me-2"></i>Acciones R√°pidas</span>
    </div>
    <div class="card-body py-3">
        <button class="btn btn-primary" onclick="new bootstrap.Modal(document.getElementById('backupModal')).show()">
            ‚ñ∂Ô∏è Ejecutar Nuevo Backup
        </button>
        <span class="text-muted ms-2 small">El progreso del backup se mostrar√° en el widget global.</span>
    </div>
</div>

<!-- Stats Panel -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <!-- Disk -->
            <div class="col-md-3 border-end">
                <div class="d-flex align-items-center">
                    <span class="me-2" style="font-size: 2rem;">üíæ</span>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Disco</small>
                            <small class="text-muted" id="disk-info">{{ disk.free_gb }} GB libres / {{ disk.total_gb }}
                                GB</small>
                        </div>
                        <div class="progress" style="height: 18px;">
                            <div class="progress-bar"
                                style="width: {{ disk.percent }}%; background: linear-gradient(90deg, #198754, {{ '#ffc107' if disk.percent > 60 else '#198754' }}, {{ '#dc3545' if disk.percent > 85 else '#ffc107' if disk.percent > 60 else '#198754' }});">
                                {{ disk.percent }}%</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 24h Stats - Clickable -->
            <div class="col-md-5 border-end">
                <div class="row text-center">
                    <div class="col-6">
                        <a href="/devices" class="text-decoration-none" id="stat-success"
                            title="Backups exitosos en las √∫ltimas 24 horas">
                            {% if stats.get('SUCCESS', 0) > 0 %}
                            <div class="stat-number text-success" style="cursor:pointer;">{{ stats.get('SUCCESS', 0) }}
                            </div>
                            <small class="text-muted">‚úì Exitosos (24h)</small>
                            {% else %}
                            <div class="stat-number text-muted" style="cursor:pointer;">-</div>
                            <small class="text-muted">Sin actividad (24h)</small>
                            {% endif %}
                        </a>
                    </div>
                    <div class="col-6">
                        <a href="/devices?criticidad=alta" class="text-decoration-none" id="stat-error"
                            title="Backups fallidos en las √∫ltimas 24 horas">
                            {% if stats.get('ERROR', 0) > 0 %}
                            <div class="stat-number text-danger" style="cursor:pointer;">{{ stats.get('ERROR', 0) }}
                            </div>
                            <small class="text-muted">‚úó Fallidos (24h)</small>
                            {% else %}
                            <div class="stat-number text-muted" style="cursor:pointer;">-</div>
                            <small class="text-success">‚úì Sin errores (24h)</small>
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
            <!-- Pie Chart -->
            <div class="col-md-4">
                <div class="chart-container"><canvas id="chartPie"></canvas></div>
            </div>
        </div>
    </div>
</div>

<!-- Group Charts -->
<div class="card mb-3" id="group-charts-card" style="display: none;">
    <div class="card-header py-2"><small class="text-muted">üìä Estad√≠sticas por Grupo (24h)</small></div>
    <div class="card-body py-2">
        <div class="row" id="group-charts-row"></div>
    </div>
</div>

<!-- Jobs Section with Enterprise Filter Sidebar -->
<div class="card" id="jobs-section">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
            <button class="sidebar-expand-btn" id="sidebar-toggle-btn" onclick="toggleJobsSidebar()"
                title="Mostrar/Ocultar filtros">
                ‚â°
            </button>
            <span>üìã √öltimas Ejecuciones</span>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-secondary" id="active-filters-count" style="display: none;">0 filtros</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadJobs(1)" title="Recargar">üîÑ</button>
        </div>
    </div>

    <!-- Enterprise Layout: Sidebar + Content -->
    <div class="jobs-layout" id="jobs-layout">
        <!-- Filter Sidebar -->
        <aside class="jobs-sidebar" id="jobs-sidebar">
            <div class="sidebar-body">
                <!-- Search Box at Top -->
                <div class="filter-group">
                    <input type="text" class="form-control form-control-sm" id="jobs-filter-search"
                        placeholder="üîç Buscar por nombre, IP, grupo..." onkeyup="loadJobs(1)">
                </div>

                <!-- Location Filters -->
                <div class="filter-group">
                    <label class="filter-label">üìç Ubicaci√≥n</label>
                    <select class="form-select form-select-sm mb-2" id="jobs-filter-localidad" onchange="loadJobs(1)">
                        <option value="">Todas las localidades</option>
                    </select>
                    <select class="form-select form-select-sm" id="jobs-filter-troncal" onchange="loadJobs(1)">
                        <option value="">Todas las troncales</option>
                    </select>
                </div>

                <!-- Device Filters -->
                <div class="filter-group">
                    <label class="filter-label">üñ•Ô∏è Dispositivo</label>
                    <select class="form-select form-select-sm mb-2" id="jobs-filter-vendor" onchange="loadJobs(1)">
                        <option value="">Todos los vendors</option>
                    </select>
                    <select class="form-select form-select-sm mb-2" id="jobs-filter-modelo" onchange="loadJobs(1)">
                        <option value="">Todos los modelos</option>
                    </select>
                    <select class="form-select form-select-sm" id="jobs-filter-tipo" onchange="loadJobs(1)">
                        <option value="">Todos los tipos</option>
                    </select>
                </div>

                <!-- Organization Filters -->
                <div class="filter-group">
                    <label class="filter-label">üìÅ Organizaci√≥n</label>
                    <select class="form-select form-select-sm mb-2" id="jobs-filter-grupo" onchange="loadJobs(1)">
                        <option value="">Todos los grupos</option>
                    </select>
                    <select class="form-select form-select-sm" id="jobs-filter-criticidad" onchange="loadJobs(1)">
                        <option value="">Todas las criticidades</option>
                        <option value="alta">üî¥ Alta</option>
                        <option value="media">üü° Media</option>
                        <option value="baja">üü¢ Baja</option>
                    </select>
                </div>

                <!-- Status Filters -->
                <div class="filter-group">
                    <label class="filter-label">üìä Estado</label>
                    <select class="form-select form-select-sm" id="jobs-filter-status" onchange="loadJobs(1)">
                        <option value="">Todos los estados</option>
                        <option value="SUCCESS">‚úÖ Exitosos</option>
                        <option value="ERROR">‚ùå Fallidos</option>
                        <option value="WARNING">‚ö†Ô∏è Advertencias</option>
                    </select>
                </div>

                <!-- Actions -->
                <div class="filter-actions">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearJobsFilters()">
                        üóëÔ∏è Limpiar Filtros
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="jobs-content">
            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Hora</th>
                            <th>Host</th>
                            <th>Grupo</th>
                            <th>Status</th>
                            <th>Mensaje</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card-footer py-1 d-flex justify-content-between align-items-center">
        <div id="footer-info" class="d-flex align-items-center gap-2"
            style="padding-left: 240px; transition: padding 0.25s ease;">
            <small class="text-muted" id="jobs-info">Cargando...</small>
            <input type="number" class="form-control form-control-sm" id="jobs-per-page" value="25" min="5" max="200"
                step="5" onchange="loadJobs(1)" style="width: 55px;" title="Registros por p√°gina">
            <small class="text-muted">registros</small>
        </div>
        <div id="jobs-pagination"></div>
    </div>
</div>

<!-- Backup Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title">üéØ Seleccionar Equipos para Backup</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Filter Bar -->
                <div class="bg-light border-bottom p-2">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filter-localidad" onchange="applyFilters()">
                                <option value="">üìç Localidad</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="filter-tipo" onchange="applyFilters()">
                                <option value="">üè∑Ô∏è Tipo</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="filter-vendor" onchange="applyFilters()">
                                <option value="">üè≠ Vendor</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="filter-criticidad" onchange="applyFilters()">
                                <option value="">‚ö†Ô∏è Criticidad</option>
                                <option value="alta">üî¥ Alta</option>
                                <option value="media">üü° Media</option>
                                <option value="baja">üü¢ Baja</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" id="device-search"
                                placeholder="üîç Buscar..." onkeyup="applyFilters()">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="select-all"
                                onchange="toggleAllVisible(this)">
                            <label class="form-check-label fw-bold" for="select-all">Seleccionar visibles</label>
                        </div>
                        <small class="text-muted" id="visible-count">0 dispositivos</small>
                        <button class="btn btn-outline-secondary btn-sm py-0" onclick="clearFilters()">üóëÔ∏è
                            Limpiar</button>
                    </div>
                </div>
                <!-- Device Tree -->
                <div style="max-height: 350px; overflow-y: auto;" class="p-2">
                    {% for group in inventory.groups %}
                    <div class="mb-2 group-container" data-vendor="{{ group.vendor|lower }}">
                        <div class="d-flex align-items-center group-collapse" data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ loop.index }}">
                            <input class="form-check-input me-2 group-check" type="checkbox"
                                data-group="{{ group.name }}"
                                onclick="event.stopPropagation(); toggleGroup('{{ group.name }}')">
                            <span class="fw-bold">üìÅ {{ group.name }}</span>
                            <span class="badge bg-info ms-2">{{ group.vendor }}</span>
                            <span class="badge bg-secondary ms-1 group-device-count">{{ group.devices|length }}</span>
                            <span class="ms-auto">‚ñº</span>
                        </div>
                        <div class="collapse device-list ms-4" id="collapse-{{ loop.index }}">
                            {% for device in group.devices %}
                            <div class="form-check device-item"
                                data-name="{{ (device.sysname or device.hostname)|lower }}"
                                data-localidad="{{ (device.localidad or '')|lower }}"
                                data-tipo="{{ (device.tipo or '')|lower }}" data-vendor="{{ group.vendor|lower }}"
                                data-criticidad="{{ (device.criticidad or '')|lower }}"
                                data-tags="{{ (device.tags or [])|join(',') }}">
                                <input class="form-check-input device-check" type="checkbox"
                                    data-group="{{ group.name }}" value="{{ device.sysname or device.hostname }}">
                                <label class="form-check-label">
                                    <small>{{ device.sysname or device.hostname }} ({{ device.ip }})</small>
                                    {% if device.criticidad == 'alta' %}<span class="badge bg-danger ms-1">Alta</span>{%
                                    endif %}
                                    {% if device.localidad %}<span class="badge bg-secondary ms-1">{{ device.localidad
                                        }}</span>{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer py-2">
                <span class="me-auto text-muted">Seleccionados: <strong id="selected-count">0</strong></span>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-sm" onclick="runSelectedBackup()" id="btn-run"
                    disabled>‚ñ∂Ô∏è Ejecutar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const backupModal = new bootstrap.Modal(document.getElementById('backupModal'));
    let isBackupRunning = false, lastLogCount = 0;

    // Populate filter dropdowns when modal opens
    document.getElementById('backupModal').addEventListener('show.bs.modal', function () {
        populateFilters();
        applyFilters();
    });

    function populateFilters() {
        const localidades = new Set(), tipos = new Set(), vendors = new Set();
        document.querySelectorAll('.device-item').forEach(el => {
            if (el.dataset.localidad) localidades.add(el.dataset.localidad);
            if (el.dataset.tipo) tipos.add(el.dataset.tipo);
            if (el.dataset.vendor) vendors.add(el.dataset.vendor);
        });

        // Populate localidad
        const selLoc = document.getElementById('filter-localidad');
        selLoc.innerHTML = '<option value="">üìç Localidad</option>';
        [...localidades].sort().forEach(v => selLoc.innerHTML += '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>');

        // Populate tipo
        const selTipo = document.getElementById('filter-tipo');
        selTipo.innerHTML = '<option value="">üè∑Ô∏è Tipo</option>';
        [...tipos].sort().forEach(v => selTipo.innerHTML += '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>');

        // Populate vendor
        const selVendor = document.getElementById('filter-vendor');
        selVendor.innerHTML = '<option value="">üè≠ Vendor</option>';
        [...vendors].sort().forEach(v => selVendor.innerHTML += '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>');
    }

    function applyFilters() {
        const fLocalidad = document.getElementById('filter-localidad').value.toLowerCase();
        const fTipo = document.getElementById('filter-tipo').value.toLowerCase();
        const fVendor = document.getElementById('filter-vendor').value.toLowerCase();
        const fCriticidad = document.getElementById('filter-criticidad').value.toLowerCase();
        const fSearch = document.getElementById('device-search').value.toLowerCase();

        let visibleCount = 0;
        document.querySelectorAll('.device-item').forEach(el => {
            const matchLoc = !fLocalidad || el.dataset.localidad === fLocalidad;
            const matchTipo = !fTipo || el.dataset.tipo === fTipo;
            const matchVendor = !fVendor || el.dataset.vendor === fVendor;
            const matchCrit = !fCriticidad || el.dataset.criticidad === fCriticidad;
            const matchSearch = !fSearch || el.dataset.name.includes(fSearch);

            const visible = matchLoc && matchTipo && matchVendor && matchCrit && matchSearch;
            el.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        // Update group visibility and counts
        document.querySelectorAll('.group-container').forEach(group => {
            const visibleDevices = group.querySelectorAll('.device-item:not([style*="display: none"])');
            const countBadge = group.querySelector('.group-device-count');
            if (countBadge) countBadge.textContent = visibleDevices.length;
            group.style.display = visibleDevices.length > 0 ? '' : 'none';
        });

        document.getElementById('visible-count').textContent = visibleCount + ' dispositivos';
        document.getElementById('select-all').checked = false;
    }

    function clearFilters() {
        document.getElementById('filter-localidad').value = '';
        document.getElementById('filter-tipo').value = '';
        document.getElementById('filter-vendor').value = '';
        document.getElementById('filter-criticidad').value = '';
        document.getElementById('device-search').value = '';
        applyFilters();
    }

    function toggleAllVisible(cb) {
        document.querySelectorAll('.device-item:not([style*="display: none"]) .device-check').forEach(el => el.checked = cb.checked);
        updateCount();
    }

    function toggleGroup(name) {
        const cb = document.querySelector('.group-check[data-group="' + name + '"]');
        document.querySelectorAll('.device-item:not([style*="display: none"]) .device-check[data-group="' + name + '"]').forEach(el => el.checked = cb.checked);
        updateCount();
    }

    function updateCount() {
        const n = document.querySelectorAll('.device-check:checked').length;
        document.getElementById('selected-count').textContent = n;
        document.getElementById('btn-run').disabled = n === 0;
    }

    document.querySelectorAll('.device-check').forEach(el => el.addEventListener('change', updateCount));

    function runSelectedBackup() {
        var selected = Array.from(document.querySelectorAll('.device-check:checked')).map(el => el.value);
        if (selected.length === 0) return alert('Seleccione equipos');
        if (!confirm('¬øBackup de ' + selected.length + ' equipo(s)?')) return;
        backupModal.hide();
        startBackup(selected);
    }

    function startBackup(devices) {
        // Disable button to prevent double clicks
        document.getElementById('btn-backup').disabled = true;

        // Build URL with all selected devices
        var params = devices.map(d => 'device=' + encodeURIComponent(d)).join('&');
        var url = '/api/backup/trigger' + (params ? '?' + params : '');

        fetch(url).then(r => r.json()).then(d => {
            if (d.error) {
                alert(d.error);
                document.getElementById('btn-backup').disabled = false;
            } else {
                // Success!
                // 1. Open the Global Modal to show progress
                if (window.openBackupGlobalModal) window.openBackupGlobalModal();

                // 2. Hide local control panel if visible (optional, keeping it simple)
                // document.getElementById('log-panel').style.display = 'none';

                // 3. Re-enable button after a moment (logic handled by global state but safe to reset UI state)
                setTimeout(() => { document.getElementById('btn-backup').disabled = false; }, 2000);
            }
        }).catch(err => {
            alert("Error al iniciar backup: " + err);
            document.getElementById('btn-backup').disabled = false;
        });
    }

    function cancelBackup() {
        if (!confirm('¬øCancelar backup?')) return;
        addLog('info', 'Cancelando...');
        fetch('/api/backup/cancel').then(r => r.json()).then(d => addLog('info', d.message || 'Cancelado'));
    }

    function pollStatus() {
        // Disabled: Polling is now handled globally by base.html
        // if (!isBackupRunning) return;
        // fetch('/api/backup/status')....
        return;
    }

    function finishBackup() {
        isBackupRunning = false;
        document.getElementById('btn-backup').disabled = false;
        document.getElementById('btn-cancel').style.display = 'none';
        addLog('info', '‚úì Proceso finalizado');
        setTimeout(() => loadJobs(1), 1500);
        setTimeout(() => refreshStats(), 2000); // Refresh stats after backup
    }

    function refreshStats() {
        fetch('/api/stats/24h').then(r => r.json()).then(data => {
            var s = data.stats;
            // Update success counter
            var successDiv = document.getElementById('stat-success');
            if (successDiv) {
                if (s.SUCCESS > 0) {
                    successDiv.innerHTML = '<div class="stat-number text-success" style="cursor:pointer;">' + s.SUCCESS + '</div><small class="text-muted">‚úì Exitosos (24h)</small>';
                } else {
                    successDiv.innerHTML = '<div class="stat-number text-muted" style="cursor:pointer;">-</div><small class="text-muted">Sin actividad (24h)</small>';
                }
            }
            // Update error counter
            var errorDiv = document.getElementById('stat-error');
            if (errorDiv) {
                if (s.ERROR > 0) {
                    errorDiv.innerHTML = '<div class="stat-number text-danger" style="cursor:pointer;">' + s.ERROR + '</div><small class="text-muted">‚úó Fallidos (24h)</small>';
                } else {
                    errorDiv.innerHTML = '<div class="stat-number text-muted" style="cursor:pointer;">-</div><small class="text-success">‚úì Sin errores (24h)</small>';
                }
            }
            // Update disk info
            var diskDiv = document.getElementById('disk-info');
            if (diskDiv && data.disk) {
                diskDiv.textContent = data.disk.free_gb + ' GB libres / ' + data.disk.total_gb + ' GB';
            }
        });
    }

    function addLog(t, m) { var p = document.getElementById('log-panel'); p.innerHTML += '<div class="log-' + t + '">' + m + '</div>'; p.scrollTop = p.scrollHeight; }

    function populateJobsFilters() {
        fetch('/api/filter-options').then(r => r.json()).then(opts => {
            // Filtros de Jobs (√öltimas Ejecuciones) - FULL
            const selLoc = document.getElementById('jobs-filter-localidad');
            selLoc.innerHTML = '<option value="">Todas las localidades</option>';
            opts.localidades.forEach(l => selLoc.innerHTML += '<option value="' + l.id + '">' + l.name + '</option>');

            const selTroncal = document.getElementById('jobs-filter-troncal');
            selTroncal.innerHTML = '<option value="">üîó Troncal</option>';
            opts.troncales.forEach(v => selTroncal.innerHTML += '<option value="' + v + '">' + v + '</option>');

            const selTipo = document.getElementById('jobs-filter-tipo');
            selTipo.innerHTML = '<option value="">Todos los tipos</option>';
            opts.tipos.forEach(t => selTipo.innerHTML += '<option value="' + t.id + '">' + t.name + '</option>');

            // Vendor friendly names mapping
            const vendorNames = {
                'hp': 'HP',
                'huawei': 'Huawei',
                'zte_olt': 'OLT ZTE',
                'cisco': 'Cisco',
                'mikrotik': 'MikroTik',
                'juniper': 'Juniper',
                'fortinet': 'Fortinet'
            };
            const getVendorName = (v) => vendorNames[v.toLowerCase()] || v.charAt(0).toUpperCase() + v.slice(1);

            const selVendor = document.getElementById('jobs-filter-vendor');
            selVendor.innerHTML = '<option value="">üè≠ Vendor</option>';
            opts.vendors.forEach(v => selVendor.innerHTML += '<option value="' + v + '">' + getVendorName(v) + '</option>');

            const selModelo = document.getElementById('jobs-filter-modelo');
            if (selModelo && opts.modelos) {
                selModelo.innerHTML = '<option value="">üì¶ Modelo</option>';
                opts.modelos.forEach(m => selModelo.innerHTML += '<option value="' + m.id + '">' + m.name + '</option>');
            }

            const selGrupo = document.getElementById('jobs-filter-grupo');
            selGrupo.innerHTML = '<option value="">üìÅ Grupo</option>';
            opts.grupos.forEach(v => selGrupo.innerHTML += '<option value="' + v + '">' + v + '</option>');

            // Filtros del Modal de Backup
            const filterLoc = document.getElementById('filter-localidad');
            if (filterLoc) {
                filterLoc.innerHTML = '<option value="">üìç Localidad</option>';
                opts.localidades.forEach(l => filterLoc.innerHTML += '<option value="' + l.id + '">' + l.name + '</option>');
            }

            const filterTipo = document.getElementById('filter-tipo');
            if (filterTipo) {
                filterTipo.innerHTML = '<option value="">üè∑Ô∏è Tipo</option>';
                opts.tipos.forEach(t => filterTipo.innerHTML += '<option value="' + t.id + '">' + t.name + '</option>');
            }

            const filterVendor = document.getElementById('filter-vendor');
            if (filterVendor) {
                filterVendor.innerHTML = '<option value="">üè≠ Vendor</option>';
                opts.vendors.forEach(v => filterVendor.innerHTML += '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>');
            }

            const filterCrit = document.getElementById('filter-criticidad');
            if (filterCrit) {
                filterCrit.innerHTML = '<option value="">‚ö†Ô∏è Criticidad</option>';
                opts.criticidades.forEach(v => filterCrit.innerHTML += '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>');
            }
        });
    }
    // ============================================
    // ENTERPRISE SIDEBAR FUNCTIONS
    // ============================================

    function toggleJobsSidebar() {
        const layout = document.getElementById('jobs-layout');
        const section = document.getElementById('jobs-section');
        const isCollapsed = layout.classList.toggle('collapsed');
        section.classList.toggle('sidebar-collapsed', isCollapsed);

        // Persist state
        sessionStorage.setItem('jobsSidebarCollapsed', isCollapsed);
    }

    function clearJobsFilters() {
        // Clear all filter selects
        const filterIds = [
            'jobs-filter-localidad', 'jobs-filter-troncal', 'jobs-filter-tipo',
            'jobs-filter-vendor', 'jobs-filter-modelo', 'jobs-filter-grupo',
            'jobs-filter-criticidad', 'jobs-filter-status'
        ];
        filterIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        // Clear search
        document.getElementById('jobs-filter-search').value = '';

        // Update badge
        updateActiveFiltersCount();

        // Reload
        loadJobs(1);
    }

    function updateActiveFiltersCount() {
        const filterIds = [
            'jobs-filter-localidad', 'jobs-filter-troncal', 'jobs-filter-tipo',
            'jobs-filter-vendor', 'jobs-filter-modelo', 'jobs-filter-grupo',
            'jobs-filter-criticidad', 'jobs-filter-status'
        ];
        let count = 0;
        filterIds.forEach(id => {
            const el = document.getElementById(id);
            if (el && el.value) count++;
        });

        const badge = document.getElementById('active-filters-count');
        if (badge) {
            badge.textContent = count + ' filtro' + (count !== 1 ? 's' : '');
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }

    function restoreSidebarState() {
        const collapsed = sessionStorage.getItem('jobsSidebarCollapsed') === 'true';
        if (collapsed) {
            const layout = document.getElementById('jobs-layout');
            const section = document.getElementById('jobs-section');
            if (layout) layout.classList.add('collapsed');
            if (section) section.classList.add('sidebar-collapsed');
        }
    }

    // Initialize sidebar state on page load
    document.addEventListener('DOMContentLoaded', restoreSidebarState);

    function loadJobs(page) {
        // Update filters badge
        updateActiveFiltersCount();

        const perPage = document.getElementById('jobs-per-page') ? document.getElementById('jobs-per-page').value : 25;
        let url = '/api/jobs?page=' + page + '&per_page=' + perPage;
        const loc = document.getElementById('jobs-filter-localidad').value;
        const troncal = document.getElementById('jobs-filter-troncal').value;
        const tipo = document.getElementById('jobs-filter-tipo').value;
        const vendor = document.getElementById('jobs-filter-vendor').value;
        const modelo = document.getElementById('jobs-filter-modelo') ? document.getElementById('jobs-filter-modelo').value : '';
        const grupo = document.getElementById('jobs-filter-grupo').value;
        const criticidad = document.getElementById('jobs-filter-criticidad').value;
        const status = document.getElementById('jobs-filter-status').value;
        const search = document.getElementById('jobs-filter-search').value;

        if (loc) url += '&localidad=' + encodeURIComponent(loc);
        if (troncal) url += '&troncal=' + encodeURIComponent(troncal);
        if (tipo) url += '&tipo=' + encodeURIComponent(tipo);
        if (vendor) url += '&vendor=' + encodeURIComponent(vendor);
        if (modelo) url += '&modelo=' + encodeURIComponent(modelo);
        if (grupo) url += '&grupo=' + encodeURIComponent(grupo);
        if (criticidad) url += '&criticidad=' + encodeURIComponent(criticidad);
        if (status) url += '&status=' + encodeURIComponent(status);
        if (search) url += '&search=' + encodeURIComponent(search);

        fetch(url).then(r => r.json()).then(data => {
            var tb = document.getElementById('jobs-table'); tb.innerHTML = '';
            data.jobs.forEach(j => {
                var ts = j.timestamp ? j.timestamp.split('.')[0] : '';
                // Differentiate: SUCCESS with changes, NO_CHANGE (success but no diff), ERROR
                var st;
                var msg = (j.message || '').toLowerCase();
                if (j.status === 'SUCCESS') {
                    if (msg.includes('sin cambios') || msg.includes('no change') || msg.includes('identical')) {
                        st = '<span class="badge bg-warning text-dark" title="Sin cambios detectados">=</span>';
                    } else {
                        st = '<span class="badge bg-success" title="Backup exitoso">OK</span>';
                    }
                } else {
                    st = '<span class="badge bg-danger" title="Error">ERR</span>';
                }
                var displayName = j.nombre || j.hostname;
                var msgFull = (j.message || '').replace(/"/g, '&quot;');
                var msgShort = (j.message || '').substring(0, 40);
                if (j.message && j.message.length > 40) msgShort += '...';
                tb.innerHTML += '<tr><td><small>' + ts + '</small></td><td><strong title="' + j.hostname + '">' + displayName + '</strong></td><td><small>' + (j.group_name || '-') + '</small></td><td>' + st + '</td><td><small class="text-muted" title="' + msgFull + '" style="cursor:help;">' + msgShort + '</small></td><td><a href="/files/' + j.vendor + '/' + j.hostname + '" class="btn btn-sm btn-outline-primary py-0">üìÅ</a> <a href="/diff/' + j.vendor + '/' + j.hostname + '" class="btn btn-sm btn-outline-secondary py-0">üìù</a> <button class="btn btn-sm btn-outline-success py-0" onclick="backupSingle(\'' + j.hostname + '\')">üîÑ</button></td></tr>';
            });
            document.getElementById('jobs-info').textContent = 'P√°g ' + data.page + '/' + data.pages + ' (' + data.total + ')';

            var pg = document.getElementById('jobs-pagination'); pg.innerHTML = '';
            var pages = data.pages, current = data.page;

            // Build pagination with ellipsis pattern: ¬´ 1 2 ... 5 6 7 ... 39 40 ¬ª
            function addBtn(page, label, active) {
                var cls = active ? 'btn-primary' : 'btn-outline-secondary';
                pg.innerHTML += '<a class="btn btn-sm ' + cls + ' me-1" href="#" onclick="loadJobs(' + page + ')">' + (label || page) + '</a>';
            }
            function addEllipsis() {
                pg.innerHTML += '<span class="px-2 text-muted">...</span>';
            }

            if (current > 1) addBtn(current - 1, '¬´');

            if (pages <= 9) {
                // Show all pages
                for (var i = 1; i <= pages; i++) addBtn(i, i, i === current);
            } else {
                // Always show first 3
                addBtn(1, 1, 1 === current);
                addBtn(2, 2, 2 === current);
                addBtn(3, 3, 3 === current);

                if (current > 5) addEllipsis();

                // Middle pages around current
                var start = Math.max(4, current - 1);
                var end = Math.min(pages - 3, current + 1);
                for (var i = start; i <= end; i++) addBtn(i, i, i === current);

                if (current < pages - 4) addEllipsis();

                // Always show last 3
                addBtn(pages - 2, pages - 2, pages - 2 === current);
                addBtn(pages - 1, pages - 1, pages - 1 === current);
                addBtn(pages, pages, pages === current);
            }

            if (current < pages) addBtn(current + 1, '¬ª');
        });
    }

    function backupSingle(h) { if (confirm('Backup ' + h + '?')) startBackup([h]); }

    // Charts
    var ok = {{ stats.get('SUCCESS', 0) }}, err = {{ stats.get('ERROR', 0) }};
    if (ok + err > 0) {
        new Chart(document.getElementById('chartPie'), {
            type: 'doughnut',
            data: { labels: ['OK', 'Error'], datasets: [{ data: [ok, err], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '60%' }
        });
    }

    fetch('/api/stats/by_group').then(r => r.json()).then(data => {
        var groups = Object.keys(data); if (groups.length === 0) return;
        document.getElementById('group-charts-card').style.display = 'block';
        var row = document.getElementById('group-charts-row');
        groups.forEach((g, i) => {
            var s = data[g].SUCCESS || 0, e = data[g].ERROR || 0;
            if (s + e === 0) return;
            row.innerHTML += '<div class="col-md-2 col-sm-4 mb-2 text-center"><div class="chart-container"><canvas id="chart-' + i + '"></canvas></div><small class="text-muted">' + g + '</small></div>';
        });
        setTimeout(() => {
            groups.forEach((g, i) => {
                var c = document.getElementById('chart-' + i); if (!c) return;
                new Chart(c, { type: 'doughnut', data: { labels: ['OK', 'Err'], datasets: [{ data: [data[g].SUCCESS || 0, data[g].ERROR || 0], backgroundColor: ['#198754', '#dc3545'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '50%' } });
            });
        }, 100);
    });

    populateJobsFilters();

    // Check for device filter from URL (used by global search)
    (function () {
        var params = new URLSearchParams(window.location.search);
        var deviceFilter = params.get('device');
        if (deviceFilter) {
            var searchField = document.getElementById('jobs-filter-search');
            if (searchField) {
                searchField.value = deviceFilter;
                // Show active filter badge
                var badge = document.getElementById('active-filters-count');
                if (badge) {
                    badge.textContent = '1 filtro';
                    badge.style.display = 'inline-block';
                }
            }
        }
    })();

    loadJobs(1);
</script>
{% endblock %}