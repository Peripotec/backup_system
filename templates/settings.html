{% extends "base.html" %}
{% block title %}Configuraci√≥n del Sistema{% endblock %}

{% block head %}
<style>
    .nav-tabs .nav-link {
        color: var(--text-muted);
    }

    .nav-tabs .nav-link.active {
        background: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .form-label {
        font-weight: 500;
    }

    .save-indicator {
        display: none;
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> Configuraci√≥n del Sistema</span>
        <span class="save-indicator" id="save-indicator">‚úì Guardado</span>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#backup">üìÖ
                    Backup</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#retention">üóÇÔ∏è
                    Retenci√≥n</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#email">üìß Email</button>
            </li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#system">üñ•Ô∏è
                    Sistema</button></li>
        </ul>

        <div class="tab-content p-4">
            <!-- Backup -->
            <div class="tab-pane fade show active" id="backup">
                <h5>Programaci√≥n de Backups</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Horario Global</label><input type="text"
                            class="form-control" id="global_schedule" placeholder="02:00, 14:00">
                        <div class="form-text">Separados por coma.</div>
                    </div>
                    <div class="col-md-6"><label class="form-label">Backups Autom√°ticos</label><select
                            class="form-select" id="backup_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select></div>
                </div>
            </div>
            <!-- Retention -->
            <div class="tab-pane fade" id="retention">
                <h5>Retenci√≥n</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">D√≠as de Retenci√≥n</label><input type="number"
                            class="form-control" id="archive_retention_days" min="1" max="365"></div>
                    <div class="col-md-6"><label class="form-label">Auto-Limpieza</label><select class="form-select"
                            id="cleanup_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select></div>
                </div>
            </div>
            <!-- Email -->
            <div class="tab-pane fade" id="email">
                <h5>Configuraci√≥n SMTP</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Servidor SMTP</label><input type="text"
                            class="form-control" id="smtp_host" placeholder="smtp.gmail.com"></div>
                    <div class="col-md-6"><label class="form-label">Puerto</label><input type="number"
                            class="form-control" id="smtp_port" placeholder="587"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Usuario</label><input type="text"
                            class="form-control" id="smtp_user"></div>
                    <div class="col-md-6"><label class="form-label">Contrase√±a</label><input type="password"
                            class="form-control" id="smtp_pass">
                        <div class="form-text">Deja vac√≠o para mantener.</div>
                    </div>
                </div>
                <div class="mb-3"><label class="form-label">Destinatarios</label><input type="text" class="form-control"
                        id="email_recipients" placeholder="admin@example.com"></div>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Notificar Errores</label><select class="form-select"
                            id="notify_on_error">
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select></div>
                    <div class="col-md-6"><label class="form-label">Notificar √âxito</label><select class="form-select"
                            id="notify_on_success">
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select></div>
                </div>
            </div>
            <!-- System -->
            <div class="tab-pane fade" id="system">
                <h5>Sistema</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Servidor TFTP</label><input type="text"
                            class="form-control" id="tftp_server" placeholder="192.168.1.100"></div>
                    <div class="col-md-6"><label class="form-label">Nivel de Log</label><select class="form-select"
                            id="log_level">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select></div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Guardar Configuraci√≥n</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var settings = {{ settings | tojson | safe }};

    document.addEventListener('DOMContentLoaded', function () { loadSettingsToForm(); });

    function loadSettingsToForm() {
        ['global_schedule', 'backup_enabled', 'archive_retention_days', 'cleanup_enabled',
            'smtp_host', 'smtp_port', 'smtp_user', 'email_recipients',
            'notify_on_error', 'notify_on_success', 'tftp_server', 'log_level'].forEach(f => {
                var el = document.getElementById(f);
                if (el && settings[f] !== undefined) el.value = settings[f];
            });
    }

    function saveSettings() {
        var data = {
            global_schedule: document.getElementById('global_schedule').value,
            backup_enabled: document.getElementById('backup_enabled').value,
            archive_retention_days: document.getElementById('archive_retention_days').value,
            cleanup_enabled: document.getElementById('cleanup_enabled').value,
            smtp_host: document.getElementById('smtp_host').value,
            smtp_port: document.getElementById('smtp_port').value,
            smtp_user: document.getElementById('smtp_user').value,
            smtp_pass: document.getElementById('smtp_pass').value,
            email_recipients: document.getElementById('email_recipients').value,
            notify_on_error: document.getElementById('notify_on_error').value,
            notify_on_success: document.getElementById('notify_on_success').value,
            tftp_server: document.getElementById('tftp_server').value,
            log_level: document.getElementById('log_level').value
        };

        fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(r => r.json())
            .then(resp => {
                if (resp.error) alert('Error: ' + resp.error);
                else {
                    var ind = document.getElementById('save-indicator');
                    ind.style.display = 'inline';
                    setTimeout(() => ind.style.display = 'none', 2000);
                }
            });
    }
</script>
{% endblock %}