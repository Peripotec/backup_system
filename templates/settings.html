<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Configuraci√≥n del Sistema</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #fff;
            --bg-navbar: #212529;
            --text-primary: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-navbar: #0f172a;
            --text-primary: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body {
            background: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .navbar {
            background: var(--bg-navbar) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        .nav-tabs .nav-link {
            color: var(--text-muted);
        }

        .nav-tabs .nav-link.active {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background: #334155;
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-label {
            font-weight: 500;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.3rem;
            transition: transform 0.3s;
        }

        .theme-toggle:hover {
            transform: rotate(180deg);
        }

        .save-indicator {
            display: none;
            color: #28a745;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üõ°Ô∏è Backup System</a>
            <ul class="navbar-nav flex-row gap-3">
                <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/inventory">Inventario</a></li>
                <li class="nav-item"><a class="nav-link" href="/files">Archivos</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/vault">üîê Vault</a></li>
                <li class="nav-item"><a class="nav-link active" href="/admin/settings">‚öôÔ∏è Settings</a></li>
                <li class="nav-item"><a class="nav-link" href="/admin/users">üë• Usuarios</a></li>
                <li class="nav-item"><span class="nav-link theme-toggle" onclick="toggleTheme()">üåì</span></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>‚öôÔ∏è Configuraci√≥n del Sistema</span>
                <span class="save-indicator" id="save-indicator">‚úì Guardado</span>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup"
                            type="button">üìÖ Backup</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="retention-tab" data-bs-toggle="tab" data-bs-target="#retention"
                            type="button">üóÇÔ∏è Retenci√≥n</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email"
                            type="button">üìß Email</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system"
                            type="button">üñ•Ô∏è Sistema</button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="settingsTabContent">
                    <!-- BACKUP TAB -->
                    <div class="tab-pane fade show active" id="backup" role="tabpanel">
                        <h5>Programaci√≥n de Backups</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Horario Global</label>
                                <input type="text" class="form-control" id="global_schedule" placeholder="02:00, 14:00">
                                <div class="form-text">Horarios separados por coma. Los grupos sin schedule propio
                                    heredan este.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Backups Autom√°ticos</label>
                                <select class="form-select" id="backup_enabled">
                                    <option value="true">Habilitado</option>
                                    <option value="false">Deshabilitado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- RETENTION TAB -->
                    <div class="tab-pane fade" id="retention" role="tabpanel">
                        <h5>Retenci√≥n de Archivos</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">D√≠as de Retenci√≥n</label>
                                <input type="number" class="form-control" id="archive_retention_days" min="1" max="365">
                                <div class="form-text">Archivos en /archive m√°s antiguos ser√°n eliminados
                                    autom√°ticamente.</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Auto-Limpieza</label>
                                <select class="form-select" id="cleanup_enabled">
                                    <option value="true">Habilitado</option>
                                    <option value="false">Deshabilitado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- EMAIL TAB -->
                    <div class="tab-pane fade" id="email" role="tabpanel">
                        <h5>Configuraci√≥n SMTP</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Servidor SMTP</label>
                                <input type="text" class="form-control" id="smtp_host" placeholder="smtp.gmail.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Puerto</label>
                                <input type="number" class="form-control" id="smtp_port" placeholder="587">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Usuario</label>
                                <input type="text" class="form-control" id="smtp_user" placeholder="user@gmail.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contrase√±a</label>
                                <input type="password" class="form-control" id="smtp_pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <div class="form-text">Deja vac√≠o para mantener la contrase√±a actual.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Destinatarios</label>
                            <input type="text" class="form-control" id="email_recipients"
                                placeholder="admin@example.com, ops@example.com">
                            <div class="form-text">Separados por coma.</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Notificar en Errores</label>
                                <select class="form-select" id="notify_on_error">
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Notificar en √âxito</label>
                                <select class="form-select" id="notify_on_success">
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SYSTEM TAB -->
                    <div class="tab-pane fade" id="system" role="tabpanel">
                        <h5>Configuraci√≥n del Sistema</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Servidor TFTP</label>
                                <input type="text" class="form-control" id="tftp_server" placeholder="192.168.1.100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nivel de Log</label>
                                <select class="form-select" id="log_level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary" onclick="saveSettings()">üíæ Guardar Configuraci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme
        function toggleTheme() {
            var t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }
        (function () { document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); })();

        var settings = {{ settings | tojson | safe }};

        document.addEventListener('DOMContentLoaded', function () {
            loadSettingsToForm();
        });

        function loadSettingsToForm() {
            var fields = ['global_schedule', 'backup_enabled', 'archive_retention_days', 'cleanup_enabled',
                'smtp_host', 'smtp_port', 'smtp_user', 'email_recipients',
                'notify_on_error', 'notify_on_success', 'tftp_server', 'log_level'];

            fields.forEach(function (field) {
                var el = document.getElementById(field);
                if (el && settings[field] !== undefined) {
                    el.value = settings[field];
                }
            });
        }

        function saveSettings() {
            var data = {
                global_schedule: document.getElementById('global_schedule').value,
                backup_enabled: document.getElementById('backup_enabled').value,
                archive_retention_days: document.getElementById('archive_retention_days').value,
                cleanup_enabled: document.getElementById('cleanup_enabled').value,
                smtp_host: document.getElementById('smtp_host').value,
                smtp_port: document.getElementById('smtp_port').value,
                smtp_user: document.getElementById('smtp_user').value,
                smtp_pass: document.getElementById('smtp_pass').value,
                email_recipients: document.getElementById('email_recipients').value,
                notify_on_error: document.getElementById('notify_on_error').value,
                notify_on_success: document.getElementById('notify_on_success').value,
                tftp_server: document.getElementById('tftp_server').value,
                log_level: document.getElementById('log_level').value
            };

            fetch('/api/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(function (r) { return r.json(); })
                .then(function (resp) {
                    if (resp.error) {
                        alert('Error: ' + resp.error);
                    } else {
                        var indicator = document.getElementById('save-indicator');
                        indicator.style.display = 'inline';
                        setTimeout(function () { indicator.style.display = 'none'; }, 2000);
                    }
                });
        }
    </script>
</body>

</html>