{% extends "base.html" %}
{% block title %}Configuraci√≥n del Sistema{% endblock %}

{% block head %}
<style>
    .nav-tabs .nav-link {
        color: var(--text-muted);
    }

    .nav-tabs .nav-link.active {
        background: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .form-label {
        font-weight: 500;
    }

    .save-indicator {
        display: none;
        color: #28a745;
    }

    .auth-fields {
        transition: opacity 0.3s;
    }

    .auth-fields.disabled {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> Configuraci√≥n del Sistema</span>
        <span class="save-indicator" id="save-indicator">‚úì Guardado</span>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#backup">üìÖ
                    Backup</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#retention">üóÇÔ∏è
                    Retenci√≥n</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#email">üìß Email</button>
            </li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#system">üñ•Ô∏è
                    Sistema</button></li>
        </ul>

        <div class="tab-content p-4">
            <!-- Backup -->
            <div class="tab-pane fade show active" id="backup">
                <h5>Programaci√≥n de Backups</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Horario Global</label><input type="text"
                            class="form-control" id="global_schedule" placeholder="02:00, 14:00">
                        <div class="form-text">Separados por coma.</div>
                    </div>
                    <div class="col-md-6"><label class="form-label">Backups Autom√°ticos</label><select
                            class="form-select" id="backup_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select></div>
                </div>
            </div>
            <!-- Retention -->
            <div class="tab-pane fade" id="retention">
                <h5>Retenci√≥n</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">D√≠as de Retenci√≥n</label><input type="number"
                            class="form-control" id="archive_retention_days" min="7" max="365"></div>
                    <div class="col-md-6"><label class="form-label">Auto-Limpieza</label><select class="form-select"
                            id="cleanup_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select></div>
                </div>
            </div>
            <!-- Email -->
            <div class="tab-pane fade" id="email">
                <h5>Configuraci√≥n SMTP Enterprise</h5>

                <!-- Estado -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="smtp_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select>
                    </div>
                </div>

                <!-- Servidor -->
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Servidor SMTP</label><input type="text"
                            class="form-control" id="smtp_host" placeholder="smtp.empresa.com"></div>
                    <div class="col-md-3"><label class="form-label">Puerto</label><input type="number"
                            class="form-control" id="smtp_port" placeholder="25" min="1" max="65535"></div>
                    <div class="col-md-3"><label class="form-label">Transporte</label>
                        <select class="form-select" id="smtp_transport">
                            <option value="plain">Plain (sin cifrado)</option>
                            <option value="starttls">STARTTLS</option>
                            <option value="ssl">SSL/TLS (465)</option>
                        </select>
                    </div>
                </div>

                <!-- From -->
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Remitente (From)</label><input type="text"
                            class="form-control" id="smtp_from" placeholder="Backup System <alertas@empresa.com>"></div>
                    <div class="col-md-6"><label class="form-label">Timeout (seg)</label><input type="number"
                            class="form-control" id="smtp_timeout" placeholder="15" min="5" max="60"></div>
                </div>

                <!-- Auth Toggle -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Autenticaci√≥n</label>
                        <select class="form-select" id="smtp_auth" onchange="toggleAuthFields()">
                            <option value="false">Sin autenticaci√≥n</option>
                            <option value="true">Requiere autenticaci√≥n</option>
                        </select>
                    </div>
                </div>

                <!-- Auth Fields -->
                <div class="row mb-3 auth-fields" id="auth-fields">
                    <div class="col-md-6"><label class="form-label">Usuario</label><input type="text"
                            class="form-control" id="smtp_user"></div>
                    <div class="col-md-6"><label class="form-label">Contrase√±a</label><input type="password"
                            class="form-control" id="smtp_pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (dejar vac√≠o para mantener)">
                    </div>
                </div>

                <!-- Destinatarios -->
                <div class="mb-3"><label class="form-label">Destinatarios (CSV)</label><input type="text"
                        class="form-control" id="email_recipients" placeholder="noc@empresa.com, admin@empresa.com">
                    <div class="form-text">Separar m√∫ltiples emails con coma.</div>
                </div>

                <!-- Notificaciones -->
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Notificar en Errores</label><select
                            class="form-select" id="notify_on_error">
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select></div>
                    <div class="col-md-6"><label class="form-label">Notificar en √âxito</label><select
                            class="form-select" id="notify_on_success">
                            <option value="false">No</option>
                            <option value="true">S√≠</option>
                        </select></div>
                </div>

                <!-- Test Email -->
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-outline-primary" onclick="sendTestEmail()" id="btn-test-email">
                        üìß Enviar Email de Prueba
                    </button>
                    <span id="test-email-result" class="align-self-center"></span>
                </div>
            </div>
            <!-- System -->
            <div class="tab-pane fade" id="system">
                <h5>Sistema</h5>
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Servidor TFTP/FTP</label><input type="text"
                            class="form-control" id="tftp_server" placeholder="200.2.124.167">
                        <div class="form-text">IP p√∫blica del servidor de backup (la que ven los equipos remotos).</div>
                    </div>
                    <div class="col-md-6"><label class="form-label">Nivel de Log</label><select class="form-select"
                            id="log_level">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select></div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Guardar Configuraci√≥n</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var settings = {{ settings | tojson | safe }};

    document.addEventListener('DOMContentLoaded', function () {
        loadSettingsToForm();
        toggleAuthFields();
    });

    function loadSettingsToForm() {
        ['global_schedule', 'backup_enabled', 'archive_retention_days', 'cleanup_enabled',
            'smtp_enabled', 'smtp_host', 'smtp_port', 'smtp_from', 'smtp_transport', 'smtp_auth',
            'smtp_user', 'smtp_timeout', 'email_recipients',
            'notify_on_error', 'notify_on_success', 'tftp_server', 'log_level'].forEach(f => {
                var el = document.getElementById(f);
                if (el && settings[f] !== undefined) el.value = settings[f];
            });
    }

    function toggleAuthFields() {
        var authEnabled = document.getElementById('smtp_auth').value === 'true';
        var authFields = document.getElementById('auth-fields');
        if (authEnabled) {
            authFields.classList.remove('disabled');
        } else {
            authFields.classList.add('disabled');
        }
    }

    function saveSettings() {
        var data = {
            global_schedule: document.getElementById('global_schedule').value,
            backup_enabled: document.getElementById('backup_enabled').value,
            archive_retention_days: document.getElementById('archive_retention_days').value,
            cleanup_enabled: document.getElementById('cleanup_enabled').value,
            smtp_enabled: document.getElementById('smtp_enabled').value,
            smtp_host: document.getElementById('smtp_host').value,
            smtp_port: document.getElementById('smtp_port').value,
            smtp_from: document.getElementById('smtp_from').value,
            smtp_transport: document.getElementById('smtp_transport').value,
            smtp_auth: document.getElementById('smtp_auth').value,
            smtp_user: document.getElementById('smtp_user').value,
            smtp_pass: document.getElementById('smtp_pass').value,
            smtp_timeout: document.getElementById('smtp_timeout').value,
            email_recipients: document.getElementById('email_recipients').value,
            notify_on_error: document.getElementById('notify_on_error').value,
            notify_on_success: document.getElementById('notify_on_success').value,
            tftp_server: document.getElementById('tftp_server').value,
            log_level: document.getElementById('log_level').value
        };

        fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(r => r.json())
            .then(resp => {
                if (resp.error) alert('Error: ' + resp.error);
                else {
                    var ind = document.getElementById('save-indicator');
                    ind.style.display = 'inline';
                    setTimeout(() => ind.style.display = 'none', 2000);
                }
            });
    }

    function sendTestEmail() {
        var btn = document.getElementById('btn-test-email');
        var result = document.getElementById('test-email-result');
        btn.disabled = true;
        result.innerHTML = '<span class="text-muted">Enviando...</span>';

        fetch('/api/settings/test-email', { method: 'POST' })
            .then(r => r.json())
            .then(resp => {
                btn.disabled = false;
                if (resp.status === 'ok') {
                    result.innerHTML = '<span class="text-success">‚úì ' + resp.message + '</span>';
                } else {
                    result.innerHTML = '<span class="text-danger">‚úó ' + resp.message + '</span>';
                }
                setTimeout(() => result.innerHTML = '', 5000);
            })
            .catch(err => {
                btn.disabled = false;
                result.innerHTML = '<span class="text-danger">‚úó Error de conexi√≥n</span>';
            });
    }
</script>
{% endblock %}