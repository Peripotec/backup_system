{% extends "base.html" %}
{% block title %}Configuraci√≥n del Sistema{% endblock %}

{% block head %}
<style>
    .nav-tabs .nav-link {
        color: var(--text-muted);
    }

    .nav-tabs .nav-link.active {
        background: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-color);
    }

    .form-label {
        font-weight: 500;
    }

    .save-indicator {
        display: none;
        color: var(--ds-success);
    }

    .auth-fields {
        transition: opacity 0.3s;
    }

    .auth-fields.disabled {
        opacity: 0.5;
        pointer-events: none;
    }

    .schedule-section {
        border-left: 3px solid var(--border-color);
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }

    .schedule-section h6 {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .backup-disabled .schedule-inputs {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-gear"></i> Configuraci√≥n del Sistema</span>
        <span class="save-indicator" id="save-indicator">‚úì Guardado</span>
    </div>
    <div class="card-body">
        <!-- TABS UNIFICADOS: Backup (todo) + Email -->
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#backup">üìÖ
                    Backup</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#email">üìß Email</button>
            </li>
        </ul>

        <div class="tab-content p-4">
            <!-- ======================== -->
            <!-- TAB: BACKUP (UNIFICADO) -->
            <!-- ======================== -->
            <div class="tab-pane fade show active" id="backup">

                <!-- Secci√≥n: Estado Global -->
                <div class="mb-4">
                    <h5>üîß Estado Global</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Backups Autom√°ticos</label>
                            <select class="form-select" id="backup_enabled" onchange="toggleBackupState()">
                                <option value="true">Habilitado</option>
                                <option value="false">Deshabilitado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Secci√≥n: Programaci√≥n -->
                <div class="mb-4 schedule-inputs" id="schedule-section">
                    <h5>üìÖ Programaci√≥n</h5>

                    <!-- Schedule Global (Fallback) -->
                    <div class="schedule-section">
                        <h6>Horario Global (Fallback)</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="global_schedule" placeholder="02:00, 14:00"
                                    pattern="^(\d{2}:\d{2})(,\s*\d{2}:\d{2})*$">
                                <div class="form-text">Formato: HH:MM separados por coma. Se usa cuando no hay schedule
                                    espec√≠fico.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule por Vendor -->
                    <div class="schedule-section">
                        <h6>Horarios por Vendor (Opcional)</h6>
                        {% if vendors %}
                        <div class="row g-2 mb-2">
                            {% for vendor in vendors %}
                            <div class="col-md-3">
                                <input type="text" class="form-control vendor-schedule"
                                    id="schedule_vendor_{{ vendor|lower|replace(' ', '_') }}" data-vendor="{{ vendor }}"
                                    placeholder="HH:MM, HH:MM">
                                <small class="text-muted">{{ vendor }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning">No hay vendors detectados en el inventario.</div>
                        {% endif %}
                        <div class="form-text">Los vendors con schedule espec√≠fico se ejecutan en esos horarios. Los
                            vac√≠os
                            usan el global.</div>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <strong>Herencia de Schedules:</strong> Device ‚Üí Modelo ‚Üí Vendor ‚Üí Global.<br>
                        Cada nivel m√°s espec√≠fico sobreescribe al anterior. Los schedules de Device se configuran en el
                        Inventario.
                    </div>
                </div>

                <hr>

                <!-- Secci√≥n: Retenci√≥n -->
                <div class="mb-4 schedule-inputs">
                    <h5>üóÇÔ∏è Retenci√≥n y Limpieza</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">D√≠as de Retenci√≥n</label>
                            <input type="number" class="form-control" id="archive_retention_days" min="7" max="365"
                                value="90">
                            <div class="form-text">M√≠nimo 7 d√≠as. Los archivos m√°s antiguos se eliminan autom√°ticamente.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Auto-Limpieza</label>
                            <select class="form-select" id="cleanup_enabled">
                                <option value="true">Habilitado</option>
                                <option value="false">Deshabilitado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Secci√≥n: Sistema -->
                <div class="mb-4">
                    <h5>üñ•Ô∏è Sistema</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Servidor TFTP/FTP</label>
                            <input type="text" class="form-control" id="tftp_server" placeholder="200.2.124.167">
                            <div class="form-text">IP p√∫blica del servidor (la que ven los equipos remotos).</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nivel de Log</label>
                            <select class="form-select" id="log_level">
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======================== -->
            <!-- TAB: EMAIL -->
            <!-- ======================== -->
            <div class="tab-pane fade" id="email">
                <h5>üìß Configuraci√≥n SMTP Enterprise</h5>

                <!-- Estado -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Notificaciones por Email</label>
                        <select class="form-select" id="smtp_enabled">
                            <option value="true">Habilitado</option>
                            <option value="false">Deshabilitado</option>
                        </select>
                    </div>
                </div>

                <!-- Servidor -->
                <div class="row mb-3">
                    <div class="col-md-4"><label class="form-label">Servidor SMTP</label>
                        <input type="text" class="form-control" id="smtp_host" placeholder="smtp.empresa.com">
                    </div>
                    <div class="col-md-2"><label class="form-label">Puerto</label>
                        <input type="number" class="form-control" id="smtp_port" placeholder="25" min="1" max="65535">
                    </div>
                    <div class="col-md-3"><label class="form-label">Transporte</label>
                        <select class="form-select" id="smtp_transport">
                            <option value="plain">Plain (sin cifrado)</option>
                            <option value="starttls">STARTTLS</option>
                            <option value="ssl">SSL/TLS (465)</option>
                        </select>
                    </div>
                    <div class="col-md-2"><label class="form-label">Timeout (seg)</label>
                        <input type="number" class="form-control" id="smtp_timeout" placeholder="15" min="5" max="60">
                    </div>
                </div>

                <!-- From -->
                <div class="row mb-3">
                    <div class="col-md-6"><label class="form-label">Remitente (From)</label>
                        <input type="text" class="form-control" id="smtp_from"
                            placeholder="Sistema de Backup <alertas@empresa.com>">
                    </div>
                </div>

                <!-- Auth Toggle -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Autenticaci√≥n</label>
                        <select class="form-select" id="smtp_auth" onchange="toggleAuthFields()">
                            <option value="false">Sin autenticaci√≥n</option>
                            <option value="true">Requiere autenticaci√≥n</option>
                        </select>
                    </div>
                </div>

                <!-- Auth Fields -->
                <div class="row mb-3 auth-fields" id="auth-fields">
                    <div class="col-md-4"><label class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="smtp_user">
                    </div>
                    <div class="col-md-4"><label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-control" id="smtp_pass"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (vac√≠o para mantener)">
                    </div>
                </div>

                <!-- Destinatarios -->
                <div class="mb-3">
                    <label class="form-label">Destinatarios (CSV)</label>
                    <input type="text" class="form-control" id="email_recipients"
                        placeholder="noc@empresa.com, admin@empresa.com">
                    <div class="form-text">Separar m√∫ltiples emails con coma.</div>
                </div>

                <!-- Notificaciones -->
                <div class="row mb-3">
                    <div class="col-md-4"><label class="form-label">Notificar en Errores</label>
                        <select class="form-select" id="notify_on_error">
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="col-md-4"><label class="form-label">Notificar en √âxito</label>
                        <select class="form-select" id="notify_on_success">
                            <option value="false">No</option>
                            <option value="true">S√≠</option>
                        </select>
                    </div>
                </div>

                <!-- Test Email -->
                <div class="d-flex gap-2 mt-4">
                    {% if can_test_email %}
                    <button class="btn btn-outline-primary" onclick="sendTestEmail()" id="btn-test-email">
                        üìß Enviar Email de Prueba
                    </button>
                    {% else %}
                    <button class="btn btn-outline-secondary" disabled
                        title="No ten√©s permisos para enviar emails de prueba">
                        üìß Enviar Email de Prueba
                    </button>
                    {% endif %}
                    <span id="test-email-result" class="align-self-center"></span>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="saveSettings()" id="btn-save">üíæ Guardar Configuraci√≥n</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var settings = {{ settings | tojson | safe }};

    document.addEventListener('DOMContentLoaded', function () {
        loadSettingsToForm();
        toggleAuthFields();
        toggleBackupState();
    });

    function loadSettingsToForm() {
        // Campos principales
        // Campos fijos
        ['global_schedule', 'backup_enabled', 'archive_retention_days', 'cleanup_enabled',
            'smtp_enabled', 'smtp_host', 'smtp_port', 'smtp_from', 'smtp_transport', 'smtp_auth',
            'smtp_user', 'smtp_timeout', 'email_recipients',
            'notify_on_error', 'notify_on_success', 'tftp_server', 'log_level'
        ].forEach(f => {
            var el = document.getElementById(f);
            if (el && settings[f] !== undefined) el.value = settings[f];
        });

        // Cargar vendors din√°micamente
        document.querySelectorAll('.vendor-schedule').forEach(el => {
            var key = el.id; // e.g. schedule_vendor_huawei
            if (settings[key] !== undefined) el.value = settings[key];
        });
    }

    function toggleAuthFields() {
        var authEnabled = document.getElementById('smtp_auth').value === 'true';
        var authFields = document.getElementById('auth-fields');
        authFields.classList.toggle('disabled', !authEnabled);
    }

    function toggleBackupState() {
        var backupEnabled = document.getElementById('backup_enabled').value === 'true';
        var section = document.getElementById('schedule-section');
        section.classList.toggle('disabled', !backupEnabled);
    }

    function validateSchedule(value) {
        if (!value.trim()) return true; // Empty is OK
        var parts = value.split(',');
        for (var i = 0; i < parts.length; i++) {
            var p = parts[i].trim();
            if (!/^\d{2}:\d{2}$/.test(p)) return false;
            var h = parseInt(p.substring(0, 2));
            var m = parseInt(p.substring(3, 5));
            if (h < 0 || h > 23 || m < 0 || m > 59) return false;
        }
        return true;
    }

    function saveSettings() {
        var btn = document.getElementById('btn-save');
        btn.disabled = true;
        btn.textContent = '‚è≥ Guardando...';

        // Validate global schedule
        if (!validateSchedule(document.getElementById('global_schedule').value)) {
            alert('Error: Formato de horario inv√°lido en global_schedule. Use HH:MM separados por coma.');
            btn.disabled = false;
            btn.textContent = 'üíæ Guardar Configuraci√≥n';
            return;
        }

        // Validate vendor schedules din√°micamente
        var vendorScheduleError = false;
        document.querySelectorAll('.vendor-schedule').forEach(el => {
            if (!validateSchedule(el.value)) {
                alert('Error: Formato de horario inv√°lido en ' + el.dataset.vendor + '. Use HH:MM separados por coma.');
                vendorScheduleError = true;
            }
        });
        if (vendorScheduleError) {
            btn.disabled = false;
            btn.textContent = 'üíæ Guardar Configuraci√≥n';
            return;
        }

        var data = {
            global_schedule: document.getElementById('global_schedule').value,
            backup_enabled: document.getElementById('backup_enabled').value,
            archive_retention_days: document.getElementById('archive_retention_days').value,
            cleanup_enabled: document.getElementById('cleanup_enabled').value,
            smtp_enabled: document.getElementById('smtp_enabled').value,
            smtp_host: document.getElementById('smtp_host').value,
            smtp_port: document.getElementById('smtp_port').value,
            smtp_from: document.getElementById('smtp_from').value,
            smtp_transport: document.getElementById('smtp_transport').value,
            smtp_auth: document.getElementById('smtp_auth').value,
            smtp_user: document.getElementById('smtp_user').value,
            smtp_pass: document.getElementById('smtp_pass').value,
            smtp_timeout: document.getElementById('smtp_timeout').value,
            email_recipients: document.getElementById('email_recipients').value,
            notify_on_error: document.getElementById('notify_on_error').value,
            notify_on_success: document.getElementById('notify_on_success').value,
            tftp_server: document.getElementById('tftp_server').value,
            log_level: document.getElementById('log_level').value
        };

        // Agregar vendor schedules din√°micamente
        document.querySelectorAll('.vendor-schedule').forEach(el => {
            data[el.id] = el.value;
        });

        fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(r => r.json())
            .then(resp => {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar Configuraci√≥n';
                if (resp.error) {
                    alert('Error: ' + resp.error);
                } else {
                    var ind = document.getElementById('save-indicator');
                    ind.style.display = 'inline';
                    setTimeout(() => ind.style.display = 'none', 2000);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = 'üíæ Guardar Configuraci√≥n';
                alert('Error de conexi√≥n');
            });
    }

    function sendTestEmail() {
        var btn = document.getElementById('btn-test-email');
        var result = document.getElementById('test-email-result');
        btn.disabled = true;
        result.innerHTML = '<span class="text-muted">Enviando...</span>';

        fetch('/api/settings/test-email', { method: 'POST' })
            .then(r => r.json())
            .then(resp => {
                btn.disabled = false;
                if (resp.status === 'ok') {
                    result.innerHTML = '<span class="text-success">‚úì ' + resp.message + '</span>';
                } else {
                    result.innerHTML = '<span class="text-danger">‚úó ' + resp.message + '</span>';
                }
                setTimeout(() => result.innerHTML = '', 5000);
            })
            .catch(err => {
                btn.disabled = false;
                result.innerHTML = '<span class="text-danger">‚úó Error de conexi√≥n</span>';
            });
    }
</script>
{% endblock %}