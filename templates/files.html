<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Explorador de Archivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa;
            --card-bg: #fff;
            --text: #212529;
            --muted: #6c757d;
        }

        [data-theme="dark"] {
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #e9ecef;
            --muted: #adb5bd;
        }

        body {
            background: var(--bg);
            color: var(--text);
        }

        .card {
            background: var(--card-bg);
            border: none;
        }

        .text-muted {
            color: var(--muted) !important;
        }

        .file-item {
            cursor: pointer;
        }

        .file-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .file-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .file-content {
            font-family: monospace;
            font-size: 11px;
            background: #0d1117;
            color: #d4d4d4;
        }

        .delete-btn {
            opacity: 0.5;
        }

        .delete-btn:hover {
            opacity: 1;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.2rem;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üõ°Ô∏è Backup System</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/inventory">Inventario</a></li>
                <li class="nav-item"><a class="nav-link active" href="/files">Archivos</a></li>
                <li class="nav-item ms-3"><span class="nav-link theme-toggle" onclick="toggleTheme()">üåì</span></li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">üìÅ Explorador</div>
                    <div class="card-body p-2">
                        <input type="text" class="form-control form-control-sm mb-2" id="search-input"
                            placeholder="üîç Buscar..." onkeyup="filterFiles()">
                        <nav>
                            <ol class="breadcrumb bg-light p-2 rounded mb-0" id="breadcrumb">
                                <li class="breadcrumb-item"><a href="#" onclick="loadFiles('')">archive</a></li>
                            </ol>
                        </nav>
                    </div>
                    <ul class="list-group list-group-flush" id="file-list" style="max-height: 500px; overflow-y: auto;">
                    </ul>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center" id="viewer-header">
                        <span>Selecciona un archivo</span>
                        <div>
                            <a href="#" class="btn btn-primary btn-sm" id="download-btn" style="display:none;">‚¨áÔ∏è
                                Descargar</a>
                            <button class="btn btn-outline-danger btn-sm" id="delete-btn" style="display:none;"
                                onclick="confirmDelete()">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <pre class="file-content p-3 m-0" id="file-content"
                            style="max-height: 600px; overflow: auto;">Selecciona un archivo de la lista...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>¬°ATENCI√ìN!</strong> Esta acci√≥n es <strong>IRREVERSIBLE</strong>.
                    </div>
                    <p>Est√° a punto de eliminar:</p>
                    <p class="text-center"><code id="delete-target" class="fs-5"></code></p>
                    <p class="text-muted small">El archivo/carpeta ser√° eliminado permanentemente del servidor.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">üóëÔ∏è S√≠, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme
        function toggleTheme() {
            var t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }
        (function () { document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); })();

        let currentPath = '', allItems = [], selectedFile = '';
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        function updateBreadcrumb(path) {
            var html = '<li class="breadcrumb-item"><a href="#" onclick="loadFiles(\'\')">archive</a></li>';
            if (path) {
                var parts = path.split('/').filter(function (p) { return p; });
                var acc = '';
                parts.forEach(function (p, i) {
                    acc += (acc ? '/' : '') + p;
                    html += i === parts.length - 1
                        ? '<li class="breadcrumb-item active">' + p + '</li>'
                        : '<li class="breadcrumb-item"><a href="#" onclick="loadFiles(\'' + acc + '\')">' + p + '</a></li>';
                });
            }
            document.getElementById('breadcrumb').innerHTML = html;
        }

        function loadFiles(path) {
            currentPath = path;
            updateBreadcrumb(path);
            document.getElementById('search-input').value = '';

            var url = path ? '/api/files/list/' + path : '/api/files/list';
            fetch(url).then(function (r) { return r.json(); }).then(function (data) {
                if (data.error) {
                    document.getElementById('file-list').innerHTML = '<li class="list-group-item text-danger">' + data.error + '</li>';
                    return;
                }
                allItems = data.items || [];
                renderFiles(allItems);
            });
        }

        function renderFiles(items) {
            var list = document.getElementById('file-list');
            list.innerHTML = '';

            if (currentPath) {
                var parts = currentPath.split('/').filter(function (p) { return p; });
                parts.pop();
                var parent = parts.join('/');
                list.innerHTML += '<li class="list-group-item file-item" onclick="loadFiles(\'' + parent + '\')"><span class="text-primary">üìÅ ..</span></li>';
            }

            if (items.length === 0) {
                list.innerHTML += '<li class="list-group-item text-muted">Carpeta vac√≠a</li>';
                return;
            }

            var folders = items.filter(function (i) { return i.is_dir; });
            var files = items.filter(function (i) { return !i.is_dir; });

            folders.forEach(function (item) {
                var fp = currentPath ? currentPath + '/' + item.name : item.name;
                list.innerHTML += '<li class="list-group-item file-item d-flex justify-content-between align-items-center" onclick="loadFiles(\'' + fp + '\')"><span><span class="text-warning">üìÅ</span> <strong>' + item.name + '</strong></span><button class="btn btn-sm btn-outline-danger delete-btn py-0" onclick="event.stopPropagation(); prepareDelete(\'' + fp + '\', true)">üóëÔ∏è</button></li>';
            });

            files.forEach(function (item) {
                var fp = currentPath ? currentPath + '/' + item.name : item.name;
                var size = (item.size / 1024).toFixed(1);
                var date = item.mtime ? item.mtime.split('T')[0] : '';
                list.innerHTML += '<li class="list-group-item file-item d-flex justify-content-between align-items-center" onclick="loadFile(\'' + fp + '\')"><span><span class="text-secondary">üìÑ</span> ' + item.name + '</span><div><small class="text-muted me-2">' + size + ' KB</small><button class="btn btn-sm btn-outline-danger delete-btn py-0" onclick="event.stopPropagation(); prepareDelete(\'' + fp + '\', false)">üóëÔ∏è</button></div></li>';
            });
        }

        function filterFiles() {
            var q = document.getElementById('search-input').value.toLowerCase();
            renderFiles(q ? allItems.filter(function (i) { return i.name.toLowerCase().includes(q); }) : allItems);
        }

        function loadFile(path) {
            selectedFile = path;
            document.getElementById('viewer-header').querySelector('span').textContent = 'Cargando...';
            fetch('/api/files/content/' + path).then(function (r) { return r.json(); }).then(function (data) {
                document.getElementById('viewer-header').querySelector('span').textContent = data.filename || path.split('/').pop();
                document.getElementById('file-content').textContent = data.content || data.error || 'Sin contenido';
                document.getElementById('download-btn').href = '/download/' + path;
                document.getElementById('download-btn').style.display = 'inline-block';
                document.getElementById('delete-btn').style.display = 'inline-block';
            });
        }

        function confirmDelete() {
            prepareDelete(selectedFile, false);
        }

        function prepareDelete(path, isDir) {
            selectedFile = path;
            document.getElementById('delete-target').textContent = (isDir ? 'üìÅ ' : 'üìÑ ') + path;
            document.getElementById('confirm-delete-btn').onclick = function () { executeDelete(path); };
            deleteModal.show();
        }

        function executeDelete(path) {
            fetch('/api/files/delete/' + path, { method: 'DELETE' })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                    deleteModal.hide();
                    if (data.success) {
                        alert('‚úì ' + data.message);
                        loadFiles(currentPath);
                        document.getElementById('file-content').textContent = 'Archivo eliminado';
                        document.getElementById('delete-btn').style.display = 'none';
                        document.getElementById('download-btn').style.display = 'none';
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }

        loadFiles('');
    </script>
</body>

</html>