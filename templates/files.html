<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Archivos de Backup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .file-item:hover {
            background-color: #f8f9fa;
        }

        .file-content {
            font-family: monospace;
            font-size: 12px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">üõ°Ô∏è Backup System</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/inventory">Inventario</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/files">Archivos</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">üìÅ Explorador</div>
                    <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                        <nav aria-label="breadcrumb" class="p-2 border-bottom">
                            <ol class="breadcrumb mb-0" id="breadcrumb">
                                <li class="breadcrumb-item"><a href="#" onclick="loadFiles('')">archive</a></li>
                            </ol>
                        </nav>
                        <ul class="list-group list-group-flush" id="file-list"></ul>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header" id="viewer-header">Selecciona un archivo</div>
                    <div class="card-body">
                        <pre class="file-content p-3 rounded" id="file-content"
                            style="max-height: 500px; overflow: auto;">
Selecciona un archivo para ver su contenido...
                    </pre>
                        <a href="#" class="btn btn-primary mt-2" id="download-btn" style="display:none;">‚¨áÔ∏è
                            Descargar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPath = '';

        function loadFiles(path) {
            currentPath = path;
            const url = path ? '/api/files/list/' + path : '/api/files/list';
            console.log('Loading:', url);

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    console.log('Data:', data);
                    const list = document.getElementById('file-list');
                    list.innerHTML = '';

                    if (data.error) {
                        list.innerHTML = `<li class="list-group-item text-danger">${data.error}</li>`;
                        return;
                    }

                    // Back button
                    if (path) {
                        const parts = path.split('/').filter(p => p);
                        parts.pop();
                        const parent = parts.join('/');
                        list.innerHTML += `<li class="list-group-item file-item" style="cursor:pointer" onclick="loadFiles('${parent}')">üìÅ ..</li>`;
                    }

                    if (!data.items || data.items.length === 0) {
                        list.innerHTML += '<li class="list-group-item text-muted">Carpeta vac√≠a</li>';
                        return;
                    }

                    data.items.forEach(item => {
                        const fullPath = path ? path + '/' + item.name : item.name;
                        if (item.is_dir) {
                            list.innerHTML += `<li class="list-group-item file-item" style="cursor:pointer" onclick="loadFiles('${fullPath}')">üìÅ ${item.name}</li>`;
                        } else {
                            list.innerHTML += `<li class="list-group-item file-item" style="cursor:pointer" onclick="loadFile('${fullPath}')">üìÑ ${item.name} <small class="text-muted">(${(item.size / 1024).toFixed(1)} KB)</small></li>`;
                        }
                    });
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('file-list').innerHTML = '<li class="list-group-item text-danger">Error cargando archivos</li>';
                });
        }

        function loadFile(path) {
            fetch('/api/files/content/' + path)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('viewer-header').textContent = data.filename || 'Archivo';
                    document.getElementById('file-content').textContent = data.content || data.error || 'Sin contenido';
                    document.getElementById('download-btn').href = '/download/' + path;
                    document.getElementById('download-btn').style.display = 'inline-block';
                });
        }

        // Initial load
        loadFiles('');
    </script>

</body>

</html>