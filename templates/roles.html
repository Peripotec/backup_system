{% extends "base.html" %}
{% block title %}GestiÃ³n de Roles{% endblock %}

{% block head %}
<style>
    .role-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .role-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .role-emoji {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .role-name {
        font-size: 1.3rem;
        font-weight: 600;
        text-transform: capitalize;
    }

    .role-description {
        color: var(--text-muted);
        font-size: 0.9rem;
        min-height: 40px;
    }

    .role-badge-system {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .emoji-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        max-height: 150px;
        overflow-y: auto;
    }

    .emoji-option {
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 8px;
        transition: background 0.2s;
    }

    .emoji-option:hover {
        background: rgba(0, 0, 0, 0.1);
    }

    .emoji-option.selected {
        background: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-person-badge"></i> GestiÃ³n de Roles</h4>
    <button class="btn btn-primary" onclick="openAddModal()">â• Crear Rol</button>
</div>

<div class="row g-4" id="roles-grid"></div>

<div class="alert alert-info mt-4">
    <strong>â„¹ï¸ Nota:</strong> Los roles del sistema (marcados con ğŸ”’) no se pueden eliminar.
    Los permisos de cada rol determinan quÃ© puede hacer un usuario con ese rol.
</div>

<!-- Role Modal -->
<div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modal-title">ğŸ­ Editar Rol</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-mode" value="add">
                <input type="hidden" id="role-id" value="">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Rol *</label>
                            <input type="text" class="form-control" id="role-name" placeholder="ej: auditor">
                            <div class="form-text">Solo letras minÃºsculas, sin espacios</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">DescripciÃ³n</label>
                            <input type="text" class="form-control" id="role-description"
                                placeholder="DescripciÃ³n del rol">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Emoji</label>
                            <div class="emoji-picker" id="emoji-picker"></div>
                            <input type="hidden" id="role-emoji" value="ğŸ‘¤">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Permisos</label>
                        <div class="card p-3" style="max-height: 400px; overflow-y: auto;">
                            {% for category, permissions in permissions_catalog.items() %}
                            <div class="mb-2 {% if not loop.first %}mt-3{% endif %}">
                                <strong>
                                    {% if category == 'VisualizaciÃ³n' %}ğŸ“–{% elif category == 'EdiciÃ³n' %}âœï¸{% elif
                                    category == 'Email' %}ğŸ“§{% elif category == 'AdministraciÃ³n' %}ğŸ”{% endif %}
                                    {{ category }}
                                </strong>
                            </div>
                            {% for perm in permissions %}
                            <div class="form-check">
                                <input class="form-check-input perm-check" type="checkbox" id="perm-{{ perm.id }}"
                                    title="{{ perm.description }}">
                                <label class="form-check-label" for="perm-{{ perm.id }}">{{ perm.label }}</label>
                            </div>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="delete-btn-container"></span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveRole()">ğŸ’¾ Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var roles = {{ roles | tojson | safe }};
    var roleModal;
    // Generar lista de permisos desde el catÃ¡logo del backend
    var ALL_PERMISSIONS = [
        {% for cat, perms in permissions_catalog.items() %}
    {% for perm in perms %} '{{ perm.id }}'{% if not loop.last %}, {% endif %} {% endfor %} {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];
    var EMOJIS = ['ğŸ‘¤', 'ğŸ‘ï¸', 'ğŸ”§', 'âš™ï¸', 'ğŸ›¡ï¸', 'ğŸ­', 'ğŸ‘‘', 'ğŸ”', 'ğŸ“Š', 'ğŸ’¼', 'ğŸ”', 'ğŸ“', 'ğŸš€', 'â­', 'ğŸ’', 'ğŸ”®'];

    document.addEventListener('DOMContentLoaded', function () {
        roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
        renderRoles();
        renderEmojiPicker();
    });

    function renderEmojiPicker() {
        var container = document.getElementById('emoji-picker');
        container.innerHTML = '';
        EMOJIS.forEach(function (emoji) {
            var span = document.createElement('span');
            span.className = 'emoji-option';
            span.textContent = emoji;
            span.onclick = function () { selectEmoji(emoji); };
            container.appendChild(span);
        });
    }

    function selectEmoji(emoji) {
        document.getElementById('role-emoji').value = emoji;
        document.querySelectorAll('.emoji-option').forEach(function (el) {
            el.classList.remove('selected');
            if (el.textContent === emoji) el.classList.add('selected');
        });
    }

    function renderRoles() {
        var container = document.getElementById('roles-grid');
        container.innerHTML = '';
        roles.forEach(function (role) {
            var permCount = (role.permissions || []).length;
            var card = document.createElement('div');
            card.className = 'col-md-4 col-lg-3';
            card.innerHTML =
                '<div class="role-card position-relative" onclick="openEditModal(' + role.id + ')">' +
                (role.is_system ? '<span class="badge bg-secondary role-badge-system">ğŸ”’ Sistema</span>' : '') +
                '<div class="role-emoji">' + (role.emoji || 'ğŸ‘¤') + '</div>' +
                '<div class="role-name">' + role.name + '</div>' +
                '<div class="role-description">' + (role.description || '') + '</div>' +
                '<div class="mt-2"><span class="badge bg-primary">' + permCount + ' permisos</span></div></div>';
            container.appendChild(card);
        });
    }

    function openAddModal() {
        document.getElementById('edit-mode').value = 'add';
        document.getElementById('role-id').value = '';
        document.getElementById('modal-title').textContent = 'â• Crear Rol';
        document.getElementById('role-name').value = '';
        document.getElementById('role-name').disabled = false;
        document.getElementById('role-description').value = '';
        selectEmoji('ğŸ‘¤');
        clearPermissions();
        document.getElementById('delete-btn-container').innerHTML = '';
        roleModal.show();
    }

    function openEditModal(roleId) {
        var role = roles.find(function (r) { return r.id === roleId; });
        if (!role) return;
        document.getElementById('edit-mode').value = 'edit';
        document.getElementById('role-id').value = roleId;
        document.getElementById('modal-title').textContent = role.emoji + ' Editar: ' + role.name;
        document.getElementById('role-name').value = role.name;
        document.getElementById('role-name').disabled = role.is_system;
        document.getElementById('role-description').value = role.description || '';
        selectEmoji(role.emoji || 'ğŸ‘¤');
        setPermissions(role.permissions || []);

        var del = document.getElementById('delete-btn-container');
        del.innerHTML = role.is_system ? '' : '<button type="button" class="btn btn-danger me-auto" onclick="deleteRole(' + roleId + ')">ğŸ—‘ï¸ Eliminar</button>';
        roleModal.show();
    }

    function clearPermissions() { ALL_PERMISSIONS.forEach(function (p) { var cb = document.getElementById('perm-' + p); if (cb) cb.checked = false; }); }
    function setPermissions(perms) { ALL_PERMISSIONS.forEach(function (p) { var cb = document.getElementById('perm-' + p); if (cb) cb.checked = perms.includes(p); }); }
    function getSelectedPermissions() { var perms = []; ALL_PERMISSIONS.forEach(function (p) { var cb = document.getElementById('perm-' + p); if (cb && cb.checked) perms.push(p); }); return perms; }

    function saveRole() {
        var mode = document.getElementById('edit-mode').value;
        var data = {
            name: document.getElementById('role-name').value.trim().toLowerCase(),
            emoji: document.getElementById('role-emoji').value,
            description: document.getElementById('role-description').value.trim(),
            permissions: getSelectedPermissions()
        };
        if (!data.name) { alert('El nombre es requerido'); return; }

        var url = mode === 'add' ? '/api/roles' : '/api/roles/' + document.getElementById('role-id').value;
        fetch(url, { method: mode === 'add' ? 'POST' : 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(function (r) { return r.json(); })
            .then(function (resp) { if (resp.error) alert(resp.error); else location.reload(); });
    }

    function deleteRole(roleId) {
        var role = roles.find(function (r) { return r.id === roleId; });
        var nombre = role ? role.name : 'Rol #' + roleId;

        // Fetch dependencies first
        fetch('/api/dependencies/rol/' + nombre).then(function (r) { return r.json(); }).then(function (deps) {
            var depHtml = '';
            if (deps.count > 0) {
                depHtml = '<div class="alert alert-danger py-2 mb-2"><strong>âš ï¸ ' + deps.count + ' usuario(s) afectados:</strong><ul class="mb-0 small">';
                deps.dependencies.forEach(function (u) {
                    depHtml += '<li><code>' + u.username + '</code></li>';
                });
                if (deps.count > 10) depHtml += '<li>... y ' + (deps.count - 10) + ' mÃ¡s</li>';
                depHtml += '</ul></div>';
            }

            confirmAction({
                title: 'ğŸ—‘ï¸ Eliminar Rol',
                message: '<p>Â¿Eliminar el rol <strong>"' + nombre + '"</strong>?</p>' + depHtml,
                warning: deps.count > 0 ? 'âš ï¸ Los usuarios listados quedarÃ¡n sin rol asignado.' : 'âœ“ NingÃºn usuario tiene este rol.',
                buttonText: 'ğŸ—‘ï¸ Eliminar',
                buttonClass: 'btn-danger',
                onConfirm: function () {
                    fetch('/api/roles/' + roleId, { method: 'DELETE' })
                        .then(function (r) { return r.json(); })
                        .then(function (resp) { if (resp.error) alert(resp.error); else location.reload(); });
                }
            });
        });
    }
</script>
{% endblock %}