{% extends "base.html" %}
{% block title %}Dispositivos{% endblock %}

{% block head %}
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }

    .test-success {
        color: #22c55e;
    }

    .test-error {
        color: #ef4444;
    }

    .tag-badge {
        font-size: 0.75rem;
        margin-right: 3px;
    }

    .tag-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 5px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        min-height: 38px;
    }

    .tag-input-container input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
    }

    .tag-item {
        display: inline-flex;
        align-items: center;
        background: #0d6efd;
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    .tag-item .remove {
        cursor: pointer;
        margin-left: 5px;
    }

    .autocomplete-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%;
    }

    .autocomplete-item {
        padding: 5px 10px;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-hdd-network"></i> Dispositivos Registrados</span>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="group-by" style="width: auto;">
                <option value="group">Agrupar por: Grupo</option>
                <option value="localidad">Agrupar por: Localidad</option>
                <option value="tipo">Agrupar por: Tipo</option>
                <option value="vendor">Agrupar por: Vendor</option>
                <option value="criticidad">Agrupar por: Criticidad</option>
            </select>
            <button class="btn btn-light btn-sm" onclick="openAddDeviceModal()">‚ûï Agregar Dispositivo</button>
        </div>
    </div>
    <!-- Filter Bar Container -->
    <div id="filter-bar-container"></div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Sysname</th>
                    <th>Nombre</th>
                    <th>IP</th>
                    <th>Localidad</th>
                    <th>Tipo</th>
                    <th>Grupo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="device-table"></tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <small id="devices-info" class="text-muted">Cargando...</small>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white" id="device-modal-header">
                <h5 class="modal-title" id="device-modal-title">‚ûï Agregar Dispositivo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="device-edit-mode" value="add">
                <input type="hidden" id="device-original-group" value="">
                <input type="hidden" id="device-original-sysname" value="">

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Grupo *</label>
                            <select class="form-select" id="device-group" required onchange="onGroupChange()"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Sysname * (ID)</label>
                            <input type="text" class="form-control" id="device-sysname" required>
                            <div class="form-text text-warning" id="sysname-warning" style="display:none;">‚ö†Ô∏è Inmutable
                                una vez creado</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre (descripci√≥n)</label>
                            <input type="text" class="form-control" id="device-nombre" placeholder="Nombre descriptivo">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">IP *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="device-ip" placeholder="192.168.1.1"
                                    required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="testDeviceConnection()">üîå Test</button>
                            </div>
                            <div id="device-test-result" class="form-text"></div>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>üìç Segmentaci√≥n</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Localidad</label>
                            <select class="form-select" id="device-localidad"></select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="device-tipo"></select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Modelo</label>
                            <select class="form-select" id="device-modelo"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Criticidad</label>
                            <select class="form-select" id="device-criticidad">
                                <option value="">Sin definir</option>
                                <option value="alta">üî¥ Alta</option>
                                <option value="media">üü° Media</option>
                                <option value="baja">üü¢ Baja</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <div class="tag-input-container" id="tags-container">
                                <input type="text" id="tag-input" placeholder="Escriba y presione Enter...">
                            </div>
                            <div class="autocomplete-dropdown" id="tag-autocomplete" style="display:none;"></div>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>üîê Credenciales (override)</h6>
                <div id="device-credentials-container" class="ps-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()">üíæ Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/filter-bar.js"></script>
<script>
    var inventory = {{ inventory | tojson | safe }};
    var vaultCredentials = [], deviceTypes = [], deviceModels = [], localidades = [], existingTags = [];
    var selectedTags = [];
    var deviceModal;
    var filterBar;
    var currentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        deviceModal = new bootstrap.Modal(document.getElementById('deviceModal'));
        loadCatalogs();
        setupTagInput();
        initFilterBar();
    });

    function initFilterBar() {
        filterBar = new FilterBar({
            container: '#filter-bar-container',
            filters: [
                { id: 'localidad', label: 'üìç Localidad', type: 'select', options: 'dynamic' },
                { id: 'tipo', label: 'üè∑Ô∏è Tipo', type: 'select', options: 'dynamic' },
                { id: 'vendor', label: 'üè≠ Vendor', type: 'select', options: 'dynamic' },
                { id: 'grupo', label: 'üìÅ Grupo', type: 'select', options: 'dynamic' },
                {
                    id: 'criticidad', label: '‚ö†Ô∏è Criticidad', type: 'select', options: [
                        { value: 'alta', label: 'üî¥ Alta' },
                        { value: 'media', label: 'üü° Media' },
                        { value: 'baja', label: 'üü¢ Baja' }
                    ]
                }
            ],
            searchEnabled: true,
            searchPlaceholder: 'üîç Buscar sysname, IP...',
            onFilter: function (filters) {
                currentPage = 1;
                loadDevices();
            }
        });

        // Load filter options from API
        fetch('/api/filter-options').then(r => r.json()).then(opts => {
            filterBar.populateFilter('localidad', opts.localidades);
            filterBar.populateFilter('tipo', opts.tipos);
            filterBar.populateFilter('vendor', opts.vendors);
            filterBar.populateFilter('grupo', opts.grupos);

            // Initial load with URL params already applied by FilterBar
            loadDevices();
        });

        // Group by change
        document.getElementById('group-by').addEventListener('change', loadDevices);
    }

    function loadDevices(page) {
        if (page) currentPage = page;

        var groupBy = document.getElementById('group-by').value;
        var params = filterBar.buildQueryString({ page: currentPage, per_page: 50, group_by: groupBy });

        fetch('/api/devices?' + params).then(r => r.json()).then(data => {
            renderDevicesTable(data);
            renderPagination(data);
            filterBar.updateCount(data.total);
            document.getElementById('devices-info').textContent =
                'Mostrando ' + data.devices.length + ' de ' + data.total + ' (P√°g ' + data.page + '/' + data.pages + ')';
        });
    }

    function renderDevicesTable(data) {
        var tbody = document.getElementById('device-table');
        tbody.innerHTML = '';

        if (data.total === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No se encontraron dispositivos.</td></tr>';
            return;
        }

        // Render grouped
        Object.keys(data.grouped).sort().forEach(key => {
            var devices = data.grouped[key];
            tbody.innerHTML += '<tr class="table-secondary"><td colspan="7"><strong>' +
                key.charAt(0).toUpperCase() + key.slice(1) + '</strong> ' +
                '<span class="badge bg-secondary">' + devices.length + '</span></td></tr>';

            devices.forEach(d => {
                var sysname = d.sysname || d.hostname;
                var nombre = d.nombre || '';
                var localidad = d.localidad || '-';
                var tipo = d.tipo || '-';
                var critBadge = '';
                if (d.criticidad === 'alta') critBadge = ' <span class="badge bg-danger">Alta</span>';
                else if (d.criticidad === 'media') critBadge = ' <span class="badge bg-warning">Media</span>';

                tbody.innerHTML += '<tr>' +
                    '<td><strong>' + sysname + '</strong>' + critBadge + '</td>' +
                    '<td>' + nombre + '</td>' +
                    '<td><code>' + d.ip + '</code></td>' +
                    '<td>' + localidad + '</td>' +
                    '<td>' + tipo + '</td>' +
                    '<td><span class="badge bg-info">' + d.group_name + '</span></td>' +
                    '<td><span class="btn-action" onclick=\'openEditDeviceModal(' + JSON.stringify(d.group_name) + ', ' + JSON.stringify(d) + ')\'>‚úèÔ∏è</span>' +
                    '<span class="btn-action" onclick="deleteDevice(\'' + d.group_name + '\', \'' + sysname + '\')">üóëÔ∏è</span></td>' +
                    '</tr>';
            });
        });
    }

    function renderPagination(data) {
        var pg = document.getElementById('pagination');
        pg.innerHTML = '';
        if (data.pages <= 1) return;

        if (data.page > 1)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page - 1) + ')">¬´</a></li>';

        for (var i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++)
            pg.innerHTML += '<li class="page-item ' + (i === data.page ? 'active' : '') + '"><a class="page-link" href="#" onclick="loadDevices(' + i + ')">' + i + '</a></li>';

        if (data.page < data.pages)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page + 1) + ')">¬ª</a></li>';
    }

    function loadCatalogs() {
        fetch('/api/device_types').then(r => r.json()).then(d => { deviceTypes = d; renderTypeDropdown(); });
        fetch('/api/device_models').then(r => r.json()).then(d => { deviceModels = d; });
        fetch('/api/localidades').then(r => r.json()).then(d => { localidades = d; renderLocalidadDropdown(); });
        fetch('/api/tags').then(r => r.json()).then(d => { existingTags = d; });
    }

    function renderTypeDropdown() {
        var sel = document.getElementById('device-tipo');
        sel.innerHTML = '<option value="">Seleccionar...</option>' + deviceTypes.map(t => '<option value="' + t.id + '">' + t.name + '</option>').join('');
    }

    function renderLocalidadDropdown() {
        var sel = document.getElementById('device-localidad');
        sel.innerHTML = '<option value="">Seleccionar...</option>' + localidades.map(l => '<option value="' + l.id + '">' + l.name + (l.zona ? ' (' + l.zona + ')' : '') + '</option>').join('');
    }

    function onGroupChange() {
        var grp = document.getElementById('device-group').value;
        var gObj = inventory.groups.find(g => g.name === grp);
        var vendor = gObj ? gObj.vendor : null;
        var sel = document.getElementById('device-modelo');
        var filtered = vendor ? deviceModels.filter(m => m.vendor === vendor) : deviceModels;
        sel.innerHTML = '<option value="">Seleccionar...</option>' + filtered.map(m => '<option value="' + m.id + '">' + m.name + '</option>').join('');
    }

    // Populate group dropdown for modal (needed for Add/Edit)
    function populateGroupDropdown() {
        var gSel = document.getElementById('device-group');
        gSel.innerHTML = '';
        inventory.groups.forEach(g => {
            gSel.innerHTML += '<option value="' + g.name + '">' + g.name + ' (' + g.vendor + ')</option>';
        });
    }

    function setupTagInput() {
        var input = document.getElementById('tag-input');
        var dropdown = document.getElementById('tag-autocomplete');
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                addTag(this.value.trim());
                this.value = '';
                dropdown.style.display = 'none';
            }
        });
        input.addEventListener('input', function () {
            var val = this.value.toLowerCase();
            if (!val) { dropdown.style.display = 'none'; return; }
            var matches = existingTags.filter(t => t.toLowerCase().includes(val) && !selectedTags.includes(t));
            if (matches.length === 0) { dropdown.style.display = 'none'; return; }
            dropdown.innerHTML = matches.map(t => '<div class="autocomplete-item" onclick="addTag(\'' + t + '\')">' + t + '</div>').join('');
            dropdown.style.display = 'block';
        });
    }

    function addTag(tag) {
        if (selectedTags.includes(tag)) return;
        selectedTags.push(tag);
        renderTags();
        document.getElementById('tag-input').value = '';
        document.getElementById('tag-autocomplete').style.display = 'none';
    }

    function removeTag(tag) { selectedTags = selectedTags.filter(t => t !== tag); renderTags(); }

    function renderTags() {
        var container = document.getElementById('tags-container');
        var input = document.getElementById('tag-input');
        container.innerHTML = selectedTags.map(t => '<span class="tag-item">' + t + '<span class="remove" onclick="removeTag(\'' + t + '\')">√ó</span></span>').join('');
        container.appendChild(input);
    }

    function loadVaultCredentials() { return fetch('/api/vault').then(r => r.json()).then(data => { vaultCredentials = data; return data; }); }

    function renderDeviceCredentials(sel, grpCreds) {
        var c = document.getElementById('device-credentials-container'); sel = sel || []; grpCreds = grpCreds || [];
        if (vaultCredentials.length === 0) { c.innerHTML = '<div class="text-muted">No hay credenciales.</div>'; return; }
        c.innerHTML = '<div class="form-text mb-1"><small>Heredadas del grupo: ' + (grpCreds.join(', ') || 'ninguna') + '</small></div>' +
            vaultCredentials.map(cr => '<div class="form-check"><input class="form-check-input device-cred-check" type="checkbox" value="' + cr.id + '" id="dev-cred-' + cr.id + '" ' + (sel.indexOf(cr.id) >= 0 ? 'checked' : '') + '><label class="form-check-label" for="dev-cred-' + cr.id + '">' + cr.name + ' <span class="text-muted">(' + cr.user + ')</span></label></div>').join('');
    }

    function getSelectedDeviceCredentialIds() { return Array.from(document.querySelectorAll('.device-cred-check:checked')).map(cb => cb.value); }

    function openAddDeviceModal() {
        if (!inventory.groups || inventory.groups.length === 0) { alert('Primero cree un grupo'); return; }
        document.getElementById('device-edit-mode').value = 'add';
        document.getElementById('device-modal-title').textContent = '‚ûï Agregar Dispositivo';
        document.getElementById('device-modal-header').className = 'modal-header bg-primary text-white';
        document.getElementById('device-sysname').value = ''; document.getElementById('device-sysname').disabled = false;
        document.getElementById('sysname-warning').style.display = 'block';
        document.getElementById('device-nombre').value = '';
        document.getElementById('device-ip').value = '';
        document.getElementById('device-localidad').value = '';
        document.getElementById('device-tipo').value = '';
        document.getElementById('device-modelo').value = '';
        document.getElementById('device-criticidad').value = '';
        selectedTags = []; renderTags();
        document.getElementById('device-test-result').innerHTML = '';
        onGroupChange();
        loadVaultCredentials().then(() => { renderDeviceCredentials([], []); deviceModal.show(); });
    }

    function openEditDeviceModal(grp, device) {
        document.getElementById('device-edit-mode').value = 'edit';
        document.getElementById('device-original-group').value = grp;
        document.getElementById('device-original-sysname').value = device.sysname || device.hostname;
        document.getElementById('device-modal-title').textContent = '‚úèÔ∏è Editar Dispositivo';
        document.getElementById('device-modal-header').className = 'modal-header bg-warning text-dark';
        document.getElementById('device-group').value = grp;
        document.getElementById('device-sysname').value = device.sysname || device.hostname;
        document.getElementById('device-sysname').disabled = true;
        document.getElementById('sysname-warning').style.display = 'none';
        document.getElementById('device-nombre').value = device.nombre || '';
        document.getElementById('device-ip').value = device.ip;
        document.getElementById('device-localidad').value = device.localidad || '';
        document.getElementById('device-tipo').value = device.tipo || '';
        onGroupChange();
        setTimeout(() => { document.getElementById('device-modelo').value = device.modelo || ''; }, 100);
        document.getElementById('device-criticidad').value = device.criticidad || '';
        selectedTags = device.tags ? [...device.tags] : []; renderTags();
        document.getElementById('device-test-result').innerHTML = '';
        var gObj = inventory.groups.find(g => g.name === grp), gCreds = gObj ? (gObj.credential_ids || []) : [];
        loadVaultCredentials().then(() => { renderDeviceCredentials(device.credential_ids || [], gCreds); deviceModal.show(); });
    }

    function testDeviceConnection() {
        var ip = document.getElementById('device-ip').value.trim(), res = document.getElementById('device-test-result');
        if (!ip) { res.innerHTML = '<span class="test-error">Ingrese IP</span>'; return; }
        res.innerHTML = '<span class="text-muted">Probando...</span>';
        fetch('/api/inventory/test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip: ip, port: 23 }) })
            .then(r => r.json()).then(d => { res.innerHTML = d.success ? '<span class="test-success">‚úÖ ' + d.message + '</span>' : '<span class="test-error">‚ùå ' + d.error + '</span>'; });
    }

    function saveDevice() {
        var sysname = document.getElementById('device-sysname').value.trim();
        var nombre = document.getElementById('device-nombre').value.trim();
        var ip = document.getElementById('device-ip').value.trim();
        var grp = document.getElementById('device-group').value;
        var localidad = document.getElementById('device-localidad').value;
        var tipo = document.getElementById('device-tipo').value;
        var modelo = document.getElementById('device-modelo').value;
        var criticidad = document.getElementById('device-criticidad').value;
        var cids = getSelectedDeviceCredentialIds();

        if (!sysname || !ip) { alert('Sysname e IP son requeridos'); return; }

        var mode = document.getElementById('device-edit-mode').value;
        var data = {
            group: grp,
            sysname: sysname,
            hostname: sysname, // Compatibility
            nombre: nombre,
            ip: ip,
            localidad: localidad,
            tipo: tipo,
            modelo: modelo,
            criticidad: criticidad,
            tags: selectedTags,
            credential_ids: cids
        };

        if (mode === 'add') {
            fetch('/api/inventory/device', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        } else {
            var og = document.getElementById('device-original-group').value;
            var os = document.getElementById('device-original-sysname').value;
            fetch('/api/inventory/device/' + og + '/' + os, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        }
    }

    function deleteDevice(grp, sysname) {
        if (!confirm('¬øEliminar ' + sysname + '?')) return;
        fetch('/api/inventory/device/' + grp + '/' + sysname, { method: 'DELETE' }).then(r => r.json()).then(d => { d.error ? alert(d.error) : location.reload(); });
    }
</script>
{% endblock %}