{% extends "base.html" %}
{% block title %}Dispositivos{% endblock %}

{% block head %}
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }

    .test-success {
        color: #22c55e;
    }

    .test-error {
        color: #ef4444;
    }

    .tag-badge {
        font-size: 0.75rem;
        margin-right: 3px;
    }

    .tag-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 5px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        min-height: 38px;
    }

    .tag-input-container input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
    }

    .tag-item {
        display: inline-flex;
        align-items: center;
        background: #0d6efd;
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    .tag-item .remove {
        cursor: pointer;
        margin-left: 5px;
    }

    .autocomplete-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1000;
        width: 100%;
    }

    .autocomplete-item {
        padding: 5px 10px;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-hdd-network me-2"></i>Dispositivos Registrados</span>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="group-by" style="width: auto;">
                <option value="group">Agrupar por: Grupo</option>
                <option value="localidad">Agrupar por: Localidad</option>
                <option value="troncal">Agrupar por: Troncal</option>
                <option value="tipo">Agrupar por: Tipo</option>
                <option value="vendor">Agrupar por: Vendor</option>
                <option value="criticidad">Agrupar por: Criticidad</option>
            </select>
            <button class="btn btn-light btn-sm" onclick="openAddDeviceModal()"><i
                    class="bi bi-plus-lg me-1"></i>Agregar Dispositivo</button>
        </div>
    </div>
    <!-- Filter Bar Container -->
    <div id="filter-bar-container"></div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Dispositivo</th>
                    <th>IP</th>
                    <th>üìç Ubicaci√≥n</th>
                    <th>üîó Troncal</th>
                    <th>Equipo</th>
                    <th>Criticidad</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="device-table"></tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <small id="devices-info" class="text-muted">Cargando...</small>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white" id="device-modal-header">
                <h5 class="modal-title" id="device-modal-title">‚ûï Agregar Dispositivo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="device-edit-mode" value="add">
                <input type="hidden" id="device-original-group" value="">
                <input type="hidden" id="device-original-sysname" value="">

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Grupo *</label>
                            <select class="form-select" id="device-group" required onchange="onGroupChange()"></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Sysname * (ID)</label>
                            <input type="text" class="form-control" id="device-sysname" required>
                            <div class="form-text text-warning" id="sysname-warning" style="display:none;">‚ö†Ô∏è Inmutable
                                una vez creado</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre (descripci√≥n)</label>
                            <input type="text" class="form-control" id="device-nombre" placeholder="Nombre descriptivo">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">IP *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="device-ip" placeholder="192.168.1.1"
                                    required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="testDeviceConnection()">üîå Test</button>
                            </div>
                            <div id="device-test-result" class="form-text"></div>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>üìç Segmentaci√≥n</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Localidad</label>
                            <select class="form-select" id="device-localidad"></select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="device-tipo"></select>
                        </div>
                    </div>
                    <div class="col-md-3" id="device-vendor-container">
                        <div class="mb-3">
                            <label class="form-label">Vendor</label>
                            <select class="form-select" id="device-vendor"></select>
                            <div class="form-text">Vendor del dispositivo</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Modelo</label>
                            <select class="form-select" id="device-modelo"></select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Criticidad</label>
                            <select class="form-select" id="device-criticidad">
                                <option value="">Sin definir</option>
                                <option value="alta">üî¥ Alta</option>
                                <option value="media">üü° Media</option>
                                <option value="baja">üü¢ Baja</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <div class="tag-input-container" id="tags-container">
                                <input type="text" id="tag-input" placeholder="Escriba y presione Enter...">
                            </div>
                            <div class="autocomplete-dropdown" id="tag-autocomplete" style="display:none;"></div>
                            <div id="suggested-tags" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <hr>
                <h6>üîê Credenciales (override)</h6>
                <div id="device-credentials-container" class="ps-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveDevice()"><i
                        class="bi bi-floppy me-1"></i>Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/filter-bar.js"></script>
<script>
    var inventory = {{ inventory | tojson | safe }};
    var vaultCredentials = [], deviceTypes = [], deviceModels = [], localidades = [], existingTags = [];
    var selectedTags = [];
    var deviceModal;
    var filterBar;
    var currentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        deviceModal = new bootstrap.Modal(document.getElementById('deviceModal'));
        loadCatalogs();
        setupTagInput();
        initFilterBar();
    });

    function initFilterBar() {
        filterBar = new FilterBar({
            container: '#filter-bar-container',
            filters: [
                { id: 'localidad', label: 'üìç Localidad', type: 'select', options: 'dynamic' },
                { id: 'troncal', label: 'üîó Troncal', type: 'select', options: 'dynamic' },
                { id: 'tipo', label: 'üè∑Ô∏è Tipo', type: 'select', options: 'dynamic' },
                { id: 'vendor', label: 'üè≠ Vendor', type: 'select', options: 'dynamic' },
                { id: 'grupo', label: 'üìÅ Grupo', type: 'select', options: 'dynamic' },
                {
                    id: 'criticidad', label: '‚ö†Ô∏è Criticidad', type: 'select', options: [
                        { value: 'alta', label: 'üî¥ Alta' },
                        { value: 'media', label: 'üü° Media' },
                        { value: 'baja', label: 'üü¢ Baja' }
                    ]
                },
                { id: 'tag', label: 'üè∑Ô∏è Tag', type: 'select', options: 'dynamic' }
            ],
            searchEnabled: true,
            searchPlaceholder: 'üîç Buscar en todo...',
            onFilter: function (filters) {
                currentPage = 1;
                loadDevices();
            }
        });

        // Convert API options to FilterBar format {value, label}
        // Handles both strings and objects {id, name}
        function toFilterOptions(arr) {
            return (arr || [])
                .filter(v => v !== undefined && v !== null && v !== 'undefined')
                .map(v => {
                    if (typeof v === 'object' && v !== null) {
                        return { value: v.id || v.value || '', label: v.name || v.label || v.id || '' };
                    }
                    const str = String(v).trim();
                    return str ? { value: str, label: str.charAt(0).toUpperCase() + str.slice(1) } : null;
                })
                .filter(v => v !== null && v.value !== '');
        }

        // Load filter options from API
        fetch('/api/filter-options').then(r => r.json()).then(opts => {
            filterBar.populateFilter('localidad', toFilterOptions(opts.localidades));
            filterBar.populateFilter('troncal', toFilterOptions(opts.troncales));
            filterBar.populateFilter('tipo', toFilterOptions(opts.tipos));
            filterBar.populateFilter('vendor', toFilterOptions(opts.vendors));
            filterBar.populateFilter('grupo', toFilterOptions(opts.grupos));
            filterBar.populateFilter('tag', toFilterOptions(opts.tags));

            // Initial load with URL params already applied by FilterBar
            loadDevices();
        });

        // Group by change
        document.getElementById('group-by').addEventListener('change', loadDevices);
    }

    function loadDevices(page) {
        // Handle case when called from event listener (page would be an Event object)
        if (typeof page === 'number') {
            currentPage = page;
        } else if (page === undefined || page instanceof Event) {
            // Keep currentPage as is, or reset to 1 when filters/grouping change
            if (page instanceof Event) currentPage = 1;
        }

        var groupBy = document.getElementById('group-by').value;
        var params = filterBar.buildQueryString({ page: currentPage, per_page: 50, group_by: groupBy });

        fetch('/api/devices?' + params).then(r => r.json()).then(data => {
            renderDevicesTable(data);
            renderPagination(data);
            filterBar.updateCount(data.total);
            document.getElementById('devices-info').textContent =
                'Mostrando ' + data.devices.length + ' de ' + data.total + ' (P√°g ' + data.page + '/' + data.pages + ')';
        });
    }

    function renderDevicesTable(data) {
        var tbody = document.getElementById('device-table');
        tbody.innerHTML = '';

        if (data.total === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No se encontraron dispositivos.</td></tr>';
            return;
        }

        // Render grouped
        Object.keys(data.grouped).sort().forEach(key => {
            var devices = data.grouped[key];
            tbody.innerHTML += '<tr class="table-secondary"><td colspan="8"><strong>' +
                key.charAt(0).toUpperCase() + key.slice(1) + '</strong> ' +
                '<span class="badge bg-secondary">' + devices.length + '</span></td></tr>';

            devices.forEach(d => {
                var sysname = d.sysname || d.hostname;
                var nombre = d.nombre || sysname; // Si no hay nombre, mostrar sysname
                var sysnameSecondary = d.nombre ? '<br><small class="text-muted">' + sysname + '</small>' : '';

                // Criticidad badge con texto
                var critBadge = '';
                if (d.criticidad === 'alta') critBadge = '<span class="badge bg-danger">üî¥ Alta</span>';
                else if (d.criticidad === 'media') critBadge = '<span class="badge bg-warning text-dark">üü° Media</span>';
                else if (d.criticidad === 'baja') critBadge = '<span class="badge bg-success">üü¢ Baja</span>';

                // Ubicaci√≥n badges (clickeables para filtrar)
                var locBadge = d.localidad ?
                    '<span class="badge bg-info clickable-badge" onclick="quickFilter(\'localidad\', \'' + d.localidad + '\')" title="Filtrar por localidad">üìç' + d.localidad + '</span> ' : '';

                // Troncal badge
                var tronBadge = d.troncal ?
                    '<span class="badge bg-primary clickable-badge" onclick="quickFilter(\'troncal\', \'' + d.troncal + '\')" title="Filtrar por troncal">üîó' + d.troncal + '</span>' :
                    '<span class="text-muted">-</span>';

                // Equipo info
                var vendorBadge = '<span class="badge bg-secondary clickable-badge" onclick="quickFilter(\'vendor\', \'' + d.vendor + '\')" title="Filtrar por vendor">üè≠' + d.vendor + '</span>';
                var tipoBadge = d.tipo ? '<br><span class="badge bg-light text-dark clickable-badge" onclick="quickFilter(\'tipo\', \'' + d.tipo + '\')" title="Filtrar por tipo">' + d.tipo + '</span>' : '';
                var modeloInfo = d.modelo ? '<br><small class="text-muted">' + d.modelo + '</small>' : '';

                // Tags row (chips)
                var tagsHtml = '';
                if (d.tags && d.tags.length > 0) {
                    tagsHtml = d.tags.map(t =>
                        '<span class="badge bg-light text-dark clickable-badge me-1" onclick="quickFilter(\'tag\', \'' + t + '\')" title="Filtrar por tag">' + t + '</span>'
                    ).join('');
                }

                // Status toggle (enabled/disabled)
                var isEnabled = d.enabled !== false; // Default true if not set
                var statusBadge = isEnabled
                    ? '<span class="badge bg-success" style="cursor: pointer;" onclick="toggleDeviceEnabled(\'' + d.group_name + '\', \'' + sysname + '\', false)" title="Click para deshabilitar">‚úì Activo</span>'
                    : '<span class="badge bg-danger" style="cursor: pointer;" onclick="toggleDeviceEnabled(\'' + d.group_name + '\', \'' + sysname + '\', true)" title="Click para habilitar. Motivo: ' + (d.disabled_reason || 'N/A').replace(/'/g, "\\'") + '">‚úó Deshabilitado</span>';

                var rowClass = isEnabled ? '' : 'table-warning opacity-75';

                tbody.innerHTML += '<tr class="' + rowClass + '">' +
                    '<td style="padding-left: 24px;"><a href="#" onclick="openEditDeviceModal(\'' + d.group_name + '\', ' + JSON.stringify(d).replace(/"/g, '&quot;') + '); return false;"><strong>' + nombre + '</strong></a>' + sysnameSecondary +
                    (tagsHtml ? '<div class="mt-1">' + tagsHtml + '</div>' : '') + '</td>' +
                    '<td><code class="clickable-ip" onclick="copyToClipboard(\'' + d.ip + '\')" title="Click para copiar">' + d.ip + '</code></td>' +
                    '<td>' + locBadge + '</td>' +
                    '<td>' + tronBadge + '</td>' +
                    '<td>' + vendorBadge + tipoBadge + modeloInfo + '</td>' +
                    '<td class="text-center">' + critBadge + '</td>' +
                    '<td class="text-center">' + statusBadge + '</td>' +
                    '<td><span class="btn-action" onclick=\'openEditDeviceModal(' + JSON.stringify(d.group_name) + ', ' + JSON.stringify(d) + ')\' title="Editar"><i class="bi bi-pencil"></i></span>' +
                    '<span class="btn-action" onclick="deleteDevice(\'' + d.group_name + '\', \'' + sysname + '\')" title="Eliminar"><i class="bi bi-trash"></i></span></td>' +
                    '</tr>';
            });
        });
    }

    // Quick filter - click on badge to filter by that value
    function quickFilter(field, value) {
        filterBar.setFilter(field, value);
        loadDevices();
    }

    // Copy IP to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            var el = event.target;
            var original = el.textContent;
            el.textContent = '‚úì Copiado';
            el.classList.add('text-success');
            setTimeout(() => {
                el.textContent = original;
                el.classList.remove('text-success');
            }, 1000);
        });
    }

    function renderPagination(data) {
        var pg = document.getElementById('pagination');
        pg.innerHTML = '';
        if (data.pages <= 1) return;

        if (data.page > 1)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page - 1) + ')">¬´</a></li>';

        for (var i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++)
            pg.innerHTML += '<li class="page-item ' + (i === data.page ? 'active' : '') + '"><a class="page-link" href="#" onclick="loadDevices(' + i + ')">' + i + '</a></li>';

        if (data.page < data.pages)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page + 1) + ')">¬ª</a></li>';
    }

    function loadCatalogs() {
        fetch('/api/device_types').then(r => r.json()).then(d => { deviceTypes = d; renderTypeDropdown(); });
        fetch('/api/device_models').then(r => r.json()).then(d => { deviceModels = d; });
        fetch('/api/localidades').then(r => r.json()).then(d => { localidades = d; renderLocalidadDropdown(); });
        fetch('/api/tags').then(r => r.json()).then(d => { existingTags = d; });
        fetch('/api/vendors').then(r => r.json()).then(d => { renderVendorDropdown(d); });

        // Populate group dropdown from inventory
        renderGroupDropdown();

        // Vendor change listener for mixed groups
        var vendorSel = document.getElementById('device-vendor');
        if (vendorSel) vendorSel.addEventListener('change', updateModelDropdown);

        // Setup tag suggestion listeners
        setupTagSuggestionListeners();
    }

    function renderVendorDropdown(vendors) {
        var sel = document.getElementById('device-vendor');
        if (!sel) return;
        sel.innerHTML = '<option value="">Seleccionar vendor...</option>' +
            vendors.map(v => '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>').join('');
    }

    function renderGroupDropdown() {
        var sel = document.getElementById('device-group');
        if (!sel || !inventory.groups) return;
        sel.innerHTML = '<option value="">Seleccionar grupo...</option>' +
            inventory.groups.map(g => '<option value="' + g.name + '">' + g.name + '</option>').join('');
    }

    function onGroupChange() {
        var grpSel = document.getElementById('device-group');
        var vendorContainer = document.getElementById('device-vendor-container');
        if (!grpSel || !vendorContainer) return;

        var selectedGroupName = grpSel.value;
        var group = inventory.groups.find(g => g.name === selectedGroupName);

        // Show vendor selector for mixed groups (vendor is empty)
        if (group && !group.vendor) {
            vendorContainer.style.display = 'block';
        } else {
            vendorContainer.style.display = 'none';
        }
    }

    function renderTypeDropdown() {
        var sel = document.getElementById('device-tipo');
        sel.innerHTML = '<option value="">Seleccionar...</option>' + deviceTypes.map(t => '<option value="' + t.id + '">' + t.name + '</option>').join('');
    }

    // Fetch tag suggestions based on vendor/model context
    function showTagSuggestions() {
        var container = document.getElementById('suggested-tags');
        var vendorSel = document.getElementById('device-vendor');
        var modelSel = document.getElementById('device-modelo');

        var vendor = vendorSel ? vendorSel.value : '';
        var model = modelSel ? modelSel.value : '';

        // Need at least vendor or model
        if (!vendor && !model) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = '<small class="text-muted">Buscando tags...</small>';

        var params = [];
        if (vendor) params.push('vendor=' + encodeURIComponent(vendor));
        if (model) params.push('model=' + encodeURIComponent(model));

        fetch('/api/tags/suggestions?' + params.join('&'))
            .then(r => r.json())
            .then(suggestions => {
                if (!suggestions || suggestions.length === 0) {
                    container.innerHTML = '<small class="text-muted">No hay sugerencias para este vendor/modelo</small>';
                    return;
                }

                // Filter out already selected tags
                suggestions = suggestions.filter(s => !selectedTags.includes(s.tag));

                if (suggestions.length === 0) {
                    container.innerHTML = '<small class="text-muted">‚úì Ya tienes los tags m√°s usados</small>';
                    return;
                }

                container.innerHTML = '<small class="text-muted">Usados por equipos similares:</small> ' +
                    suggestions.map(s => '<span class="badge bg-light text-dark border me-1" style="cursor:pointer;" onclick="addTag(\'' + s.tag + '\'); showTagSuggestions();" title="Usado en ' + s.count + ' dispositivo(s)">' + s.tag + ' <small class="text-secondary">(' + s.count + ')</small></span>').join('');
            })
            .catch(() => {
                container.innerHTML = '';
            });
    }

    // Update suggestions when vendor or model changes
    function setupTagSuggestionListeners() {
        var vendorSel = document.getElementById('device-vendor');
        var modelSel = document.getElementById('device-modelo');
        if (vendorSel) vendorSel.addEventListener('change', showTagSuggestions);
        if (modelSel) modelSel.addEventListener('change', showTagSuggestions);
    }

    function renderLocalidadDropdown() {
        var sel = document.getElementById('device-localidad');
        sel.innerHTML = '<option value="">Seleccionar...</option>' + localidades.map(l => '<option value="' + l.id + '">' + l.name + (l.zona ? ' (' + l.zona + ')' : '') + '</option>').join('');
    }

    function onGroupChange() {
        var grp = document.getElementById('device-group').value;
        var vendorSel = document.getElementById('device-vendor');
        var gObj = inventory.groups.find(g => g.name === grp);
        var groupVendor = gObj ? gObj.vendor : '';

        // Pre-select group's vendor as default (but user can change it)
        if (groupVendor && vendorSel && !vendorSel.value) {
            vendorSel.value = groupVendor;
        }

        // Update model dropdown based on selected vendor
        updateModelDropdown();
    }

    function updateModelDropdown() {
        var vendorSel = document.getElementById('device-vendor');
        var vendor = vendorSel ? vendorSel.value : '';

        var sel = document.getElementById('device-modelo');
        var filtered = vendor ? deviceModels.filter(m => m.vendor === vendor) : deviceModels;
        sel.innerHTML = '<option value="">Seleccionar...</option>' + filtered.map(m => '<option value="' + m.id + '">' + m.name + '</option>').join('');
    }

    // Populate group dropdown for modal (needed for Add/Edit)
    function populateGroupDropdown() {
        var gSel = document.getElementById('device-group');
        gSel.innerHTML = '';
        inventory.groups.forEach(g => {
            gSel.innerHTML += '<option value="' + g.name + '">' + g.name + ' (' + g.vendor + ')</option>';
        });
    }

    function setupTagInput() {
        var input = document.getElementById('tag-input');
        var dropdown = document.getElementById('tag-autocomplete');
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && this.value.trim()) {
                e.preventDefault();
                addTag(this.value.trim());
                this.value = '';
                dropdown.style.display = 'none';
            }
        });
        input.addEventListener('input', function () {
            var val = this.value.toLowerCase();
            if (!val) { dropdown.style.display = 'none'; return; }
            var matches = existingTags.filter(t => t.toLowerCase().includes(val) && !selectedTags.includes(t));
            if (matches.length === 0) { dropdown.style.display = 'none'; return; }
            dropdown.innerHTML = matches.map(t => '<div class="autocomplete-item" onclick="addTag(\'' + t + '\')">' + t + '</div>').join('');
            dropdown.style.display = 'block';
        });
    }

    function addTag(tag) {
        if (selectedTags.includes(tag)) return;
        selectedTags.push(tag);
        renderTags();
        document.getElementById('tag-input').value = '';
        document.getElementById('tag-autocomplete').style.display = 'none';
    }

    function removeTag(tag) { selectedTags = selectedTags.filter(t => t !== tag); renderTags(); }

    function renderTags() {
        var container = document.getElementById('tags-container');
        var input = document.getElementById('tag-input');
        container.innerHTML = selectedTags.map(t => '<span class="tag-item">' + t + '<span class="remove" onclick="removeTag(\'' + t + '\')">√ó</span></span>').join('');
        container.appendChild(input);
    }

    function loadVaultCredentials() { return fetch('/api/vault').then(r => r.json()).then(data => { vaultCredentials = data; return data; }); }

    function renderDeviceCredentials(sel, grpCreds) {
        var c = document.getElementById('device-credentials-container'); sel = sel || []; grpCreds = grpCreds || [];
        if (vaultCredentials.length === 0) { c.innerHTML = '<div class="text-muted">No hay credenciales.</div>'; return; }
        c.innerHTML = '<div class="form-text mb-1"><small>Heredadas del grupo: ' + (grpCreds.join(', ') || 'ninguna') + '</small></div>' +
            vaultCredentials.map(cr => '<div class="form-check"><input class="form-check-input device-cred-check" type="checkbox" value="' + cr.id + '" id="dev-cred-' + cr.id + '" ' + (sel.indexOf(cr.id) >= 0 ? 'checked' : '') + '><label class="form-check-label" for="dev-cred-' + cr.id + '">' + cr.name + ' <span class="text-muted">(' + cr.user + ')</span></label></div>').join('');
    }

    function getSelectedDeviceCredentialIds() { return Array.from(document.querySelectorAll('.device-cred-check:checked')).map(cb => cb.value); }

    function openAddDeviceModal() {
        if (!inventory.groups || inventory.groups.length === 0) { alert('Primero cree un grupo'); return; }
        document.getElementById('device-edit-mode').value = 'add';
        document.getElementById('device-modal-title').innerHTML = '<i class="bi bi-plus-lg me-2"></i>Agregar Dispositivo';
        document.getElementById('device-modal-header').className = 'modal-header bg-primary text-white';
        document.getElementById('device-sysname').value = ''; document.getElementById('device-sysname').disabled = false;
        document.getElementById('sysname-warning').style.display = 'block';
        document.getElementById('device-nombre').value = '';
        document.getElementById('device-ip').value = '';
        document.getElementById('device-localidad').value = '';
        document.getElementById('device-tipo').value = '';
        document.getElementById('device-modelo').value = '';
        document.getElementById('device-criticidad').value = '';
        selectedTags = []; renderTags();
        document.getElementById('device-test-result').innerHTML = '';
        onGroupChange();
        loadVaultCredentials().then(() => { renderDeviceCredentials([], []); deviceModal.show(); });
    }

    function openEditDeviceModal(grp, device) {
        document.getElementById('device-edit-mode').value = 'edit';
        document.getElementById('device-original-group').value = grp;
        document.getElementById('device-original-sysname').value = device.sysname || device.hostname;
        document.getElementById('device-modal-title').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Dispositivo';
        document.getElementById('device-modal-header').className = 'modal-header bg-warning text-dark';
        document.getElementById('device-group').value = grp;
        document.getElementById('device-sysname').value = device.sysname || device.hostname;
        document.getElementById('device-sysname').disabled = true;
        document.getElementById('sysname-warning').style.display = 'none';
        document.getElementById('device-nombre').value = device.nombre || '';
        document.getElementById('device-ip').value = device.ip;
        document.getElementById('device-localidad').value = device.localidad || '';
        document.getElementById('device-tipo').value = device.tipo || '';
        document.getElementById('device-criticidad').value = device.criticidad || '';
        selectedTags = device.tags ? [...device.tags] : []; renderTags();
        document.getElementById('device-test-result').innerHTML = '';

        var gObj = inventory.groups.find(g => g.name === grp);
        var gCreds = gObj ? (gObj.credential_ids || []) : [];

        // Set vendor and modelo with a small delay to ensure dropdown is populated
        var deviceVendor = device.vendor || '';
        var deviceModelo = device.modelo || '';

        setTimeout(() => {
            var vendorSel = document.getElementById('device-vendor');
            if (vendorSel && deviceVendor) {
                // Always add the option if it doesn't exist (case-sensitive match)
                var hasOption = Array.from(vendorSel.options).some(o => o.value.toLowerCase() === deviceVendor.toLowerCase());
                if (!hasOption) {
                    vendorSel.innerHTML += '<option value="' + deviceVendor + '">' +
                        deviceVendor.charAt(0).toUpperCase() + deviceVendor.slice(1) + '</option>';
                }
                // Try to find matching option (case-insensitive)
                var matchingOption = Array.from(vendorSel.options).find(o => o.value.toLowerCase() === deviceVendor.toLowerCase());
                if (matchingOption) {
                    vendorSel.value = matchingOption.value;
                } else {
                    vendorSel.value = deviceVendor;
                }
            }

            // Update model dropdown and set value
            updateModelDropdown();
            setTimeout(() => {
                var modelSel = document.getElementById('device-modelo');
                if (modelSel && deviceModelo) {
                    // Check if option exists
                    var hasModelOption = Array.from(modelSel.options).some(o => o.value === deviceModelo);
                    if (!hasModelOption) {
                        // Add it if missing
                        modelSel.innerHTML += '<option value="' + deviceModelo + '">' + deviceModelo + '</option>';
                    }
                    modelSel.value = deviceModelo;
                }
            }, 50);
        }, 100);

        loadVaultCredentials().then(() => { renderDeviceCredentials(device.credential_ids || [], gCreds); deviceModal.show(); });
    }

    function testDeviceConnection() {
        var ip = document.getElementById('device-ip').value.trim(), res = document.getElementById('device-test-result');
        if (!ip) { res.innerHTML = '<span class="test-error">Ingrese IP</span>'; return; }
        res.innerHTML = '<span class="text-muted">Probando...</span>';
        fetch('/api/inventory/test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip: ip, port: 23 }) })
            .then(r => r.json()).then(d => { res.innerHTML = d.success ? '<span class="test-success">‚úÖ ' + d.message + '</span>' : '<span class="test-error">‚ùå ' + d.error + '</span>'; });
    }

    function saveDevice() {
        var sysname = document.getElementById('device-sysname').value.trim();
        var nombre = document.getElementById('device-nombre').value.trim();
        var ip = document.getElementById('device-ip').value.trim();
        var grp = document.getElementById('device-group').value;
        var vendorSel = document.getElementById('device-vendor');
        var vendor = vendorSel ? vendorSel.value : '';

        var localidad = document.getElementById('device-localidad').value;
        var tipo = document.getElementById('device-tipo').value;
        var modelo = document.getElementById('device-modelo').value;
        var criticidad = document.getElementById('device-criticidad').value;
        var cids = getSelectedDeviceCredentialIds();

        if (!sysname || !ip) { alert('Sysname e IP son requeridos'); return; }

        var mode = document.getElementById('device-edit-mode').value;
        var data = {
            group: grp,
            sysname: sysname,
            hostname: sysname, // Compatibility
            vendor: vendor,
            nombre: nombre,
            ip: ip,
            localidad: localidad,
            tipo: tipo,
            modelo: modelo,
            criticidad: criticidad,
            tags: selectedTags,
            credential_ids: cids
        };

        if (mode === 'add') {
            fetch('/api/inventory/device', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        } else {
            var og = document.getElementById('device-original-group').value;
            var os = document.getElementById('device-original-sysname').value;
            fetch('/api/inventory/device/' + og + '/' + os, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        }
    }

    function deleteDevice(grp, sysname) {
        // Fetch backup count first
        fetch('/api/dependencies/dispositivo/' + grp + '/' + sysname).then(r => r.json()).then(deps => {
            var backupHtml = '';
            if (deps.count > 0) {
                backupHtml = '<div class="alert alert-warning py-2 mb-2">' +
                    '<strong>üìÅ ' + deps.count + ' archivo(s) de backup:</strong>' +
                    '<ul class="mb-1 small">' + deps.dependencies.map(f => '<li>' + f + '</li>').join('') + '</ul>' +
                    '<a href="' + deps.download_url + '" target="_blank" class="btn btn-sm btn-outline-primary">üì• Ver/Descargar Backups</a>' +
                    '</div>';
            }

            confirmAction({
                title: 'üóëÔ∏è Eliminar Dispositivo',
                message: '<p>¬øEliminar el dispositivo <strong>"' + sysname + '"</strong> del grupo <code>' + grp + '</code>?</p>' + backupHtml,
                warning: deps.count > 0 ? '‚ö†Ô∏è Se perder√°n todos los backups mostrados. IRREVERSIBLE.' : '‚úì No hay backups para este dispositivo.',
                buttonText: 'üóëÔ∏è Eliminar Definitivamente',
                buttonClass: 'btn-danger',
                onConfirm: function () {
                    fetch('/api/inventory/device/' + grp + '/' + sysname, { method: 'DELETE' })
                        .then(r => r.json())
                        .then(d => { d.error ? alert(d.error) : location.reload(); });
                }
            });
        });
    }

    // Toggle device enabled/disabled status
    function toggleDeviceEnabled(groupName, sysname, enable) {
        if (enable) {
            // Enabling - simple confirmation
            confirmAction({
                title: '‚úì Habilitar Dispositivo',
                message: '<p>¬øHabilitar el dispositivo <strong>"' + sysname + '"</strong> para backups?</p>',
                warning: 'El dispositivo volver√° a incluirse en los backups programados.',
                buttonText: '‚úì Habilitar',
                buttonClass: 'btn-success',
                onConfirm: function () {
                    fetch('/api/inventory/device/' + groupName + '/' + sysname + '/toggle-enabled', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: true })
                    })
                        .then(r => r.json())
                        .then(d => {
                            if (d.error) {
                                alert(d.error);
                            } else {
                                loadDevices();
                            }
                        });
                }
            });
        } else {
            // Disabling - require reason
            // Use a custom modal with input field
            var modalHtml = `
                <div class="modal fade" id="disableDeviceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">‚ö†Ô∏è Deshabilitar Dispositivo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>¬øDeshabilitar el dispositivo <strong>"${sysname}"</strong>?</p>
                                <p class="text-muted small">El dispositivo ser√° excluido de todos los backups programados hasta que se vuelva a habilitar.</p>
                                <div class="mb-3">
                                    <label class="form-label"><strong>Motivo de deshabilitaci√≥n <span class="text-danger">*</span></strong></label>
                                    <textarea class="form-control" id="disable-reason" rows="3" 
                                        placeholder="Ej: Equipo en mantenimiento, Equipo dado de baja, Pendiente de reemplazo..." required></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-warning" id="confirm-disable-btn">‚ö†Ô∏è Deshabilitar</button>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Remove existing modal if present
            var existing = document.getElementById('disableDeviceModal');
            if (existing) existing.remove();

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            var modal = new bootstrap.Modal(document.getElementById('disableDeviceModal'));
            modal.show();

            // Handle confirm
            document.getElementById('confirm-disable-btn').onclick = function () {
                var reason = document.getElementById('disable-reason').value.trim();
                if (!reason) {
                    alert('El motivo es obligatorio');
                    document.getElementById('disable-reason').focus();
                    return;
                }

                fetch('/api/inventory/device/' + groupName + '/' + sysname + '/toggle-enabled', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false, reason: reason })
                })
                    .then(r => r.json())
                    .then(d => {
                        modal.hide();
                        if (d.error) {
                            alert(d.error);
                        } else {
                            loadDevices();
                        }
                    });
            };
        }
    }
</script>
{% endblock %}