{% extends "base.html" %}
{% block title %}BÃ³veda de Credenciales{% endblock %}

{% block head %}
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-key me-2"></i>BÃ³veda de Credenciales</span>
        <button class="btn btn-dark btn-sm" onclick="openAddModal()">â• Agregar Credencial</button>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Usuario</th>
                    <th>ContraseÃ±a</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="vault-table"></tbody>
        </table>
    </div>
</div>

<div class="alert alert-info mt-3">
    <strong>ğŸ’¡ Tip:</strong> Las credenciales se cifran y nunca se transmiten al navegador. SelecciÃ³nalas al crear
    grupos.
</div>

<!-- Modal -->
<div class="modal fade" id="credModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modal-title">â• Agregar Credencial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-mode" value="add">
                <input type="hidden" id="original-id" value="">
                <div class="mb-3"><label class="form-label">ID *</label><input type="text" class="form-control"
                        id="cred-id" placeholder="noc_standard" required>
                    <div class="form-text">Identificador Ãºnico (minÃºsculas)</div>
                </div>
                <div class="mb-3"><label class="form-label">Nombre *</label><input type="text" class="form-control"
                        id="cred-name" placeholder="NOC Standard" required></div>
                <hr>
                <div class="mb-3"><label class="form-label">Usuario</label><input type="text" class="form-control"
                        id="cred-user" placeholder="admin"></div>
                <div class="mb-3">
                    <label class="form-label">ContraseÃ±a</label>
                    <div class="input-group"><input type="password" class="form-control" id="cred-pass"><button
                            class="btn btn-outline-secondary" type="button"
                            onclick="togglePass('cred-pass')">ğŸ‘ï¸</button></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">ContraseÃ±a Extra (enable)</label>
                    <div class="input-group"><input type="password" class="form-control" id="cred-extra"><button
                            class="btn btn-outline-secondary" type="button"
                            onclick="togglePass('cred-extra')">ğŸ‘ï¸</button></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveCredential()">ğŸ’¾ Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar EliminaciÃ³n -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">âš ï¸ Confirmar EliminaciÃ³n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡s seguro de eliminar esta credencial?</p>
                <p class="mb-0"><strong>ID:</strong> <code id="delete-cred-id" class="fs-5"></code></p>
                <p><strong>Nombre:</strong> <span id="delete-cred-name"></span></p>
                <div id="delete-deps-container"></div>
                <div class="alert alert-warning mb-0" id="delete-warning">
                    <small>âš ï¸ Esta acciÃ³n no se puede deshacer.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">ğŸ—‘ï¸ Eliminar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var credentials = {{ credentials | tojson | safe }};
    var credModal;

    document.addEventListener('DOMContentLoaded', function () { credModal = new bootstrap.Modal(document.getElementById('credModal')); renderTable(); });

    function renderTable() {
        var tbody = document.getElementById('vault-table');
        tbody.innerHTML = '';
        if (!credentials || credentials.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay credenciales.</td></tr>'; return; }
        credentials.forEach(c => {
            tbody.innerHTML += '<tr><td><code>' + c.id + '</code></td><td><strong>' + c.name + '</strong></td><td>' + c.user + '</td><td><span class="text-muted">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span></td><td><span class="btn-action" onclick="openEditModal(\'' + c.id + '\')">âœï¸</span><span class="btn-action" onclick="deleteCredential(\'' + c.id + '\')">ğŸ—‘ï¸</span></td></tr>';
        });
    }

    function togglePass(id) { var f = document.getElementById(id); f.type = f.type === 'password' ? 'text' : 'password'; }

    function openAddModal() {
        document.getElementById('edit-mode').value = 'add';
        document.getElementById('modal-title').textContent = 'â• Agregar Credencial';
        document.getElementById('cred-id').value = ''; document.getElementById('cred-id').disabled = false;
        document.getElementById('cred-name').value = ''; document.getElementById('cred-user').value = '';
        document.getElementById('cred-pass').value = ''; document.getElementById('cred-extra').value = '';
        credModal.show();
    }

    function openEditModal(id) {
        var c = credentials.find(cr => cr.id === id); if (!c) return;
        document.getElementById('edit-mode').value = 'edit';
        document.getElementById('original-id').value = id;
        document.getElementById('modal-title').textContent = 'âœï¸ Editar Credencial';
        document.getElementById('cred-id').value = id; document.getElementById('cred-id').disabled = true;
        document.getElementById('cred-name').value = c.name; document.getElementById('cred-user').value = c.user;
        document.getElementById('cred-pass').value = ''; document.getElementById('cred-extra').value = '';
        credModal.show();
    }

    function saveCredential() {
        var id = document.getElementById('cred-id').value.trim().toLowerCase().replace(/\s+/g, '_');
        var name = document.getElementById('cred-name').value.trim();
        var user = document.getElementById('cred-user').value.trim();
        var pass = document.getElementById('cred-pass').value;
        var extra = document.getElementById('cred-extra').value;
        if (!id || !name) { alert('ID y Nombre requeridos'); return; }
        var mode = document.getElementById('edit-mode').value;
        var data = { id: id, name: name, user: user, pass: pass, extra_pass: extra };
        if (mode === 'add') {
            fetch('/api/vault', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        } else {
            var oid = document.getElementById('original-id').value;
            fetch('/api/vault/' + oid, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        }
    }

    var pendingDeleteId = null;
    var deleteModal;

    document.addEventListener('DOMContentLoaded', function () {
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        document.getElementById('confirm-delete-btn').onclick = function () {
            if (pendingDeleteId) {
                fetch('/api/vault/' + pendingDeleteId, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(resp => {
                        deleteModal.hide();
                        resp.error ? alert(resp.error) : location.reload();
                    });
            }
        };
    });

    function deleteCredential(id) {
        var c = credentials.find(cr => cr.id === id);
        document.getElementById('delete-cred-id').textContent = id;
        document.getElementById('delete-cred-name').textContent = c ? c.name : '';
        pendingDeleteId = id;

        // Fetch dependencies
        fetch('/api/dependencies/credencial/' + id).then(r => r.json()).then(deps => {
            var container = document.getElementById('delete-deps-container');
            var warning = document.getElementById('delete-warning');

            if (deps.count > 0) {
                var html = '<div class="alert alert-danger py-2 mb-2"><strong>âš ï¸ ' + deps.count + ' grupo(s) afectados:</strong><ul class="mb-0 small">';
                deps.dependencies.forEach(g => {
                    html += '<li><code>' + g.name + '</code> (' + g.device_count + ' dispositivos)</li>';
                });
                html += '</ul></div>';
                container.innerHTML = html;
                warning.innerHTML = '<small>âš ï¸ Los grupos listados perderÃ¡n acceso a sus dispositivos.</small>';
            } else {
                container.innerHTML = '';
                warning.innerHTML = '<small>âœ“ NingÃºn grupo usa esta credencial.</small>';
            }

            deleteModal.show();
        });
    }
</script>
{% endblock %}