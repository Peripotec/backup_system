{% extends "base.html" %}
{% block title %}Dashboard - Backups{% endblock %}

{% block head %}
<style>
    #directory-structure {
        padding: 15px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    #search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    #search-bar input {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background: var(--bg-card);
        color: var(--text-primary);
    }

    ul {
        list-style: none;
        padding-left: 20px;
        margin: 0;
    }

    li {
        padding: 8px 0;
        cursor: pointer;
    }

    .file {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 140px;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-card);
        text-align: center;
    }

    .file-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 0;
    }

    .file-size {
        font-size: 12px;
        color: var(--text-muted);
    }

    .file a {
        color: var(--accent);
        text-decoration: none;
        word-break: break-all;
    }

    .file a:hover {
        text-decoration: underline;
    }

    .directory::before {
        content: "ğŸ“ ";
    }
</style>
{% endblock %}

{% block content %}
<h4 class="mb-4"><i class="bi bi-speedometer2"></i> Dashboard de Backups</h4>

<div id="directory-structure">
    <div id="search-bar">
        <input type="text" id="search-input" placeholder="Buscar archivo..."
            onkeypress="if(event.key==='Enter')searchFiles()">
        <button class="btn btn-primary" onclick="searchFiles()"><i class="bi bi-search"></i> Buscar</button>
    </div>

    <div id="search-results" style="display: none;">
        <h5>ğŸ“ Resultados de bÃºsqueda</h5>
        <div class="file-grid" id="search-file-grid"></div>
    </div>

    <ul>
        <li onclick="toggleDirectory('recientes')">ğŸ“ Recientes</li>
        <li onclick="toggleDirectory('unicos')">ğŸ“ Ãšnicos</li>
        <li onclick="toggleDirectory('historico')">ğŸ“ HistÃ³rico</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allDirectories = {};

    function toggleDirectory(dirName, callback) {
        const containerId = `dir-${dirName}`;
        const container = document.getElementById(containerId);
        if (container) {
            container.remove();
            if (callback) callback();
            return;
        }
        fetch(`/directory?dir=${encodeURIComponent(dirName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) { alert(data.error); return; }
                const html = `
                <ul id="${containerId}">
                    ${data.directories.map(dir => `<li class="directory" onclick="toggleDirectory('${dirName}/${dir}')">${dir}</li>`).join('')}
                    <div class="file-grid">
                        ${data.files.map(file => `
                            <li class="file" data-path="${dirName}/${file.name}">
                                <span>ğŸ“„</span>
                                <a href="/download/${dirName}/${file.name}" title="${file.name}">${file.name}</a>
                                <span class="file-size">${formatFileSize(file.size)}</span>
                            </li>`).join('')}
                    </div>
                </ul>`;
                document.querySelector(`[onclick="toggleDirectory('${dirName}')"]`).insertAdjacentHTML('afterend', html);
                allDirectories[dirName] = { directories: data.directories, files: data.files.map(file => dirName + '/' + file.name) };
                if (callback) callback();
            })
            .catch(error => console.error('Error loading directory:', error));
    }

    function formatFileSize(size) {
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let unitIndex = 0;
        let newSize = size;
        while (newSize >= 1024 && unitIndex < units.length - 1) { newSize /= 1024; unitIndex++; }
        return newSize.toFixed(2) + ' ' + units[unitIndex];
    }

    document.addEventListener('DOMContentLoaded', function () {
        toggleDirectory('recientes');
        toggleDirectory('historico');
    });

    function searchFiles() {
        const searchValue = document.getElementById('search-input').value.toLowerCase().trim();
        if (searchValue === "") { document.getElementById('search-results').style.display = 'none'; return; }

        fetch(`/search?query=${encodeURIComponent(searchValue)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results.length > 0) {
                    document.getElementById('search-results').style.display = 'block';
                    document.getElementById('search-file-grid').innerHTML = data.results.map(file => `
                        <li class="file" data-path="${file.path}">
                            <span>ğŸ“„</span>
                            <a href="/download/${file.path}" title="${file.name}">${file.name}</a>
                            <span class="file-size">${formatFileSize(file.size)}</span>
                        </li>`).join('');
                } else { document.getElementById('search-results').style.display = 'none'; }
            })
            .catch(error => console.error('Error searching files:', error));
    }
</script>
{% endblock %}