{% extends "base.html" %}
{% block title %}Historial de Cambios - {{ hostname }}{% endblock %}

{% block head %}
<style>
    .diff-content {
        font-family: monospace;
        font-size: 12px;
        background: #0d1117;
        color: #d4d4d4;
        white-space: pre-wrap;
    }

    .diff-add {
        color: #4ec9b0;
        background: #1e3a2f;
    }

    .diff-del {
        color: #f48771;
        background: #3a1e1e;
    }

    .diff-header {
        color: #569cd6;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-file-diff"></i> Historial de Cambios: <strong>{{ hostname }}</strong> ({{ vendor }})
    </div>
    <div class="card-body">
        <pre class="diff-content p-3 rounded" id="diff-content"
            style="max-height: 600px; overflow: auto;">Cargando diff...</pre>
    </div>
</div>

<div class="mt-3">
    <a href="/" class="btn btn-secondary">← Volver al Dashboard</a>
</div>
{% endblock %}

{% block scripts %}
<script>
    fetch('/api/diff/{{ vendor }}/{{ hostname }}')
        .then(r => r.json())
        .then(data => {
            var contentEl = document.getElementById('diff-content');
            var content = data.diff || '';
            var error = data.error || '';

            // Distinguish between different states
            if (error) {
                // No backup file found - red alert
                contentEl.innerHTML = '<div class="alert alert-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ' + error + '</div>';
            } else if (!content || content.includes('Sin historial') || content.includes('aún no ha sido versionado')) {
                // File exists but no version history - yellow
                contentEl.innerHTML = '<div class="alert alert-warning mb-0"><i class="bi bi-info-circle"></i> Sin historial de cambios registrados.<br><small class="text-muted">El archivo existe pero aún no tiene versiones para comparar. Se registrarán cambios en el próximo backup.</small></div>';
            } else if (content.trim() === '' || content.includes('identical')) {
                // No changes detected - info blue
                contentEl.innerHTML = '<div class="alert alert-info mb-0"><i class="bi bi-check-circle"></i> Sin cambios detectados desde el último backup.<br><small class="text-muted">La configuración actual es idéntica a la versión anterior.</small></div>';
            } else {
                // Normal diff display with syntax highlighting
                content = content
                    .replace(/^(\+.*)$/gm, '<span class="diff-add">$1</span>')
                    .replace(/^(-.*)$/gm, '<span class="diff-del">$1</span>')
                    .replace(/^(@@.*)$/gm, '<span class="diff-header">$1</span>')
                    .replace(/^(=== Commit:.*)$/gm, '<span class="diff-header">$1</span>')
                    .replace(/^(commit .*)$/gm, '<span class="diff-header">$1</span>');
                contentEl.innerHTML = content;
            }
        })
        .catch(err => {
            document.getElementById('diff-content').innerHTML = '<div class="alert alert-danger">Error al cargar historial: ' + err + '</div>';
        });
</script>
{% endblock %}