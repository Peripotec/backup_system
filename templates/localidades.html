{% extends "base.html" %}
{% block title %}Localidades{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-geo-alt"></i> Localidades</span>
        <button class="btn btn-light btn-sm" onclick="openAddModal()">‚ûï Agregar Localidad</button>
    </div>
    <!-- Toolbar -->
    <div class="d-flex gap-2 align-items-center p-2 bg-light border-bottom">
        <select class="form-select form-select-sm" id="group-by" style="width:auto;" onchange="renderTable()">
            <option value="zona">Agrupar por: Zona (Troncal)</option>
            <option value="">Sin agrupar</option>
        </select>
        <input type="text" class="form-control form-control-sm" id="search-input" placeholder="üîç Buscar localidad..."
            style="max-width:220px;" onkeyup="renderTable()">
        <small class="text-muted ms-auto" id="count-info"></small>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Zona (Troncal)</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="loc-table"></tbody>
        </table>
    </div>
</div>

<div class="alert alert-info mt-3">
    <strong>üí° Tip:</strong> Las localidades organizan dispositivos por ubicaci√≥n geogr√°fica.
    La <strong>Zona</strong> act√∫a como <strong>Troncal</strong> - los dispositivos heredan el troncal de su localidad.
</div>

<!-- Modal -->
<div class="modal fade" id="locModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white" id="modal-header">
                <h5 class="modal-title" id="modal-title">‚ûï Agregar Localidad</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-mode" value="add">
                <input type="hidden" id="original-id" value="">
                <div class="mb-3">
                    <label class="form-label">ID *</label>
                    <input type="text" class="form-control" id="loc-id" placeholder="rafaela" required>
                    <div class="form-text">Identificador √∫nico (min√∫sculas, sin espacios)</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-control" id="loc-name" placeholder="Rafaela" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Zona (Troncal) *</label>
                    <select class="form-select" id="loc-zona"></select>
                    <div class="form-text">Los dispositivos de esta localidad heredar√°n este troncal</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveLoc()">üíæ Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var localidades = [], zonas = [];
    var locModal;

    document.addEventListener('DOMContentLoaded', function () {
        locModal = new bootstrap.Modal(document.getElementById('locModal'));
        loadZonas();
        loadLocs();
    });

    function loadZonas() {
        fetch('/api/zonas').then(r => r.json()).then(data => {
            zonas = data;
            var sel = document.getElementById('loc-zona');
            sel.innerHTML = '<option value="">Sin zona</option>' + data.map(z => '<option value="' + z + '">' + z + '</option>').join('');
        });
    }

    function loadLocs() {
        fetch('/api/localidades').then(r => r.json()).then(data => {
            localidades = data;
            renderTable();
        });
    }

    function renderTable() {
        var tbody = document.getElementById('loc-table');
        var groupBy = document.getElementById('group-by').value;
        var search = document.getElementById('search-input').value.toLowerCase();

        // Filter
        var filtered = localidades.filter(l => {
            if (!search) return true;
            return l.id.toLowerCase().includes(search) ||
                l.name.toLowerCase().includes(search) ||
                (l.zona || '').toLowerCase().includes(search);
        });

        tbody.innerHTML = '';
        document.getElementById('count-info').textContent = filtered.length + ' localidades';

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay localidades que coincidan.</td></tr>';
            return;
        }

        if (groupBy === 'zona') {
            // Group by zona
            var grouped = {};
            filtered.forEach(l => {
                var key = l.zona || 'Sin zona';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(l);
            });

            Object.keys(grouped).sort().forEach(zona => {
                tbody.innerHTML += '<tr class="table-secondary"><td colspan="4"><strong>üîó ' +
                    zona + '</strong> <span class="badge bg-secondary">' + grouped[zona].length + '</span></td></tr>';
                grouped[zona].forEach(l => renderRow(tbody, l));
            });
        } else {
            filtered.forEach(l => renderRow(tbody, l));
        }
    }

    function renderRow(tbody, l) {
        var zonaBadge = l.zona ? '<span class="badge bg-primary">üîó ' + l.zona + '</span>' : '<span class="text-muted">-</span>';
        tbody.innerHTML += '<tr>' +
            '<td><code>' + l.id + '</code></td>' +
            '<td><strong>' + l.name + '</strong></td>' +
            '<td>' + zonaBadge + '</td>' +
            '<td>' +
            '<span class="btn-action" style="cursor:pointer" onclick="openEditModal(\'' + l.id + '\')" title="Editar">‚úèÔ∏è</span> ' +
            '<span class="btn-action" style="cursor:pointer" onclick="deleteLoc(\'' + l.id + '\')" title="Eliminar">üóëÔ∏è</span>' +
            '</td></tr>';
    }

    function openAddModal() {
        document.getElementById('edit-mode').value = 'add';
        document.getElementById('modal-title').textContent = '‚ûï Agregar Localidad';
        document.getElementById('loc-id').value = ''; document.getElementById('loc-id').disabled = false;
        document.getElementById('loc-name').value = '';
        document.getElementById('loc-zona').value = '';
        locModal.show();
    }

    function openEditModal(id) {
        var l = localidades.find(x => x.id === id); if (!l) return;
        document.getElementById('edit-mode').value = 'edit';
        document.getElementById('original-id').value = id;
        document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar Localidad';
        document.getElementById('loc-id').value = id; document.getElementById('loc-id').disabled = true;
        document.getElementById('loc-name').value = l.name;
        document.getElementById('loc-zona').value = l.zona || '';
        locModal.show();
    }

    function saveLoc() {
        var id = document.getElementById('loc-id').value.trim().toLowerCase().replace(/\s+/g, '_');
        var name = document.getElementById('loc-name').value.trim();
        var zona = document.getElementById('loc-zona').value;
        if (!id || !name) { alert('ID y nombre son requeridos'); return; }

        var mode = document.getElementById('edit-mode').value;
        var data = { id: id, name: name, zona: zona };

        if (mode === 'add') {
            fetch('/api/localidades', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : (locModal.hide(), loadLocs()); });
        } else {
            var oid = document.getElementById('original-id').value;
            fetch('/api/localidades/' + oid, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : (locModal.hide(), loadLocs()); });
        }
    }

    function deleteLoc(id) {
        if (!confirm('¬øEliminar localidad "' + id + '"?')) return;
        fetch('/api/localidades/' + id, { method: 'DELETE' }).then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : loadLocs(); });
    }
</script>
{% endblock %}