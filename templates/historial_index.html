{% extends "base.html" %}
{% block title %}Historial de Cambios{% endblock %}

{% block head %}
<style>
    .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .clickable-badge {
        cursor: pointer;
        transition: opacity 0.15s;
    }

    .clickable-badge:hover {
        opacity: 0.8;
    }

    .clickable-ip {
        cursor: pointer;
    }

    .clickable-ip:hover {
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-diff"></i> Historial de Cambios</span>
        <select class="form-select form-select-sm" id="group-by" style="width: auto;">
            <option value="vendor">Agrupar por: Vendor</option>
            <option value="group">Agrupar por: Grupo</option>
            <option value="localidad">Agrupar por: Localidad</option>
            <option value="troncal">Agrupar por: Troncal</option>
            <option value="tipo">Agrupar por: Tipo</option>
            <option value="criticidad">Agrupar por: Criticidad</option>
        </select>
    </div>
    <!-- Filter Bar Container -->
    <div id="filter-bar-container"></div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Dispositivo</th>
                    <th>IP</th>
                    <th>üìç Ubicaci√≥n</th>
                    <th>üîó Troncal</th>
                    <th>Equipo</th>
                    <th>Criticidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="devices-table"></tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <small id="devices-info" class="text-muted">Cargando...</small>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<div class="alert alert-info mt-3">
    <strong>üí° Tip:</strong> El historial muestra los cambios entre versiones de configuraci√≥n. Haz click en un
    dispositivo para ver su diff.
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/filter-bar.js"></script>
<script>
    var filterBar;
    var currentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        initFilterBar();
    });

    function initFilterBar() {
        filterBar = new FilterBar({
            container: '#filter-bar-container',
            filters: [
                { id: 'localidad', label: 'üìç Localidad', type: 'select', options: 'dynamic' },
                { id: 'troncal', label: 'üîó Troncal', type: 'select', options: 'dynamic' },
                { id: 'tipo', label: 'üè∑Ô∏è Tipo', type: 'select', options: 'dynamic' },
                { id: 'vendor', label: 'üè≠ Vendor', type: 'select', options: 'dynamic' },
                { id: 'grupo', label: 'üìÅ Grupo', type: 'select', options: 'dynamic' },
                {
                    id: 'criticidad', label: '‚ö†Ô∏è Criticidad', type: 'select', options: [
                        { value: 'alta', label: 'üî¥ Alta' },
                        { value: 'media', label: 'üü° Media' },
                        { value: 'baja', label: 'üü¢ Baja' }
                    ]
                }
            ],
            searchEnabled: true,
            searchPlaceholder: 'üîç Buscar en todo...',
            onFilter: function (filters) {
                currentPage = 1;
                loadDevices();
            }
        });

        // Load filter options
        fetch('/api/filter-options').then(r => r.json()).then(opts => {
            filterBar.populateFilter('localidad', opts.localidades);
            filterBar.populateFilter('troncal', opts.troncales);
            filterBar.populateFilter('tipo', opts.tipos);
            filterBar.populateFilter('vendor', opts.vendors);
            filterBar.populateFilter('grupo', opts.grupos);
            loadDevices();
        });

        // Group by change
        document.getElementById('group-by').addEventListener('change', function () {
            currentPage = 1;
            loadDevices();
        });
    }

    function loadDevices(page) {
        if (typeof page === 'number') currentPage = page;
        else if (page instanceof Event) currentPage = 1;

        var groupBy = document.getElementById('group-by').value;
        var params = filterBar.buildQueryString({ page: currentPage, per_page: 50, group_by: groupBy });

        fetch('/api/devices?' + params).then(r => r.json()).then(data => {
            renderTable(data);
            renderPagination(data);
            filterBar.updateCount(data.total);
            document.getElementById('devices-info').textContent =
                'Mostrando ' + data.devices.length + ' de ' + data.total + ' (P√°g ' + data.page + '/' + data.pages + ')';
        });
    }

    function renderTable(data) {
        var tbody = document.getElementById('devices-table');
        tbody.innerHTML = '';

        if (data.total === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No se encontraron dispositivos.</td></tr>';
            return;
        }

        // Render grouped
        Object.keys(data.grouped).sort().forEach(key => {
            var devices = data.grouped[key];
            tbody.innerHTML += '<tr class="table-secondary"><td colspan="7"><strong>' +
                key.charAt(0).toUpperCase() + key.slice(1) + '</strong> ' +
                '<span class="badge bg-secondary">' + devices.length + '</span></td></tr>';

            devices.forEach(d => {
                var sysname = d.sysname || d.hostname;
                var nombre = d.nombre || sysname;
                var sysnameSecondary = d.nombre ? '<br><small class="text-muted">' + sysname + '</small>' : '';

                // Status indicator - circle next to action button
                var statusDot = '';
                switch (d.backup_status) {
                    case 'ok':
                        statusDot = '<span class="status-dot bg-success me-2" title="Backup exitoso con cambios"></span>';
                        break;
                    case 'unchanged':
                        statusDot = '<span class="status-dot bg-warning me-2" title="Sin cambios detectados"></span>';
                        break;
                    case 'error':
                        statusDot = '<span class="status-dot bg-danger me-2" title="√öltimo backup fall√≥"></span>';
                        break;
                    default:
                        statusDot = '<span class="status-dot bg-secondary opacity-50 me-2" title="Sin backup a√∫n"></span>';
                }

                // Criticidad - simple text colored
                var critText = '-';
                if (d.criticidad === 'alta') critText = '<span class="text-danger fw-semibold">Alta</span>';
                else if (d.criticidad === 'media') critText = '<span class="text-warning">Media</span>';
                else if (d.criticidad === 'baja') critText = '<span class="text-success">Baja</span>';

                // Location badges WITH emojis (original style)
                var locBadge = d.localidad ?
                    '<span class="badge bg-info clickable-badge" onclick="quickFilter(\'localidad\', \'' + d.localidad + '\')" title="Filtrar">üìç ' + d.localidad + '</span>' :
                    '<span class="text-muted">-</span>';

                var tronBadge = d.troncal ?
                    '<span class="badge bg-primary clickable-badge" onclick="quickFilter(\'troncal\', \'' + d.troncal + '\')" title="Filtrar">üîó ' + d.troncal + '</span>' :
                    '<span class="text-muted">-</span>';

                // Equipo - vendor + tipo WITH emoji
                var vendorBadge = '<span class="badge bg-secondary clickable-badge" onclick="quickFilter(\'vendor\', \'' + d.vendor + '\')" title="Filtrar">üè≠ ' + d.vendor + '</span>';
                var tipoBadge = d.tipo ? '<br><span class="badge bg-light text-dark">' + d.tipo + '</span>' : '';

                tbody.innerHTML += '<tr>' +
                    '<td><a href="/diff/' + d.vendor + '/' + sysname + '" class="text-decoration-none"><strong>' + nombre + '</strong></a>' + sysnameSecondary + '</td>' +
                    '<td><code class="clickable-ip" onclick="copyToClipboard(\'' + d.ip + '\')" title="Click para copiar">' + d.ip + '</code></td>' +
                    '<td>' + locBadge + '</td>' +
                    '<td>' + tronBadge + '</td>' +
                    '<td>' + vendorBadge + tipoBadge + '</td>' +
                    '<td class="text-center">' + critText + '</td>' +
                    '<td class="text-nowrap">' + statusDot + '<a href="/diff/' + d.vendor + '/' + sysname + '" class="btn btn-sm btn-outline-primary" title="Ver historial de cambios"><i class="bi bi-file-diff"></i> Ver Diferencias</a></td>' +
                    '</tr>';
            });
        });
    }

    function quickFilter(field, value) {
        filterBar.setFilter(field, value);
        loadDevices();
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            var el = event.target;
            var original = el.textContent;
            el.textContent = '‚úì Copiado';
            el.classList.add('text-success');
            setTimeout(() => {
                el.textContent = original;
                el.classList.remove('text-success');
            }, 1000);
        });
    }

    function renderPagination(data) {
        var pg = document.getElementById('pagination');
        pg.innerHTML = '';
        if (data.pages <= 1) return;

        if (data.page > 1)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page - 1) + ')">¬´</a></li>';

        for (var i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++)
            pg.innerHTML += '<li class="page-item ' + (i === data.page ? 'active' : '') + '"><a class="page-link" href="#" onclick="loadDevices(' + i + ')">' + i + '</a></li>';

        if (data.page < data.pages)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page + 1) + ')">¬ª</a></li>';
    }
</script>
{% endblock %}