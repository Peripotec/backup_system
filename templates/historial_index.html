{% extends "base.html" %}
{% block title %}Historial de Cambios{% endblock %}

{% block head %}
<style>
    /* Sticky header and filter bar */
    .card-header.sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #filter-bar-container {
        position: sticky;
        top: 52px;
        /* altura del card-header */
        z-index: 9;
        background: #fff;
    }

    .table thead th {
        position: sticky;
        top: 104px;
        /* header + filter bar */
        background: #212529;
        z-index: 5;
    }

    /* Status indicator */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    /* Vendor text instead of badge */
    .vendor-text {
        font-weight: 500;
        text-transform: capitalize;
    }

    /* Criticidad pills */
    .crit-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .crit-alta {
        background: #f8d7da;
        color: #842029;
    }

    .crit-media {
        background: #fff3cd;
        color: #664d03;
    }

    .crit-baja {
        background: #d1e7dd;
        color: #0f5132;
    }

    /* Active filters chips */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        background: #e9ecef;
        border-radius: 12px;
        font-size: 0.8rem;
    }

    .filter-chip .remove {
        cursor: pointer;
        font-weight: bold;
        opacity: 0.6;
    }

    .filter-chip .remove:hover {
        opacity: 1;
    }

    /* Clickables */
    .clickable-badge {
        cursor: pointer;
        transition: opacity 0.15s;
    }

    .clickable-badge:hover {
        opacity: 0.8;
    }

    .clickable-ip {
        cursor: pointer;
    }

    .clickable-ip:hover {
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center sticky-top">
        <span><i class="bi bi-file-diff"></i> Historial de Cambios</span>
        <select class="form-select form-select-sm" id="group-by" style="width: auto;">
            <option value="vendor">Agrupar por: Vendor</option>
            <option value="group">Agrupar por: Grupo</option>
            <option value="localidad">Agrupar por: Localidad</option>
            <option value="troncal">Agrupar por: Troncal</option>
            <option value="tipo">Agrupar por: Tipo</option>
            <option value="criticidad">Agrupar por: Criticidad</option>
        </select>
    </div>
    <!-- Filter Bar Container -->
    <div id="filter-bar-container"></div>
    <!-- Active Filters Chips -->
    <div id="active-filters-container" class="active-filters" style="display:none;"></div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Dispositivo</th>
                    <th>IP</th>
                    <th>üìç Ubicaci√≥n</th>
                    <th>üîó Troncal</th>
                    <th>Equipo</th>
                    <th>Criticidad</th>
                    <th>Acci√≥n / Estado</th>
                </tr>
            </thead>
            <tbody id="devices-table"></tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <small id="devices-info" class="text-muted">Cargando...</small>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<div class="alert alert-info mt-3">
    <strong>üí° Tip:</strong> El historial muestra los cambios entre versiones de configuraci√≥n. Haz click en un
    dispositivo para ver su diff.
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/filter-bar.js"></script>
<script>
    var filterBar;
    var currentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        initFilterBar();
    });

    function initFilterBar() {
        filterBar = new FilterBar({
            container: '#filter-bar-container',
            filters: [
                { id: 'localidad', label: 'üìç Localidad', type: 'select', options: 'dynamic' },
                { id: 'troncal', label: 'üîó Troncal', type: 'select', options: 'dynamic' },
                { id: 'tipo', label: 'üè∑Ô∏è Tipo', type: 'select', options: 'dynamic' },
                { id: 'vendor', label: 'üè≠ Vendor', type: 'select', options: 'dynamic' },
                { id: 'grupo', label: 'üìÅ Grupo', type: 'select', options: 'dynamic' },
                {
                    id: 'criticidad', label: '‚ö†Ô∏è Criticidad', type: 'select', options: [
                        { value: 'alta', label: 'üî¥ Alta' },
                        { value: 'media', label: 'üü° Media' },
                        { value: 'baja', label: 'üü¢ Baja' }
                    ]
                }
            ],
            searchEnabled: true,
            searchPlaceholder: 'üîç Buscar en todo...',
            onFilter: function (filters) {
                currentPage = 1;
                updateActiveFilters(filters);
                loadDevices();
            }
        });

        // Convert API options to FilterBar format {value, label}
        // Handles both strings and objects {id, name}
        function toFilterOptions(arr) {
            return (arr || [])
                .filter(v => v !== undefined && v !== null && v !== 'undefined')
                .map(v => {
                    if (typeof v === 'object' && v !== null) {
                        // Object with id/name from API
                        return { value: v.id || v.value || '', label: v.name || v.label || v.id || '' };
                    }
                    // Simple string
                    const str = String(v).trim();
                    return str ? { value: str, label: str.charAt(0).toUpperCase() + str.slice(1) } : null;
                })
                .filter(v => v !== null && v.value !== '');
        }

        // Load filter options
        fetch('/api/filter-options').then(r => r.json()).then(opts => {
            filterBar.populateFilter('localidad', toFilterOptions(opts.localidades));
            filterBar.populateFilter('troncal', toFilterOptions(opts.troncales));
            filterBar.populateFilter('tipo', toFilterOptions(opts.tipos));
            filterBar.populateFilter('vendor', toFilterOptions(opts.vendors));
            filterBar.populateFilter('grupo', toFilterOptions(opts.grupos));
            loadDevices();
        });

        // Group by change
        document.getElementById('group-by').addEventListener('change', function () {
            currentPage = 1;
            loadDevices();
        });
    }

    // Update active filters chips
    function updateActiveFilters(filters) {
        var container = document.getElementById('active-filters-container');
        var chips = [];
        var labels = {
            localidad: 'üìç Localidad',
            troncal: 'üîó Troncal',
            tipo: 'üè∑Ô∏è Tipo',
            vendor: 'üè≠ Vendor',
            grupo: 'üìÅ Grupo',
            criticidad: '‚ö†Ô∏è Criticidad',
            search: 'üîç B√∫squeda'
        };

        for (var key in filters) {
            if (filters[key] && filters[key] !== '') {
                var label = labels[key] || key;
                chips.push('<span class="filter-chip">' + label + ': <strong>' + filters[key] + '</strong> <span class="remove" onclick="clearFilter(\'' + key + '\')">‚úï</span></span>');
            }
        }

        if (chips.length > 0) {
            container.innerHTML = chips.join('') + ' <span class="filter-chip" style="background:#dc3545;color:#fff;cursor:pointer;" onclick="clearAllFilters()">Limpiar todo ‚úï</span>';
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }
    }

    function clearFilter(key) {
        filterBar.setFilter(key, '');
        loadDevices();
    }

    function clearAllFilters() {
        filterBar.reset();
        loadDevices();
    }

    function loadDevices(page) {
        if (typeof page === 'number') currentPage = page;
        else if (page instanceof Event) currentPage = 1;

        var groupBy = document.getElementById('group-by').value;
        var params = filterBar.buildQueryString({ page: currentPage, per_page: 50, group_by: groupBy });

        fetch('/api/devices?' + params).then(r => r.json()).then(data => {
            renderTable(data);
            renderPagination(data);
            filterBar.updateCount(data.total);
            document.getElementById('devices-info').textContent =
                'Mostrando ' + data.devices.length + ' de ' + data.total + ' (P√°g ' + data.page + '/' + data.pages + ')';
        });
    }

    function renderTable(data) {
        var tbody = document.getElementById('devices-table');
        var html = '';

        if (data.total === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No se encontraron dispositivos.</td></tr>';
            return;
        }

        // Build HTML as a single string for performance
        Object.keys(data.grouped).sort().forEach(key => {
            var devices = data.grouped[key];
            html += '<tr class="table-secondary"><td colspan="7"><strong>' +
                key.charAt(0).toUpperCase() + key.slice(1) + '</strong> ' +
                '<span class="badge bg-secondary">' + devices.length + '</span></td></tr>';

            devices.forEach(d => {
                var sysname = d.sysname || d.hostname;
                var nombre = d.nombre || sysname;
                var sysnameSecondary = d.nombre ? '<br><small class="text-muted">' + sysname + '</small>' : '';

                // Status indicator with icon + text
                var statusIndicator = '';
                switch (d.backup_status) {
                    case 'ok':
                        statusIndicator = '<span class="status-indicator text-success"><span class="status-dot bg-success"></span> Cambios</span>';
                        break;
                    case 'unchanged':
                        statusIndicator = '<span class="status-indicator text-warning"><span class="status-dot bg-warning"></span> Sin cambios</span>';
                        break;
                    case 'error':
                        statusIndicator = '<span class="status-indicator text-danger"><span class="status-dot bg-danger"></span> Error</span>';
                        break;
                    default:
                        statusIndicator = '<span class="status-indicator text-muted"><span class="status-dot bg-secondary opacity-50"></span> Pendiente</span>';
                }

                // Criticidad as soft pill
                var critPill = '-';
                if (d.criticidad === 'alta') critPill = '<span class="crit-pill crit-alta">Alta</span>';
                else if (d.criticidad === 'media') critPill = '<span class="crit-pill crit-media">Media</span>';
                else if (d.criticidad === 'baja') critPill = '<span class="crit-pill crit-baja">Baja</span>';

                // Location badges WITH emojis
                var locBadge = d.localidad ?
                    '<span class="badge bg-info clickable-badge" onclick="quickFilter(\'localidad\', \'' + d.localidad + '\')" title="Filtrar">üìç ' + d.localidad + '</span>' :
                    '<span class="text-muted">-</span>';

                var tronBadge = d.troncal ?
                    '<span class="badge bg-primary clickable-badge" onclick="quickFilter(\'troncal\', \'' + d.troncal + '\')" title="Filtrar">üîó ' + d.troncal + '</span>' :
                    '<span class="text-muted">-</span>';

                // Equipo - vendor as text, tipo as neutral pill
                var vendorText = '<span class="vendor-text clickable-badge" onclick="quickFilter(\'vendor\', \'' + d.vendor + '\')" title="Filtrar por vendor">üè≠ ' + d.vendor + '</span>';
                var tipoPill = d.tipo ? '<br><span class="badge bg-light text-dark">' + d.tipo + '</span>' : '';

                html += '<tr>' +
                    '<td style="padding-left: 24px;"><a href="/diff/' + d.vendor + '/' + sysname + '" class="text-decoration-none"><strong>' + nombre + '</strong></a>' + sysnameSecondary + '</td>' +
                    '<td><code class="clickable-ip" onclick="copyToClipboard(\'' + d.ip + '\', this)" title="Click para copiar">' + d.ip + '</code></td>' +
                    '<td>' + locBadge + '</td>' +
                    '<td>' + tronBadge + '</td>' +
                    '<td>' + vendorText + tipoPill + '</td>' +
                    '<td>' + critPill + '</td>' +
                    '<td class="text-nowrap"><a href="/diff/' + d.vendor + '/' + sysname + '" class="btn btn-sm btn-outline-primary" title="Ver historial"><i class="bi bi-file-diff"></i> Ver</a> ' + statusIndicator + '</td>' +
                    '</tr>';
            });
        });

        tbody.innerHTML = html;
    }

    function quickFilter(field, value) {
        filterBar.setFilter(field, value);
        loadDevices();
    }

    function copyToClipboard(text, el) {
        navigator.clipboard.writeText(text).then(() => {
            var original = el.textContent;
            el.textContent = '‚úì Copiado';
            el.classList.add('text-success');
            setTimeout(() => {
                el.textContent = original;
                el.classList.remove('text-success');
            }, 1000);
        });
    }

    function renderPagination(data) {
        var pg = document.getElementById('pagination');
        pg.innerHTML = '';
        if (data.pages <= 1) return;

        if (data.page > 1)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page - 1) + ')">¬´</a></li>';

        for (var i = Math.max(1, data.page - 2); i <= Math.min(data.pages, data.page + 2); i++)
            pg.innerHTML += '<li class="page-item ' + (i === data.page ? 'active' : '') + '"><a class="page-link" href="#" onclick="loadDevices(' + i + ')">' + i + '</a></li>';

        if (data.page < data.pages)
            pg.innerHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadDevices(' + (data.page + 1) + ')">¬ª</a></li>';
    }
</script>
{% endblock %}