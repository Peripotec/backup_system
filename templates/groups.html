{% extends "base.html" %}
{% block title %}Grupos{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tree-view.css') }}">
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-folder me-2"></i>Grupos de Equipos</span>
        <button class="btn btn-light btn-sm" onclick="openAddGroupModal()">‚ûï Agregar Grupo</button>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-groups"
                type="button" role="tab">üìÅ Grupos Personalizados</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-groups" type="button"
                role="tab">üè∑Ô∏è Grupos Autom√°ticos</button>
        </li>
    </ul>

    <div class="tab-content" id="groupTabsContent">
        <!-- Tab 1: Grupos Personalizados -->
        <div class="tab-pane fade show active" id="custom-groups" role="tabpanel">
            <!-- Toolbar simple -->
            <div class="d-flex gap-2 align-items-center p-2 bg-light border-bottom">
                <input type="text" class="form-control form-control-sm" id="search-input"
                    placeholder="üîç Buscar grupo..." style="max-width:250px;" onkeyup="renderGroups()">
                <small class="text-muted ms-auto" id="count-info"></small>
            </div>
            <div class="p-0">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Nombre</th>
                            <th>Vendor</th>
                            <th>Credenciales</th>
                            <th>Dispositivos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="group-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Grupos Autom√°ticos -->
        <div class="tab-pane fade" id="auto-groups" role="tabpanel">
            <div class="p-3">
                <div class="alert alert-info mb-3 d-flex align-items-center">
                    <i class="bi bi-info-circle me-2"></i>
                    <span>Vista de dispositivos agrupados autom√°ticamente por vendor y modelo.
                        Click en cualquier grupo para expandir y ver dispositivos.</span>
                </div>

                <div class="row">
                    <!-- Por Vendor -->
                    <div class="col-md-6">
                        <div id="auto-groups-vendor"></div>
                    </div>

                    <!-- Por Modelo -->
                    <div class="col-md-6">
                        <div id="auto-groups-model"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- YAML Panel -->
<div class="card">
    <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#yamlPanel"
        style="cursor: pointer;">
        ‚öôÔ∏è Edici√≥n Avanzada (YAML) - Click para expandir
    </div>
    <div class="collapse" id="yamlPanel">
        <div class="card-body">
            <form method="POST" action="/inventory/groups">
                <textarea class="form-control" name="yaml_content" rows="15"
                    style="font-family: monospace; font-size: 11px;">{{ content }}</textarea>
                <button type="submit" class="btn btn-warning mt-2">üíæ Guardar YAML</button>
            </form>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white" id="group-modal-header">
                <h5 class="modal-title" id="group-modal-title">‚ûï Agregar Grupo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="group-edit-mode" value="add">
                <input type="hidden" id="group-original-name" value="">
                <div class="mb-3"><label class="form-label">Nombre *</label><input type="text" class="form-control"
                        id="group-name" required></div>
                <div class="mb-3"><label class="form-label">Vendor</label><select class="form-select" id="group-vendor">
                        <option value="">(Grupo Mixto - vendor por dispositivo)</option>
                    </select></div>
                <hr>
                <h6>üîê Credenciales del Vault</h6>
                <div class="mb-3" id="vault-credentials-container">
                    <div class="text-muted">Cargando...</div>
                </div>
                <div class="form-text"><a href="/admin/vault" target="_blank">‚ûï Agregar credenciales al vault</a></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveGroup()">Guardar Grupo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var inventory = {{ inventory | tojson | safe }};
    var vendors = [], vaultCredentials = [];
    var groupModal;

    document.addEventListener('DOMContentLoaded', function () {
        groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
        loadVendors();
        initFilterBar();
    });

    function initFilterBar() {
        // Simple search - no full FilterBar needed for groups
        renderGroups();
    }

    function loadVendors() {
        fetch('/api/vendors').then(r => r.json()).then(data => {
            vendors = data;
            var sel = document.getElementById('group-vendor');
            sel.innerHTML = '<option value="">(Grupo Mixto - vendor por dispositivo)</option>' + data.map(v => '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>').join('');
        });
    }

    function renderGroups() {
        var tbody = document.getElementById('group-table');
        var search = (document.getElementById('search-input') ? document.getElementById('search-input').value : '').toLowerCase();
        tbody.innerHTML = '';

        if (!inventory.groups || inventory.groups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay grupos. Cree uno para comenzar.</td></tr>';
            document.getElementById('count-info').textContent = '0 grupos';
            return;
        }

        var filtered = inventory.groups.filter(g => {
            if (!search) return true;
            return g.name.toLowerCase().includes(search) ||
                g.vendor.toLowerCase().includes(search);
        });

        document.getElementById('count-info').textContent = filtered.length + ' de ' + inventory.groups.length + ' grupos';

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No se encontraron grupos.</td></tr>';
            return;
        }

        filtered.forEach(g => {
            var dc = g.devices ? g.devices.length : 0;
            var creds = g.credential_ids ? g.credential_ids.join(', ') : '-';
            tbody.innerHTML += '<tr>' +
                '<td><strong>' + g.name + '</strong></td>' +
                '<td><span class="badge bg-primary">' + g.vendor + '</span></td>' +
                '<td><small>' + creds + '</small></td>' +
                '<td><span class="badge bg-secondary">' + dc + '</span></td>' +
                '<td>' +
                '<span class="btn-action" onclick="openEditGroupModal(\'' + g.name + '\')" title="Editar">‚úèÔ∏è</span>' +
                '<span class="btn-action" onclick="deleteGroup(\'' + g.name + '\')" title="Eliminar">üóëÔ∏è</span>' +
                '</td></tr>';
        });
    }

    function loadVaultCredentials() { return fetch('/api/vault').then(r => r.json()).then(data => { vaultCredentials = data; return data; }); }

    function renderVaultCheckboxes(sel) {
        var c = document.getElementById('vault-credentials-container'); sel = sel || [];
        if (vaultCredentials.length === 0) { c.innerHTML = '<div class="text-muted">No hay credenciales. <a href="/admin/vault">Agregar</a></div>'; return; }
        c.innerHTML = vaultCredentials.map(cr => '<div class="form-check"><input class="form-check-input vault-cred-check" type="checkbox" value="' + cr.id + '" id="cred-' + cr.id + '" ' + (sel.indexOf(cr.id) >= 0 ? 'checked' : '') + '><label class="form-check-label" for="cred-' + cr.id + '"><strong>' + cr.name + '</strong> <span class="text-muted">(' + cr.user + ')</span></label></div>').join('');
    }

    function getSelectedCredentialIds() { return Array.from(document.querySelectorAll('.vault-cred-check:checked')).map(c => c.value); }

    function openAddGroupModal() {
        document.getElementById('group-edit-mode').value = 'add';
        document.getElementById('group-modal-title').textContent = '‚ûï Agregar Grupo';
        document.getElementById('group-modal-header').className = 'modal-header bg-success text-white';
        document.getElementById('group-name').value = ''; document.getElementById('group-name').disabled = false;
        loadVaultCredentials().then(() => { renderVaultCheckboxes([]); groupModal.show(); });
    }

    function openEditGroupModal(name) {
        var g = inventory.groups.find(gr => gr.name === name); if (!g) return;
        document.getElementById('group-edit-mode').value = 'edit';
        document.getElementById('group-original-name').value = name;
        document.getElementById('group-modal-title').textContent = '‚úèÔ∏è Editar Grupo';
        document.getElementById('group-modal-header').className = 'modal-header bg-warning text-dark';
        document.getElementById('group-name').value = name; document.getElementById('group-name').disabled = true;
        document.getElementById('group-vendor').value = g.vendor;
        loadVaultCredentials().then(() => { renderVaultCheckboxes(g.credential_ids || []); groupModal.show(); });
    }

    function saveGroup() {
        var name = document.getElementById('group-name').value.trim(), vendor = document.getElementById('group-vendor').value;
        var cids = getSelectedCredentialIds();
        if (!name) { alert('Nombre requerido'); return; }
        if (cids.length === 0) { alert('Seleccione credenciales'); return; }
        var mode = document.getElementById('group-edit-mode').value;
        var data = { name: name, vendor: vendor, credential_ids: cids };
        if (mode === 'add') {
            fetch('/api/inventory/group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        } else {
            var on = document.getElementById('group-original-name').value;
            fetch('/api/inventory/group/' + on, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        }
    }

    function deleteGroup(name) {
        // Fetch dependencies first
        fetch('/api/dependencies/grupo/' + name).then(r => r.json()).then(deps => {
            var depHtml = '';
            var canDelete = deps.count === 0;

            if (deps.count > 0) {
                depHtml = '<div class="alert alert-danger py-2 mb-2"><strong>üö´ No se puede eliminar:</strong>' +
                    '<p class="mb-1">Este grupo tiene ' + deps.count + ' dispositivo(s):</p>' +
                    '<ul class="mb-1 small">';
                deps.dependencies.forEach(d => {
                    depHtml += '<li><code>' + d.sysname + '</code> - ' + d.ip + '</li>';
                });
                if (deps.count > 10) depHtml += '<li>... y ' + (deps.count - 10) + ' m√°s</li>';
                depHtml += '</ul><p class="mb-0 fw-bold">Mu√©velos a otro grupo desde la secci√≥n Dispositivos.</p></div>';
            }

            confirmAction({
                title: canDelete ? 'üóëÔ∏è Eliminar Grupo' : 'üö´ Grupo No Vac√≠o',
                message: '<p>Grupo: <strong>"' + name + '"</strong></p>' + depHtml,
                warning: canDelete ? '‚úì Este grupo est√° vac√≠o y puede eliminarse.' : '‚ö†Ô∏è Debes mover los dispositivos a otro grupo primero.',
                buttonText: canDelete ? 'üóëÔ∏è Eliminar Grupo' : '‚ùå No se puede eliminar',
                buttonClass: canDelete ? 'btn-danger' : 'btn-secondary disabled',
                onConfirm: canDelete ? function () {
                    fetch('/api/inventory/group/' + name, { method: 'DELETE' })
                        .then(r => r.json())
                        .then(d => { d.error ? alert(d.error) : location.reload(); });
                } : function () { }
            });
        });
    }

    // ============================================
    // GRUPOS AUTOM√ÅTICOS - Enterprise TreeView
    // ============================================

    var vendorTree = null;
    var modelTree = null;
    var modelsCatalog = {}; // Cache for model names

    // Vendor friendly names mapping
    var vendorNames = {
        'hp': 'HP',
        'huawei': 'Huawei',
        'zte_olt': 'OLT ZTE',
        'cisco': 'Cisco',
        'mikrotik': 'MikroTik',
        'juniper': 'Juniper',
        'fortinet': 'Fortinet'
    };

    function getVendorFriendlyName(vendorId) {
        if (!vendorId) return 'Sin Vendor';
        var id = vendorId.toLowerCase();
        return vendorNames[id] || vendorId.charAt(0).toUpperCase() + vendorId.slice(1);
    }

    function getModelFriendlyName(modelId) {
        if (!modelId) return 'Sin Modelo';
        // Check catalog cache
        if (modelsCatalog[modelId]) {
            return modelsCatalog[modelId].name || modelId;
        }
        return modelId;
    }

    function loadAutoGroups() {
        // First load models catalog if not cached
        if (Object.keys(modelsCatalog).length === 0) {
            fetch('/api/device_models').then(r => r.json()).then(models => {
                // Build model lookup by ID (models is an array directly)
                (models || []).forEach(m => {
                    modelsCatalog[m.id] = m;
                });
                // Now render with catalog data
                renderAutoGroups();
            }).catch(() => {
                // Fallback: render without catalog
                renderAutoGroups();
            });
        } else {
            renderAutoGroups();
        }
    }

    function renderAutoGroups() {
        // Prepare data structures
        var byVendor = {};
        var byModel = {};

        inventory.groups.forEach(g => {
            var groupVendor = g.vendor || '';
            (g.devices || []).forEach(d => {
                var vendorId = d.vendor || groupVendor || '';
                var modelId = d.modelo || '';

                // Get friendly names
                var vendorName = getVendorFriendlyName(vendorId);
                var modelName = getModelFriendlyName(modelId);

                // Enrich device with group info and friendly names
                var enrichedDevice = Object.assign({}, d, {
                    grupo: g.name,
                    vendor: vendorId,
                    vendorName: vendorName,
                    modelName: modelName
                });

                // Group by vendor (using friendly name as key for display)
                if (!byVendor[vendorName]) byVendor[vendorName] = { id: vendorId, devices: [] };
                byVendor[vendorName].devices.push(enrichedDevice);

                // Group by model (using friendly name as key for display)
                var modelKey = modelName || 'Sin Modelo';
                if (!byModel[modelKey]) byModel[modelKey] = { id: modelId, devices: [] };
                byModel[modelKey].devices.push(enrichedDevice);
            });
        });

        // Transform to TreeView data format
        var vendorData = Object.keys(byVendor).sort().map(name => ({
            name: name,
            icon: 'üè≠',
            children: byVendor[name].devices
        }));

        var modelData = Object.keys(byModel).sort().map(name => ({
            name: name,
            icon: 'üì¶',
            children: byModel[name].devices
        }));

        // Initialize TreeViews if not already done
        if (!vendorTree) {
            vendorTree = new TreeView({
                container: '#auto-groups-vendor',
                sectionTitle: 'Por Vendor',
                sectionIcon: 'üè≠',
                emptyText: 'No hay dispositivos en el inventario',
                onAction: handleTreeAction
            });
        }

        if (!modelTree) {
            modelTree = new TreeView({
                container: '#auto-groups-model',
                sectionTitle: 'Por Modelo',
                sectionIcon: 'üì¶',
                emptyText: 'No hay modelos definidos',
                onAction: handleTreeAction
            });
        }

        // Render with data
        vendorTree.setData(vendorData);
        modelTree.setData(modelData);
    }

    /**
     * Handle TreeView device action
     * @param {string} action - Action type: files, backup, diff
     * @param {Object} device - Device info with sysname and vendor
     */
    function handleTreeAction(action, device) {
        var sysname = device.sysname;
        var vendor = device.vendor || 'unknown';

        switch (action) {
            case 'files':
                window.location.href = '/files/' + encodeURIComponent(vendor) + '/' + encodeURIComponent(sysname);
                break;
            case 'backup':
                // Check if device is disabled
                if (device.enabled === false) {
                    var reason = device.disabled_reason || 'Sin motivo especificado';
                    var disabledBy = device.disabled_by || 'N/A';
                    alert('‚ö†Ô∏è Dispositivo deshabilitado\n\nNo se puede ejecutar backup de "' + sysname + '".\n\nMotivo: ' + reason + '\nDeshabilitado por: ' + disabledBy);
                    return;
                }
                if (confirm('¬øEjecutar backup de ' + sysname + '?')) {
                    // Use existing backup function if available
                    fetch('/api/backup/single', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hostname: sysname })
                    }).then(r => r.json()).then(d => {
                        alert(d.success ? '‚úÖ Backup iniciado' : '‚ùå Error: ' + d.error);
                    });
                }
                break;
            case 'diff':
                window.location.href = '/diff/' + encodeURIComponent(vendor) + '/' + encodeURIComponent(sysname);
                break;
        }
    }

    // Load TreeViews when tab is activated
    document.addEventListener('DOMContentLoaded', function () {
        var autoTab = document.getElementById('auto-tab');
        if (autoTab) {
            autoTab.addEventListener('shown.bs.tab', loadAutoGroups);
        }
    });
</script>
<script src="{{ url_for('static', filename='js/tree-view.js') }}"></script>
{% endblock %}