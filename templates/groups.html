{% extends "base.html" %}
{% block title %}Grupos{% endblock %}

{% block head %}
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-folder"></i> Grupos de Equipos</span>
        <button class="btn btn-light btn-sm" onclick="openAddGroupModal()">‚ûï Agregar Grupo</button>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-groups"
                type="button" role="tab">üìÅ Grupos Personalizados</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-groups" type="button"
                role="tab">üè∑Ô∏è Grupos Autom√°ticos</button>
        </li>
    </ul>

    <div class="tab-content" id="groupTabsContent">
        <!-- Tab 1: Grupos Personalizados -->
        <div class="tab-pane fade show active" id="custom-groups" role="tabpanel">
            <!-- Toolbar simple -->
            <div class="d-flex gap-2 align-items-center p-2 bg-light border-bottom">
                <input type="text" class="form-control form-control-sm" id="search-input"
                    placeholder="üîç Buscar grupo..." style="max-width:250px;" onkeyup="renderGroups()">
                <small class="text-muted ms-auto" id="count-info"></small>
            </div>
            <div class="p-0">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Nombre</th>
                            <th>Vendor</th>
                            <th>Credenciales</th>
                            <th>Dispositivos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="group-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: Grupos Autom√°ticos -->
        <div class="tab-pane fade" id="auto-groups" role="tabpanel">
            <div class="p-3">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Grupos generados autom√°ticamente basados en el inventario.
                    Solo lectura - para organizaci√≥n use Grupos Personalizados.
                </div>

                <!-- Por Vendor -->
                <h6 class="mb-2">üè≠ Por Vendor</h6>
                <div id="auto-groups-vendor" class="mb-4">
                    <div class="text-muted">Cargando...</div>
                </div>

                <!-- Por Modelo -->
                <h6 class="mb-2">üì¶ Por Modelo</h6>
                <div id="auto-groups-model">
                    <div class="text-muted">Cargando...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- YAML Panel -->
<div class="card">
    <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#yamlPanel"
        style="cursor: pointer;">
        ‚öôÔ∏è Edici√≥n Avanzada (YAML) - Click para expandir
    </div>
    <div class="collapse" id="yamlPanel">
        <div class="card-body">
            <form method="POST" action="/inventory/groups">
                <textarea class="form-control" name="yaml_content" rows="15"
                    style="font-family: monospace; font-size: 11px;">{{ content }}</textarea>
                <button type="submit" class="btn btn-warning mt-2">üíæ Guardar YAML</button>
            </form>
        </div>
    </div>
</div>

<!-- Group Modal -->
<div class="modal fade" id="groupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white" id="group-modal-header">
                <h5 class="modal-title" id="group-modal-title">‚ûï Agregar Grupo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="group-edit-mode" value="add">
                <input type="hidden" id="group-original-name" value="">
                <div class="mb-3"><label class="form-label">Nombre *</label><input type="text" class="form-control"
                        id="group-name" required></div>
                <div class="mb-3"><label class="form-label">Vendor</label><select class="form-select" id="group-vendor">
                        <option value="">(Grupo Mixto - vendor por dispositivo)</option>
                    </select></div>
                <hr>
                <h6>üîê Credenciales del Vault</h6>
                <div class="mb-3" id="vault-credentials-container">
                    <div class="text-muted">Cargando...</div>
                </div>
                <div class="form-text"><a href="/admin/vault" target="_blank">‚ûï Agregar credenciales al vault</a></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveGroup()">Guardar Grupo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var inventory = {{ inventory | tojson | safe }};
    var vendors = [], vaultCredentials = [];
    var groupModal;

    document.addEventListener('DOMContentLoaded', function () {
        groupModal = new bootstrap.Modal(document.getElementById('groupModal'));
        loadVendors();
        initFilterBar();
    });

    function initFilterBar() {
        // Simple search - no full FilterBar needed for groups
        renderGroups();
    }

    function loadVendors() {
        fetch('/api/vendors').then(r => r.json()).then(data => {
            vendors = data;
            var sel = document.getElementById('group-vendor');
            sel.innerHTML = '<option value="">(Grupo Mixto - vendor por dispositivo)</option>' + data.map(v => '<option value="' + v + '">' + v.charAt(0).toUpperCase() + v.slice(1) + '</option>').join('');
        });
    }

    function renderGroups() {
        var tbody = document.getElementById('group-table');
        var search = (document.getElementById('search-input') ? document.getElementById('search-input').value : '').toLowerCase();
        tbody.innerHTML = '';

        if (!inventory.groups || inventory.groups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay grupos. Cree uno para comenzar.</td></tr>';
            document.getElementById('count-info').textContent = '0 grupos';
            return;
        }

        var filtered = inventory.groups.filter(g => {
            if (!search) return true;
            return g.name.toLowerCase().includes(search) ||
                g.vendor.toLowerCase().includes(search);
        });

        document.getElementById('count-info').textContent = filtered.length + ' de ' + inventory.groups.length + ' grupos';

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No se encontraron grupos.</td></tr>';
            return;
        }

        filtered.forEach(g => {
            var dc = g.devices ? g.devices.length : 0;
            var creds = g.credential_ids ? g.credential_ids.join(', ') : '-';
            tbody.innerHTML += '<tr>' +
                '<td><strong>' + g.name + '</strong></td>' +
                '<td><span class="badge bg-primary">' + g.vendor + '</span></td>' +
                '<td><small>' + creds + '</small></td>' +
                '<td><span class="badge bg-secondary">' + dc + '</span></td>' +
                '<td>' +
                '<span class="btn-action" onclick="openEditGroupModal(\'' + g.name + '\')" title="Editar">‚úèÔ∏è</span>' +
                '<span class="btn-action" onclick="deleteGroup(\'' + g.name + '\')" title="Eliminar">üóëÔ∏è</span>' +
                '</td></tr>';
        });
    }

    function loadVaultCredentials() { return fetch('/api/vault').then(r => r.json()).then(data => { vaultCredentials = data; return data; }); }

    function renderVaultCheckboxes(sel) {
        var c = document.getElementById('vault-credentials-container'); sel = sel || [];
        if (vaultCredentials.length === 0) { c.innerHTML = '<div class="text-muted">No hay credenciales. <a href="/admin/vault">Agregar</a></div>'; return; }
        c.innerHTML = vaultCredentials.map(cr => '<div class="form-check"><input class="form-check-input vault-cred-check" type="checkbox" value="' + cr.id + '" id="cred-' + cr.id + '" ' + (sel.indexOf(cr.id) >= 0 ? 'checked' : '') + '><label class="form-check-label" for="cred-' + cr.id + '"><strong>' + cr.name + '</strong> <span class="text-muted">(' + cr.user + ')</span></label></div>').join('');
    }

    function getSelectedCredentialIds() { return Array.from(document.querySelectorAll('.vault-cred-check:checked')).map(c => c.value); }

    function openAddGroupModal() {
        document.getElementById('group-edit-mode').value = 'add';
        document.getElementById('group-modal-title').textContent = '‚ûï Agregar Grupo';
        document.getElementById('group-modal-header').className = 'modal-header bg-success text-white';
        document.getElementById('group-name').value = ''; document.getElementById('group-name').disabled = false;
        loadVaultCredentials().then(() => { renderVaultCheckboxes([]); groupModal.show(); });
    }

    function openEditGroupModal(name) {
        var g = inventory.groups.find(gr => gr.name === name); if (!g) return;
        document.getElementById('group-edit-mode').value = 'edit';
        document.getElementById('group-original-name').value = name;
        document.getElementById('group-modal-title').textContent = '‚úèÔ∏è Editar Grupo';
        document.getElementById('group-modal-header').className = 'modal-header bg-warning text-dark';
        document.getElementById('group-name').value = name; document.getElementById('group-name').disabled = true;
        document.getElementById('group-vendor').value = g.vendor;
        loadVaultCredentials().then(() => { renderVaultCheckboxes(g.credential_ids || []); groupModal.show(); });
    }

    function saveGroup() {
        var name = document.getElementById('group-name').value.trim(), vendor = document.getElementById('group-vendor').value;
        var cids = getSelectedCredentialIds();
        if (!name) { alert('Nombre requerido'); return; }
        if (cids.length === 0) { alert('Seleccione credenciales'); return; }
        var mode = document.getElementById('group-edit-mode').value;
        var data = { name: name, vendor: vendor, credential_ids: cids };
        if (mode === 'add') {
            fetch('/api/inventory/group', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        } else {
            var on = document.getElementById('group-original-name').value;
            fetch('/api/inventory/group/' + on, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(r => r.json()).then(resp => { resp.error ? alert(resp.error) : location.reload(); });
        }
    }

    function deleteGroup(name) {
        var g = inventory.groups.find(gr => gr.name === name), dc = g && g.devices ? g.devices.length : 0;
        var msg = '¬øEliminar grupo "' + name + '"?' + (dc > 0 ? '\n\n‚ö†Ô∏è Eliminar√° ' + dc + ' dispositivo(s)!' : '');
        if (!confirm(msg)) return;
        fetch('/api/inventory/group/' + name, { method: 'DELETE' }).then(r => r.json()).then(d => { d.error ? alert(d.error) : location.reload(); });
    }

    // ============================================
    // GRUPOS AUTOM√ÅTICOS
    // ============================================

    function loadAutoGroups() {
        // Agrupar dispositivos por vendor
        var byVendor = {};
        var byModel = {};

        inventory.groups.forEach(g => {
            var groupVendor = g.vendor || '';
            (g.devices || []).forEach(d => {
                var vendor = d.vendor || groupVendor || 'Sin Vendor';
                var model = d.modelo || 'Sin Modelo';

                // Por vendor
                if (!byVendor[vendor]) byVendor[vendor] = [];
                byVendor[vendor].push(d);

                // Por modelo
                if (!byModel[model]) byModel[model] = { devices: [], vendor: vendor };
                byModel[model].devices.push(d);
            });
        });

        renderAutoGroupsVendor(byVendor);
        renderAutoGroupsModel(byModel);
    }

    function renderAutoGroupsVendor(byVendor) {
        var container = document.getElementById('auto-groups-vendor');
        if (!container) return;

        var vendorNames = Object.keys(byVendor).sort();
        if (vendorNames.length === 0) {
            container.innerHTML = '<div class="text-muted">No hay dispositivos en el inventario.</div>';
            return;
        }

        var html = '<div class="d-flex flex-wrap gap-2">';
        vendorNames.forEach(vendor => {
            var count = byVendor[vendor].length;
            var color = getVendorColor(vendor);
            html += '<span class="badge bg-' + color + ' p-2" style="font-size: 0.9em; cursor:pointer;" ' +
                'onclick="showAutoGroupDevices(\'' + vendor + '\', \'vendor\')" title="Click para ver dispositivos">' +
                'üè≠ ' + vendor + ' <span class="badge bg-light text-dark">' + count + '</span></span>';
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function renderAutoGroupsModel(byModel) {
        var container = document.getElementById('auto-groups-model');
        if (!container) return;

        var modelNames = Object.keys(byModel).sort();
        if (modelNames.length === 0) {
            container.innerHTML = '<div class="text-muted">No hay modelos definidos.</div>';
            return;
        }

        var html = '<div class="d-flex flex-wrap gap-2">';
        modelNames.forEach(model => {
            var count = byModel[model].devices.length;
            html += '<span class="badge bg-secondary p-2" style="font-size: 0.85em; cursor:pointer;" ' +
                'onclick="showAutoGroupDevices(\'' + model.replace(/'/g, "\\'") + '\', \'model\')" title="Click para ver dispositivos">' +
                'üì¶ ' + model + ' <span class="badge bg-light text-dark">' + count + '</span></span>';
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function getVendorColor(vendor) {
        var v = vendor.toLowerCase();
        if (v.includes('hp') || v.includes('comware')) return 'primary';
        if (v.includes('huawei')) return 'danger';
        if (v.includes('zte')) return 'warning text-dark';
        if (v.includes('cisco')) return 'info';
        if (v.includes('mikrotik')) return 'dark';
        return 'secondary';
    }

    function showAutoGroupDevices(groupName, type) {
        var devices = [];
        inventory.groups.forEach(g => {
            var groupVendor = g.vendor || '';
            (g.devices || []).forEach(d => {
                if (type === 'vendor') {
                    var vendor = d.vendor || groupVendor || 'Sin Vendor';
                    if (vendor === groupName) devices.push(d);
                } else {
                    var model = d.modelo || 'Sin Modelo';
                    if (model === groupName) devices.push(d);
                }
            });
        });

        var list = devices.map(d => '‚Ä¢ ' + d.sysname + ' (' + (d.ip || d.hostname) + ')').join('\n');
        alert('Dispositivos en ' + (type === 'vendor' ? 'vendor' : 'modelo') + ' "' + groupName + '":\n\n' + list);
    }

    // Cargar grupos autom√°ticos cuando se activa la pesta√±a
    document.addEventListener('DOMContentLoaded', function () {
        var autoTab = document.getElementById('auto-tab');
        if (autoTab) {
            autoTab.addEventListener('shown.bs.tab', loadAutoGroups);
        }
    });
</script>
{% endblock %}