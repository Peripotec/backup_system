{% extends "base.html" %}
{% block title %}Vendor Templates{% endblock %}

{% block head %}
<style>
    .btn-action {
        cursor: pointer;
        margin-right: 5px;
    }

    .steps-table {
        font-size: 0.85rem;
    }

    .steps-table th {
        font-size: 0.75rem;
    }

    .steps-table input,
    .steps-table select {
        font-size: 0.85rem;
    }

    .send-cell {
        display: flex;
        gap: 4px;
    }

    .send-type {
        width: 130px;
        flex-shrink: 0;
    }

    .send-value {
        flex: 1;
        min-width: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-diagram-3"></i> Vendor Templates</span>
        <button class="btn btn-light btn-sm" onclick="openAddModal()">‚ûï Nuevo Template</button>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover table-striped mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Protocolo</th>
                    <th>Pasos</th>
                    <th>Descripci√≥n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="templates-table"></tbody>
        </table>
    </div>
</div>

<div class="alert alert-info mt-3">
    <strong>üí° Tip:</strong> Los templates definen la secuencia de comandos para hacer backup.
    Las credenciales se toman del <strong>Vault</strong> autom√°ticamente.
</div>

<!-- Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modal-title">‚ûï Nuevo Template</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="template-id" value="">

                <div class="row mb-3">
                    <div class="col-md-5">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="template-name" placeholder="hp_1920">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Protocolo</label>
                        <select class="form-select" id="template-protocol">
                            <option value="telnet">Telnet</option>
                            <option value="ssh">SSH</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Puerto</label>
                        <input type="number" class="form-control" id="template-port" value="23">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Timeout</label>
                        <input type="number" class="form-control" id="template-timeout" value="60">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-control" id="template-description"
                        placeholder="HP 1920 Series - Telnet + TFTP">
                </div>

                <hr>
                <h6>Secuencia de Comandos</h6>
                <table class="table table-sm steps-table">
                    <thead class="table-secondary">
                        <tr>
                            <th style="width:30px">#</th>
                            <th style="width:20%">Esperar (Expect)</th>
                            <th>Enviar (Send)</th>
                            <th style="width:50px">Ocultar</th>
                            <th style="width:70px">Timeout</th>
                            <th style="width:40px"></th>
                        </tr>
                    </thead>
                    <tbody id="steps-body"></tbody>
                </table>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addStep()">
                    ‚ûï Agregar Paso
                </button>

                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Archivo Resultado</label>
                        <select class="form-select" id="template-filename">
                            <option value="{{ hostname }}.cfg">{{ hostname }}.cfg</option>
                            <option value="{{ hostname }}.zip">{{ hostname }}.zip</option>
                            <option value="{{ hostname }}.rsc">{{ hostname }}.rsc</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Archivo</label>
                        <div class="form-check form-check-inline mt-2">
                            <input class="form-check-input" type="radio" name="is_text" id="is_text_1" value="1"
                                checked>
                            <label class="form-check-label" for="is_text_1">Texto (Git)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="is_text" id="is_text_0" value="0">
                            <label class="form-check-label" for="is_text_0">Binario</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveTemplate()">üíæ Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var templates = [];
    var templateModal;
    var stepCounter = 0;

    // Tipos de valor para el dropdown Send
    const VALUE_TYPES = [
        { value: 'text', label: 'Texto', icon: 'üìù' },
        { value: 'user', label: 'Usuario (Vault)', icon: 'üîë', variable: '{{ user }}' },
        { value: 'password', label: 'Contrase√±a (Vault)', icon: 'üîí', variable: '{{ password }}' },
        { value: 'extra_pass', label: 'Extra Pass (Vault)', icon: 'üîê', variable: '{{ extra_pass }}' },
        { value: 'hostname', label: 'Hostname', icon: 'üíª', variable: '{{ hostname }}' },
        { value: 'ip', label: 'IP', icon: 'üåê', variable: '{{ ip }}' },
        { value: 'tftp_server', label: 'TFTP Server', icon: 'üì°', variable: '{{ tftp_server }}' },
    ];

    document.addEventListener('DOMContentLoaded', function () {
        templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
        loadTemplates();
    });

    function loadTemplates() {
        fetch('/api/vendor-templates')
            .then(r => r.json())
            .then(data => {
                templates = data;
                renderTable();
            });
    }

    function renderTable() {
        var tbody = document.getElementById('templates-table');
        if (!templates || templates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay templates.</td></tr>';
            return;
        }
        tbody.innerHTML = templates.map(t => `
        <tr>
            <td><strong>${escapeHtml(t.name)}</strong></td>
            <td><span class="badge bg-${t.protocol === 'ssh' ? 'primary' : 'success'}">${t.protocol}:${t.port}</span></td>
            <td>${t.steps ? t.steps.length : 0} pasos</td>
            <td class="text-muted">${escapeHtml(t.description) || '-'}</td>
            <td>
                <span class="btn-action" onclick="openEditModal(${t.id})">‚úèÔ∏è</span>
                <span class="btn-action" onclick="deleteTemplate(${t.id}, '${escapeHtml(t.name)}')">üóëÔ∏è</span>
            </td>
        </tr>
    `).join('');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openAddModal() {
        document.getElementById('modal-title').textContent = '‚ûï Nuevo Template';
        document.getElementById('template-id').value = '';
        document.getElementById('template-name').value = '';
        document.getElementById('template-description').value = '';
        document.getElementById('template-protocol').value = 'telnet';
        document.getElementById('template-port').value = 23;
        document.getElementById('template-timeout').value = 60;
        document.getElementById('template-filename').value = '{{ hostname }}.cfg';
        document.getElementById('is_text_1').checked = true;

        document.getElementById('steps-body').innerHTML = '';
        stepCounter = 0;

        // Pasos default para login t√≠pico
        addStep('Username:', 'user', '', false, 10);
        addStep('Password:', 'password', '', true, 10);
        addStep('>', 'text', '', false, 10);

        templateModal.show();
    }

    function openEditModal(id) {
        var t = templates.find(x => x.id === id);
        if (!t) return;

        document.getElementById('modal-title').textContent = '‚úèÔ∏è Editar: ' + t.name;
        document.getElementById('template-id').value = t.id;
        document.getElementById('template-name').value = t.name;
        document.getElementById('template-description').value = t.description || '';
        document.getElementById('template-protocol').value = t.protocol || 'telnet';
        document.getElementById('template-port').value = t.port || 23;
        document.getElementById('template-timeout').value = t.timeout || 60;
        document.getElementById('template-filename').value = t.result_filename || '{{ hostname }}.cfg';
        document.getElementById(t.is_text ? 'is_text_1' : 'is_text_0').checked = true;

        document.getElementById('steps-body').innerHTML = '';
        stepCounter = 0;

        if (t.steps && t.steps.length > 0) {
            t.steps.forEach(s => {
                var { type, value } = parseStepSend(s.send || '');
                addStep(s.expect || '', type, value, s.hide || false, s.timeout || 10);
            });
        }

        templateModal.show();
    }

    function parseStepSend(sendValue) {
        for (var vt of VALUE_TYPES) {
            if (vt.variable && sendValue === vt.variable) {
                return { type: vt.value, value: '' };
            }
        }
        return { type: 'text', value: sendValue };
    }

    function addStep(expect = '', sendType = 'text', sendValue = '', hide = false, timeout = 10) {
        stepCounter++;
        var row = document.createElement('tr');
        row.id = 'step-' + stepCounter;

        var typeOpts = VALUE_TYPES.map(vt =>
            `<option value="${vt.value}" ${sendType === vt.value ? 'selected' : ''}>${vt.icon} ${vt.label}</option>`
        ).join('');

        var isText = sendType === 'text';

        row.innerHTML = `
        <td>${stepCounter}</td>
        <td><input type="text" class="form-control form-control-sm step-expect" value="${escapeHtml(expect)}"></td>
        <td>
            <div class="send-cell">
                <select class="form-select form-select-sm send-type" onchange="onTypeChange(${stepCounter})">${typeOpts}</select>
                <input type="text" class="form-control form-control-sm send-value" value="${escapeHtml(sendValue)}" ${!isText ? 'disabled' : ''}>
            </div>
        </td>
        <td class="text-center"><input type="checkbox" class="form-check-input step-hide" ${hide ? 'checked' : ''}></td>
        <td><input type="number" class="form-control form-control-sm step-timeout" value="${timeout}" style="width:60px"></td>
        <td><span class="btn-action text-danger" onclick="removeStep(${stepCounter})">‚úñ</span></td>
    `;
        document.getElementById('steps-body').appendChild(row);
    }

    function onTypeChange(n) {
        var row = document.getElementById('step-' + n);
        var type = row.querySelector('.send-type').value;
        var input = row.querySelector('.send-value');
        var hideChk = row.querySelector('.step-hide');

        input.disabled = (type !== 'text');
        if (type !== 'text') input.value = '';

        // Auto-check hide para passwords
        if (type === 'password' || type === 'extra_pass') {
            hideChk.checked = true;
        }
    }

    function removeStep(n) {
        var row = document.getElementById('step-' + n);
        if (row) row.remove();
        renumberSteps();
    }

    function renumberSteps() {
        var rows = document.querySelectorAll('#steps-body tr');
        rows.forEach((r, i) => r.cells[0].textContent = i + 1);
    }

    function collectSteps() {
        var rows = document.querySelectorAll('#steps-body tr');
        var steps = [];
        rows.forEach(r => {
            var expect = r.querySelector('.step-expect').value.trim();
            var sendType = r.querySelector('.send-type').value;
            var sendValue = r.querySelector('.send-value').value.trim();
            var hide = r.querySelector('.step-hide').checked;
            var timeout = parseInt(r.querySelector('.step-timeout').value) || 10;

            var send = sendValue;
            if (sendType !== 'text') {
                var vt = VALUE_TYPES.find(v => v.value === sendType);
                send = vt ? vt.variable : sendValue;
            }

            if (expect || send) {
                steps.push({ expect, send, hide, timeout });
            }
        });
        return steps;
    }

    function saveTemplate() {
        var id = document.getElementById('template-id').value;
        var data = {
            name: document.getElementById('template-name').value.trim(),
            description: document.getElementById('template-description').value.trim(),
            protocol: document.getElementById('template-protocol').value,
            port: parseInt(document.getElementById('template-port').value) || 23,
            steps: collectSteps(),
            result_filename: document.getElementById('template-filename').value,
            is_text: document.querySelector('input[name="is_text"]:checked').value === '1',
            timeout: parseInt(document.getElementById('template-timeout').value) || 60
        };

        if (!data.name) { alert('El nombre es requerido'); return; }

        var method = id ? 'PUT' : 'POST';
        var url = id ? `/api/vendor-templates/${id}` : '/api/vendor-templates';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(res => {
                if (res.error) { alert('Error: ' + res.error); }
                else { templateModal.hide(); loadTemplates(); }
            });
    }

    function deleteTemplate(id, name) {
        if (!confirm('¬øEliminar template "' + name + '"?')) return;
        fetch('/api/vendor-templates/' + id, { method: 'DELETE' })
            .then(r => r.json())
            .then(res => { if (res.error) alert(res.error); else loadTemplates(); });
    }
</script>
{% endblock %}