# =============================================================================
# Nginx Configuration - Backup Manager
# =============================================================================
# Archivo: /etc/nginx/sites-available/backup_manager
# Dominio: backupmanager.testwilnet.com.ar
#
# DISEÑO:
# - HTTP (80): Health + ACME sin redirect, resto redirige a HTTPS
# - HTTPS (443): Operación normal con TLS
#
# SEGURIDAD:
# - /api/health expuesto por HTTP es SEGURO porque:
#   - No expone datos sensibles (solo status)
#   - Necesario para monitoreo externo (Zabbix, Prometheus)
#   - Permite diagnóstico cuando TLS está roto
# - /.well-known/acme-challenge/ es REQUERIDO por HTTP para ACME
# =============================================================================

upstream backup_manager_app {
    # Socket UNIX - path absoluto
    server unix:/opt/backup_system/backup_manager.sock fail_timeout=0;
}

# -----------------------------------------------------------------------------
# HTTP Server (Puerto 80)
# -----------------------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;
    server_name backupmanager.testwilnet.com.ar;

    # Logging
    access_log /var/log/nginx/backup_manager_access.log;
    error_log /var/log/nginx/backup_manager_error.log;

    # =========================================================================
    # ACME Challenge - REQUERIDO para Certbot
    # =========================================================================
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        try_files $uri =404;
    }

    # =========================================================================
    # Health Check - SIEMPRE accesible por HTTP
    # NO requiere TLS válido - crítico para monitoreo NOC
    # =========================================================================
    location = /api/health {
        proxy_pass http://backup_manager_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts cortos para health checks
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
    }

    # También con trailing slash (evitar 301 interno)
    location = /api/health/ {
        proxy_pass http://backup_manager_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 5s;
        proxy_read_timeout 10s;
    }

    # =========================================================================
    # Resto de rutas: Redirect a HTTPS
    # =========================================================================
    location / {
        return 301 https://$host$request_uri;
    }
}

# -----------------------------------------------------------------------------
# HTTPS Server (Puerto 443)
# -----------------------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name backupmanager.testwilnet.com.ar;

    # =========================================================================
    # TLS Configuration
    # =========================================================================
    ssl_certificate /etc/letsencrypt/live/backupmanager.testwilnet.com.ar/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/backupmanager.testwilnet.com.ar/privkey.pem;
    
    # Incluir parámetros SSL recomendados (si existe)
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # Configuración TLS moderna
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    
    # HSTS (opcional, comentar si causa problemas)
    # add_header Strict-Transport-Security "max-age=31536000" always;

    # Logging
    access_log /var/log/nginx/backup_manager_ssl_access.log;
    error_log /var/log/nginx/backup_manager_ssl_error.log;

    # =========================================================================
    # Application Proxy
    # =========================================================================
    location / {
        proxy_pass http://backup_manager_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        
        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # Static files (si aplica)
    location /static/ {
        alias /var/www/backup_manager/static/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
}
